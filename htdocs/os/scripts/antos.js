(function(){"use strict";var t,e,n,i,o,a,s,u,c,l,p,h,f,g,m,y,v,_,b,S,w,F,k,O,A,x,P,I,V,D,T,H,C,q,M=function(t,e){for(var n in e)U.call(e,n)&&(t[n]=e[n]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},U={}.hasOwnProperty;(q=this).OS||(q.OS={API:{},GUI:{},APP:{},setting:{user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},courrier:{observable:riot.observable(),quota:0,listeners:{},on:function(t,e,n){return C.listeners[n.pid]||(C.listeners[n.pid]=[]),C.listeners[n.pid].push({e:t,f:e}),C.observable.on(t,e)},trigger:function(t,e){return C.observable.trigger(t,e)},osfail:function(t,e,n){return C.ostrigger("fail",{m:t,e:e,s:n})},oserror:function(t,e,n){return C.ostrigger("error",{m:t,e:e,s:n})},osinfo:function(t){return C.ostrigger("info",{m:t,e:null,s:null})},ostrigger:function(t,e){return C.trigger(t,{id:0,data:e,name:"OS"})},unregister:function(t){var e,n,r,i;if(C.listeners[t.pid]&&C.listeners[t.pid].length>0){for(n=0,r=(i=C.listeners[t.pid]).length;n<r;n++)e=i[n],C.observable.off(e.e,e.f);return delete C.listeners[t.pid]}},getMID:function(){return C.quota+=1,C.quota}},register:function(t,e){return 3===e.type?q.OS.GUI.subwindows[t]=e:D.APP[t]=e},PM:{pidalloc:0,processes:{},createProcess:function(t,e,n){var r,i,o;return r=function(){var r;if(e.singleton&&T.processes[t]&&1===T.processes[t].length?T.processes[t][0].show():(T.processes[t]||(T.processes[t]=[]),(r=new e(n)).birth=(new Date).getTime(),T.pidalloc++,r.pid=T.pidalloc,T.processes[t].push(r),1===e.type?I.dock(r,e.meta):I.attachservice(r)),2===e.type)return C.trigger("srvroutineready",t)},e.dependencies?(i=function(){var t,n,r,i;for(i=[],t=0,n=(r=e.dependencies).length;t<n;t++)o=r[t],i.push(o);return i}(),P.requires(i,r)):r()},appByPid:function(t){var e,n,r,i;for(r in e=void 0,n=function(e){var n,r,i;for(r=0,i=e.length;r<i;r++)if((n=e[r]).pid===t)return n},i=T.processes)if(e=n(i[r]))break;return e},kill:function(t){var e;if(t.name&&T.processes[t.name])return(e=T.processes[t.name].indexOf(t))>=0?(1===D.APP[t.name].type?I.undock(t):I.detachservice(t),C.unregister(t),delete T.processes[t.name][e],T.processes[t.name].splice(e,1)):void 0},killAll:function(t,e){var n,r,i,o,a;if(T.processes[t]){for(a=[],r=0,i=(o=T.processes[t]).length;r<i;r++)n=o[r],a.push(n.quit(e));return a}}},cleanup:function(){var t,e;for(t in console.log("Clean up system"),e=T.processes)e[t],T.killAll(t,!0);return C.observable&&C.observable.off("*"),$(window).off("keydown"),$("#workspace").off("mouseover"),delete C.observable,$("#wrapper").empty(),I.clearTheme(),C.observable=riot.observable(),C.quota=0,D.APP={},D.setting={user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},T.processes={},T.pidalloc=0},boot:function(){return console.log("Booting sytem"),P.handler.auth(function(t){return t.error?I.login():I.startAntOS(t.result)})},cleanupHandlers:{},exit:function(){var t,e;for(t in e=D.cleanupHandlers)(0,e[t])();return P.handler.setting(function(t){return D.cleanup(),P.handler.logout()})},onexit:function(t,e){if(!q.OS.cleanupHandlers[t])return q.OS.cleanupHandlers[t]=e}}),m=function(){function t(t,e){var n,r,i;if(this.fs=t,this.values=[],e)for(n=r=0,i=e.length-1;0<=i?r<=i:r>=i;n=0<=i?++r:--r)this.values[n]=e[n]}return t.prototype.toString=function(){return this.__()},t.prototype.__=function(){var t;return t=this,this.fs.l().replace(/{(\d+)}/g,function(e,n){return void 0!==t.values[n]?t.values[n].__():e})},t.prototype.hash=function(){return this.__().hash()},t.prototype.asBase64=function(){return this.__().asBase64()},t.prototype.unescape=function(){return this.__().unescape()},t.prototype.asUint8Array=function(){return this.__().asUint8Array()},t.prototype.format=function(){var t,e,n,r,i;for(i=[],e=n=0,r=(t=arguments).length-1;0<=r?n<=r:n>=r;e=0<=r?++n:--n)i.push(this.values[e]=t[e]);return i},t}(),A=function(){function t(t){var e,n,r;if(this.string=t,e=this.string.split("-"),n={r:3,b:2,a:1},this.branch=3,2===e.length&&n[e[1]]&&(this.branch=n[e[1]]),!(r=e[0].match(/\d+/g)))throw new Error(__("Version string is in invalid format: {0}",this.string));this.major=0,this.minor=0,this.patch=0,r.length>=1&&(this.major=Number(r[0])),r.length>=2&&(this.minor=Number(r[1])),r.length>=3&&(this.patch=Number(r[2]))}return t.prototype.compare=function(t){var e;return e=t.__v(),this.branch>e.branch?1:this.branch<e.branch?-1:this.major===e.major&&this.minor===e.minor&&this.patch===e.patch?0:this.major>e.major?1:this.major<e.major?-1:this.minor>e.minor?1:this.minor<e.minor?-1:this.patch>e.patch?1:-1},t.prototype.nt=function(t){return 1===this.compare(t)},t.prototype.ot=function(t){return-1===this.compare(t)},t.prototype.__v=function(){return this},t.prototype.toString=function(){return this.string},t}(),Object.defineProperty(Object.prototype,"__",{value:function(){return this.toString()},enumerable:!1,writable:!0}),String.prototype.hash=function(){var t,e;for(t=5381,e=this.length;e;)t=33*t^this.charCodeAt(--e);return t>>>0},String.prototype.__v=function(){return new A(this)},String.prototype.asBase64=function(){var t;return t=encodeURIComponent(this),btoa(t.replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}))},String.prototype.unescape=function(){return this.replace(/\\\\/g,"\\").replace(/\\"/g,'"').replace(/\\n/g,"\n").replace(/\\t/g,"\t").replace(/\\b/g,"\b").replace(/\\f/g,"\f").replace(/\\r/g,"\r")},String.prototype.asUint8Array=function(){var t,e,n,r;for(t=[],e=n=0,r=this.length-1;0<=r?n<=r:n>=r;e=0<=r?++n:--n)t.push(this.charCodeAt(e));return t=new Uint8Array(t)},String.prototype.format||(String.prototype.format=function(){var t;return t=arguments,this.replace(/{(\d+)}/g,function(e,n){return void 0!==t[n]?t[n].__():e})}),String.prototype.f=function(){return new m(this,arguments)},String.prototype.__=function(){var t;return(t=this.match(/^__\((.*)\)$/))?t[1].l():this},String.prototype.l=function(){var t;return(t=window.OS.API).lang[this]||(t.lang[this]=this),t.lang[this]},this.__=function(){var t,e,n;return window.OS.API,(t=arguments).length>0?((e=t[0]).l(),new m(e,function(){var e,r,i;for(i=[],n=e=1,r=t.length-1;1<=r?e<=r:e>=r;n=1<=r?++e:--e)i.push(t[n]);return i}())):"Undefined"},Date.prototype.toString=function(){var t,e,n,r,i,o;return t=this.getDate(),r=this.getMonth()+1,o=this.getFullYear(),t<10&&(t="0"+t),r<10&&(r="0"+r),(e=this.getHours())<10&&(e="0"+e),(n=this.getMinutes())<10&&(n="0"+n),(i=this.getSeconds())<10&&(i="0"+i),t+"/"+r+"/"+o+" "+e+":"+n+":"+i},Date.prototype.timestamp=function(){return this.getTime()/1e3|0},q.OS.API={handler:{},shared:{},searchHandler:{},lang:{},mid:function(){return C.getMID()},post:function(t,e,n,r){var i;return i=C.getMID(),P.loading(i,t),$.ajax({type:"POST",url:t,contentType:"application/json",data:JSON.stringify(e,{dataType:"json",success:null})}).done(function(e){return P.loaded(i,t,"OK"),n(e)}).fail(function(e,n){return P.loaded(i,t,"FAIL"),r(e,n)})},blob:function(t,e,n){var r,i;return r=C.getMID(),(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(i){return 200===this.status&&4===this.readyState?(e(this.response),P.loaded(r,t,"OK")):(n(i,this),P.loaded(r,t,"FAIL"))},P.loading(r,t),i.send()},upload:function(t,e,n,r){var i,o;return o=C.getMID(),(i=$("<input>").attr("type","file").css("display","none")).change(function(){var a;return P.loading(o,t),(a=new FormData).append("path",e),a.append("upload",i[0].files[0]),$.ajax({url:t,data:a,type:"POST",contentType:!1,processData:!1}).done(function(e){return P.loaded(o,t,"OK"),n(e),i.remove()}).fail(function(e,n){return P.loaded(o,t,"FAIL"),r(e,n),i.remove()})}),i.click()},saveblob:function(t,e){var n,r;return r=window.URL.createObjectURL(e),(n=$("<a>").attr("href",r).attr("download",t).css("display","none").appendTo("body"))[0].click(),window.URL.revokeObjectURL(r),n.remove()},systemConfig:function(){return P.request("config",function(t){return console.log(t)})},loading:function(t,e){return C.trigger("loading",{id:t,data:{m:""+e,s:!0},name:"OS"})},loaded:function(t,e,n){return C.trigger("loaded",{id:t,data:{m:n+": "+e,s:!1},name:"OS"})},get:function(t,e,n,r){var i,o;return i={type:"GET",url:t},r&&(i.dataType=r),o=C.getMID(),P.loading(o,t),$.ajax(i).done(function(n){return P.loaded(o,t,"OK"),e(n)}).fail(function(e,r){return P.loaded(o,t,"FAIL"),n(e,r)})},script:function(t,e,n){var r;return r=C.getMID(),P.loading(r,t),$.getScript(t).done(function(n){return P.loaded(r,t,"OK"),e(n)}).fail(function(e,i){return P.loaded(r,t,"FAIL"),n(e,i)})},resource:function(t,e,n){var r;return r="resources/"+t,P.get(r,e,n)},libready:function(t){return P.shared[t]||!1},require:function(t,e){var n,i;return P.shared[t]?(console.log(t,"Library exist, no need to load"),e&&e(),C.trigger("sharedlibraryloaded",t)):t.match(/^(https?:\/\/[^\s]+)/g)?P.script(t,function(){if(P.shared[t]=!0,C.trigger("sharedlibraryloaded",t),e)return e()},function(e,n){return C.oserror(__("Cannot load 3rd library at: {0}",t),e,r)}):(n=""+(i="os://scripts/")+t+".js").asFileHandler().onready(function(r){var o;if(P.shared[t]=!0,$("<script>",{src:P.handler.get+"/"+n}).appendTo("head"),(o=""+i+t+".css").asFileHandler().onready(function(t){return $("<link>",{rel:"stylesheet",type:"text/css",href:P.handler.get+"/"+o}).appendTo("head")},function(){}),console.log("loaded",t),C.trigger("sharedlibraryloaded",t),e)return e()})},requires:function(t,e){return t.length>0?(C.observable.one("sharedlibraryloaded",function(n){return t.splice(0,1),P.requires(t,e)}),P.require(t[0],null)):e()},packages:{fetch:function(t){var e,n;return P.handler.packages({command:"list",args:{paths:function(){var t,r;for(e in r=[],t=D.setting.system.pkgpaths)n=t[e],r.push(n);return r}()}},t)},cache:function(t){var e,n;return P.handler.packages({command:"cache",args:{paths:function(){var t,r;for(e in r=[],t=D.setting.system.pkgpaths)n=t[e],r.push(n);return r}()}},t)}},setting:function(t){return P.handler.setting(t)},apigateway:function(t,e,n){return P.handler.apigateway(t,e,n)},search:function(t){var e,n,r,i;for(e in n=[],r=P.searchHandler)r[e],(i=P.searchHandler[e](t)).length>0&&(i.unshift({text:e,class:"search-header",dataid:"header"}),n=n.concat(i));return n},onsearch:function(t,e){if(!q.OS.API.searchHandler[t])return q.OS.API.searchHandler[t]=e},setLocale:function(t,e){var n;return n="resources/languages/"+t+".json",P.get(n,function(n){return D.setting.system.locale=t,P.lang=n,e?e():C.trigger("systemlocalechange",t)},function(t,r){if(C.oserror(__("Language file {0} not found",n),t,r),e)return e()},"json")},throwe:function(t){var e;e=void 0;try{throw new Error(t)}catch(t){e=t}return e||""},switcher:function(){var t,e,n,r,i,o,a,s;for(i={},o={},e=n=0,a=arguments.length-1;0<=a?n<=a:n>=a;e=0<=a?++n:--n)o[arguments[e]]=!1;for(r in Object.defineProperty(i,"__p",{enumerable:!1,value:o}),t=function(t,e){return Object.defineProperty(t,e,{enumerable:!0,set:function(n){var r,i;for(r in i=this.__p)i[r],this.__p[r]=!1;return t.__p[e]=n},get:function(){return t.__p[e]}})},s=i.__p)s[r],t(i,r);return Object.defineProperty(i,"selected",{configurable:!0,enumerable:!1,get:function(){var t;for(r in t=i.__p)if(t[r])return r}}),i}},q.OS.systemSetting=function(t){return t.desktop&&(D.setting.desktop=t.desktop),t.applications&&(D.setting.applications=t.applications),t.appearance&&(D.setting.appearance=t.appearance),D.setting.appearance.wp||(D.setting.appearance.wp={url:"os://resources/themes/system/wp/wp2.jpg",size:"cover",repeat:"repeat"}),D.setting.appearance.wps||(D.setting.appearance.wps=[]),D.setting.applications||(D.setting.applications={}),D.setting.user=t.user,t.VFS&&(D.setting.VFS=t.VFS),D.setting.desktop.path||(D.setting.desktop.path="home://.desktop"),D.setting.desktop.menu||(D.setting.desktop.menu={}),D.setting.VFS.mountpoints||(D.setting.VFS.mountpoints=[{text:"__(Applications)",path:"app://",iconclass:"fa  fa-adn",type:"app"},{text:"__(Home)",path:"home://",iconclass:"fa fa-home",type:"fs"},{text:"__(Desktop)",path:D.setting.desktop.path,iconclass:"fa fa-desktop",type:"fs"},{text:"__(OS)",path:"os://",iconclass:"fa fa-inbox",type:"fs"},{text:"__(Google Drive)",path:"gdv://",iconclass:"fa fa-inbox",type:"fs"},{text:"__(Shared)",path:"shared://",iconclass:"fa fa-share-square",type:"fs"}]),t.system&&(D.setting.system=t.system),D.setting.system.startup||(D.setting.system.startup={services:["CoreServices/PushNotification","CoreServices/UserService","CoreServices/Calendar","CoreServices/Spotlight"],apps:[]}),D.setting.system.pkgpaths||(D.setting.system.pkgpaths={user:"home://.packages",system:"os://packages"}),D.setting.system.locale||(D.setting.system.locale="en_GB"),D.setting.system.menu||(D.setting.system.menu={}),D.setting.system.repositories||(D.setting.system.repositories=[]),D.setting.appearance.theme||(D.setting.appearance.theme="antos"),D.setting.VFS.gdrive||(D.setting.VFS.gdrive={CLIENT_ID:"",API_KEY:"",apilink:"https://apis.google.com/js/api.js",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES:"https://www.googleapis.com/auth/drive"}),P.onsearch("__(Applications)",function(t){var e,n,r,i,o,a,s,u,c,l,p,h;for(i in e=[],l=new RegExp(t,"i"),u=D.setting.system.packages)if((p=u[i]).app)if(p.name.match(l)||p.description&&p.description.match(l)){for(o in h={},p)n=p[o],"selected"!==o&&(h[o]=n);h.detail=[{text:h.path}],h.complex=!0,e.push(h)}else if(p.mimes)for(r=0,a=(c=p.mimes).length;r<a;r++)if(s=c[r],t.match(new RegExp(s,"g"))){for(o in h={},p)n=p[o],"selected"!==o&&(h[o]=p[o]);h.detail=[{text:h.path}],h.complex=!0,e.push(h);break}return e})},q.OS.API.HOST=q.location.hostname+(q.location.port?":"+q.location.port:""),q.OS.API.REST=q.location.protocol+"//"+q.OS.API.HOST,H=q.OS.API.REST,V=q.OS.API.HOST,q.OS.API.handler={get:H+"/VFS/get",shared:H+"/VFS/shared",scandir:function(t,e){var n;return n=H+"/VFS/scandir",P.post(n,{path:t},e,function(e,n){return C.osfail(__("Fail to scan directory: {0}",t),e,n)})},mkdir:function(t,e){var n;return n=H+"/VFS/mkdir",P.post(n,{path:t},e,function(e,n){return C.osfail(__("Fail to create directory: {0}",t),e,n)})},sharefile:function(t,e,n){var r;return r=H+"/VFS/publish",P.post(r,{path:t,publish:e},n,function(e,n){return C.osfail(__("Fail to publish file: {0}",t),e,n)})},fileinfo:function(t,e){var n;return n=H+"/VFS/fileinfo",P.post(n,{path:t},e,function(e,n){return C.osfail(__("Fail to get file meta data: {0}",t),e,n)})},readfile:function(t,e,n){var r;return r=H+"/VFS/get/",P.get(r+t,e,function(e,n){return C.osfail(__("Fail to read file: {0}",t),e,n)},n)},move:function(t,e,n){var r;return r=H+"/VFS/move",P.post(r,{src:t,dest:e},n,function(t,n){return C.osfail(__("Fail to move file: {0} -> {1}",n,e),t,n)})},delete:function(t,e){var n;return n=H+"/VFS/delete",P.post(n,{path:t},e,function(e,n){return C.osfail(__("Fail to delete: {0}",t),e,n)})},fileblob:function(t,e){var n;return n=H+"/VFS/get/",P.blob(n+t,e,function(e,n){return C.osfail("Fail to read file: "+t,e,n)})},packages:function(t,e){var n;return n=H+"/system/packages",P.post(n,t,e,function(e,n){return C.osfail(__("Fail to {0} package",t.command),e,n)})},upload:function(t,e){var n;return n=H+"/VFS/upload",P.upload(n,t,e,function(e,n){return C.osfail(__("Fail to upload file to: {0}",t),e,n)})},write:function(t,e,n){var r;return r=H+"/VFS/write",P.post(r,{path:t,data:e},n,function(e,n){return C.osfail(__("Fail to write to file: {0}",t),e,n)})},scanapp:function(t,e){return H+"/system/application"},apigateway:function(t,e,n){var r,i,o;return e?(r=V+"/system/apigateway?ws=1",i="https:"===window.location.protocol?"wss://":"ws://",o=new WebSocket(i+r),n&&n(o),o):(r=H+"/system/apigateway?ws=0",P.post(r,t,n,function(t,e){return C.osfail(__("Fail to invoke gateway api"),t,e)}))},auth:function(t){var e;return e=H+"/user/auth",P.post(e,{},t,function(t,n){return console.log(t,n),alert(__("Resource not found: {0}",e))})},login:function(t,e){var n;return n=H+"/user/login",P.post(n,t,e,function(){return alert(__("Resource not found: {0}",n))})},logout:function(){var t;return t=H+"/user/logout",P.post(t,{},function(t){return D.boot()},function(){return alert(__("Resource not found: {0}",t))})},setting:function(t){var e;return e=H+"/system/settings",P.post(e,D.setting,function(e){if(e.error&&C.oserror(__("Cannot save system setting"),e.error),t)return t(e)},function(n,r){var i;if(i=__("Fail to make request: {0}",e),C.osfail(i,n,r),t)return t({error:i})})},dbquery:function(t,e,n){var r;return r=H+"/VDB/"+t,P.post(r,e,n,function(t,e){return C.osfail(__("Fail to query data from database: {0}",r),t,e)})}},String.prototype.asFileHandler=function(){var t,e;return e=this.split("://"),(t=P.VFS.findHandlers(e[0]))&&0!==t.length?new t[0](this):(C.osfail(__("VFS unknown handler: {0}",this),P.throwe("OS.VFS"),this),null)},this.OS.API.VFS={handlers:{},register:function(t,e){return q.OS.API.VFS.handlers[t]=e},findHandlers:function(t){var e,n;return function(){var r,i;for(e in i=[],r=P.VFS.handlers)n=r[e],t.trim().match(new RegExp(e,"g"))&&i.push(n);return i}()}},a=function(){function t(t){this.dirty=!1,this.cache=void 0,this.setPath(t)}return t.prototype.setPath=function(t){var e,n;if(this.ready=!1,t&&(this.path=t.toString(),e=this.path.split("://"),this.protocol=e[0],e.length>1&&""!==(n=e[1].replace(/^\/+|\/+$/g,""))))return this.genealogy=n.split("/"),this.isRoot()||(this.basename=this.genealogy[this.genealogy.length-1]),0!==this.basename.lastIndexOf(".")&&-1!==this.basename.indexOf(".")?this.ext=this.basename.split(".").pop():void 0},t.prototype.asFileHandler=function(){return this},t.prototype.isRoot=function(){return!this.genealogy||0===this.genealogy.size},t.prototype.child=function(t){return this.isRoot()?this.path+t:this.path+"/"+t},t.prototype.isHidden=function(){return!!this.basename&&"."===this.basename[0]},t.prototype.hash=function(){return this.path?this.path.hash():-1},t.prototype.sendB64=function(t,e){var n,r,i,o;return i=this,r="object"===t?"text/plain":t,this.cache?"object"===t||"string"==typeof this.cache?(n="object"===t?JSON.stringify(this.cache).asBase64():this.cache.asBase64(),e(n="data:"+r+";base64,"+n)):((o=new FileReader).readAsDataURL(this.cache),o.onload=function(){return e(o.result)},o.onerror=function(t){return C.osfail(__("VFS Cannot encode file: {0}",i.path),P.throwe("OS.VFS"),t)}):e("")},t.prototype.parent=function(){return this.isRoot()?this:this.protocol+"://"+this.genealogy.slice(0,this.genealogy.length-1).join("/")},t.prototype.onready=function(t,e){var n;return this.ready?t():(n=this).meta(function(r){return r.error?e?e(r):C.osfail(n.path+": "+r.error,P.throwe("OS.VFS"),r.error):(n.info=r.result,n.ready=!0,t())})},t.prototype.read=function(t,e){var n;return n=this,this.onready(function(){return n.action("read",e,t)})},t.prototype.write=function(t,e){var n;return n=this,this.action("write",t,function(t){return t.result&&C.ostrigger("VFS",{m:"write",file:n}),e(t)})},t.prototype.mk=function(t,e){var n;return n=this,this.onready(function(){return n.action("mk",t,function(t){return t.result&&C.ostrigger("VFS",{m:"mk",file:n}),e(t)})})},t.prototype.remove=function(t){var e;return e=this,this.onready(function(){return e.action("remove",null,function(n){return n.result&&C.ostrigger("VFS",{m:"remove",file:e}),t(n)})})},t.prototype.upload=function(t){var e;return e=this,this.onready(function(){return e.action("upload",null,function(n){return n.result&&C.ostrigger("VFS",{m:"upload",file:e}),t(n)})})},t.prototype.publish=function(t){var e;return e=this,this.onready(function(){return e.action("publish",null,function(n){return n.result&&C.ostrigger("VFS",{m:"publish",file:e}),t(n)})})},t.prototype.download=function(t){var e;return e=this,this.onready(function(){return e.action("download",null,t)})},t.prototype.move=function(t,e){var n;return n=this,this.onready(function(){return n.action("move",t,function(n){return n.result&&C.ostrigger("VFS",{m:"move",file:t.asFileHandler()}),e(n)})})},t.prototype.execute=function(t){var e;return e=this,this.onready(function(){return e.action("execute",null,t)})},t.prototype.meta=function(t){},t.prototype.getlink=function(){return this.path},t.prototype.action=function(t,e,n){return C.osfail(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)},t}(),q.OS.API.VFS.BaseFileHandler=a,S=function(t){function e(t){e.__super__.constructor.call(this,t)}return M(e,t),e.prototype.meta=function(t){return P.handler.fileinfo(this.path,t)},e.prototype.getlink=function(){return P.handler.get+"/"+this.path},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return"dir"===this.info.type?P.handler.scandir(this.path,n):"binary"===e?P.handler.fileblob(this.path,n):P.handler.readfile(this.path,n,e||"text");case"mk":return"file"===this.info.type?n({error:__("{0} is not a directory",this.path)}):P.handler.mkdir(this.path+"/"+e,n);case"write":return"base64"===e?P.handler.write(r.path,r.cache,n):this.sendB64(e,function(t){return P.handler.write(r.path,t,n)});case"upload":if("file"===this.info.type)return;return P.handler.upload(this.path,n);case"remove":return P.handler.delete(this.path,n);case"publish":return P.handler.sharefile(this.path,!0,n);case"download":if("dir"===this.info.type)return;return P.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),P.saveblob(r.basename,e)});case"move":return P.handler.move(this.path,e,n);default:return C.osfail(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)}},e}(q.OS.API.VFS.BaseFileHandler),q.OS.API.VFS.register("^(home|desktop|os|Untitled)$",S),e=function(t){function e(t){e.__super__.constructor.call(this,t),this.basename&&(this.info=D.setting.system.packages[this.basename]),this.ready=!0}return M(e,t),e.prototype.meta=function(t){return t()},e.prototype.action=function(t,e,n){var r,i;switch(this,t){case"read":if(this.info)return n({result:this.info});if(!this.isRoot())return;return n({result:function(){var t,e;for(r in e=[],t=D.setting.system.packages)i=t[r],e.push(i);return e}()});case"mk":case"write":case"upload":case"remove":case"publish":case"download":case"move":break;default:return C.osfail(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)}},e}(q.OS.API.VFS.BaseFileHandler),q.OS.API.VFS.register("^app$",e),l=function(t){function e(t,n,r){e.__super__.constructor.call(this,t),r&&(this.cache=r),this.info={mime:n,path:t,size:r?r.length:0,name:this.basename,type:"file"}}return M(e,t),e.prototype.meta=function(t){return t()},e.prototype.onchange=function(t){return this.onchange=t},e.prototype.action=function(t,e,n){var r;switch(this,t){case"read":return n({result:this.cache});case"mk":break;case"write":return this.cache=e,this.onchange&&this.onchange(this),n({result:!0});case"upload":case"remove":case"publish":break;case"download":return r=new Blob([this.cache],{type:"octet/stream"}),P.saveblob(this.basename,r);case"move":break;default:return C.osfail(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)}},e}(q.OS.API.VFS.BaseFileHandler),q.OS.API.VFS.register("^mem$",l),O=function(t){function e(t){e.__super__.constructor.call(this,t),this.ready=!0}return M(e,t),e.prototype.meta=function(t){return t({result:!0})},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return P.get(this.path,function(t){return n(t)},function(t,e){return C.oserror(__("VFS cannot read : {0}",r.path),t,e)},e||"text");default:return C.oserror(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)}},e}(q.OS.API.VFS.BaseFileHandler),q.OS.API.VFS.register("^(http|https)$",O),F=function(t){function e(t){e.__super__.constructor.call(this,t),this.isRoot()&&(this.ready=!0)}return M(e,t),e.prototype.meta=function(t){return P.handler.fileinfo(this.path,t)},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return this.isRoot()?P.get(P.handler.shared+"/all",n,function(t,e){}):"binary"===e?P.handler.fileblob(this.path,n):P.handler.readfile(this.path,n,e||"text");case"mk":break;case"write":return P.handler.write(this.path,e,n);case"remove":return P.handler.sharefile(this.basename,!1,n);case"upload":break;case"publish":return n({result:this.basename});case"download":if("dir"===this.info.type)return;return P.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),P.saveblob(r.basename,e)});case"move":break;default:return C.osfail(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)}},e}(q.OS.API.VFS.BaseFileHandler),q.OS.API.VFS.register("^shared$",F),y={"gdv://":{id:"root",mime:"dir"}},v=function(t){function e(t){if(e.__super__.constructor.call(this,t),this,this.setting=D.setting.VFS.gdrive,!this.setting)return C.oserror(__("Unknown API setting for {0}","GAPI"),P.throwe("OS.VFS"),null);this.isRoot()&&(this.gid="root"),this.cache=""}return M(e,t),e.prototype.oninit=function(t){var e,n;if(n=this,this.setting)return e=function(e){return e?t():(y={"gdv://":{id:"root",mime:"dir"}},gapi.auth2.getAuthInstance().signIn())},P.libready(this.setting.apilink)?(gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return e(t)}),e(gapi.auth2.getAuthInstance().isSignedIn.get())):P.require(this.setting.apilink,function(){var t;return t=C.getMID(),gapi.load("client:auth2",function(){return P.loading(t,"GAPI"),gapi.client.init({apiKey:n.setting.API_KEY,clientId:n.setting.CLIENT_ID,discoveryDocs:n.setting.DISCOVERY_DOCS,scope:n.setting.SCOPES}).then(function(){return P.loaded(t,"OK"),gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return e(t)}),I.openDialog("YesNoDialog",function(t){return t?e(gapi.auth2.getAuthInstance().isSignedIn.get()):C.osinfo(__("User abort the authentication"))},__("Authentication"),{text:__("Would you like to login to {0}?","Google Drive")})}).catch(function(e){return P.loaded(t,"FAIL"),C.oserror(__("VFS cannot init {0}: {1}","GAPI",e.error),P.throwe("OS.VFS"),e)})})})},e.prototype.meta=function(t){var e;return e=this,this.oninit(function(){var n,r;return r=C.getMID(),y[e.path]&&(e.gid=y[e.path].id),e.gid?(P.loading(r,"GAPI"),gapi.client.drive.files.get({fileId:e.gid,fields:e.fields()}).then(function(e){if(P.loaded(r,"OK"),e.result)return e.result.mime=e.result.mimeType,t(e)}).catch(function(t){return P.loaded(r,"FAIL"),C.oserror(__("VFS cannot get meta data for {0}",e.gid),P.throwe("OS.VFS"),t)})):(n=e.parent().asFileHandler()).meta(function(r){var i,o;return i=r.result,o=C.getMID(),P.loading(o,"GAPI"),y[n.path]={id:i.id,mime:i.mimeType},gapi.client.drive.files.list({q:"name = '"+e.basename+"' and '"+i.id+"' in parents and trashed = false",fields:"files("+e.fields()+")"}).then(function(n){if(P.loaded(o,"OK"),n.result.files&&n.result.files.length>0)return y[e.path]={id:n.result.files[0].id,mime:n.result.files[0].mimeType},n.result.files[0].mime=n.result.files[0].mimeType,t({result:n.result.files[0]})}).catch(function(t){return P.loaded(o,"FAIL"),C.oserror(__("VFS cannot get meta data for {0}",e.path),P.throwe("OS.VFS"),t)})})})},e.prototype.fields=function(){return"webContentLink, id, name,mimeType,description, kind, parents, properties, iconLink, createdTime, modifiedTime, owners, permissions, fullFileExtension, fileExtension, size"},e.prototype.isFolder=function(){return"application/vnd.google-apps.folder"===this.info.mimeType},e.prototype.save=function(t,e,n){var r,i,o,a,s,u;return i=this,o=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,a=C.getMID(),s="https://www.googleapis.com/upload/drive/v3/files/"+t+"?uploadType=media",(u=new XMLHttpRequest).open("PATCH",s),u.setRequestHeader("Authorization","Bearer "+o),u.setRequestHeader("Content-Type",e),u.setRequestHeader("Content-Encoding","base64"),u.setRequestHeader("Content-Transfer-Encoding","base64"),P.loading(a,"GAPI"),r=function(t,e){return P.loaded(a,"FAIL"),C.oserror(__("VFS cannot save : {0}",i.path),t,e)},u.onreadystatechange=function(){if(4===u.readyState)return 200===u.status?(P.loaded(a,"OK"),n({result:JSON.parse(u.responseText)})):r(u,u.status)},u.onerror=function(){return r(u,u.status)},"base64"===e?u.send(i.cache.replace(/^data:[^;]+;base64,/g,"")):this.sendB64(e,function(t){return u.send(t.replace(/^data:[^;]+;base64,/g,""))})},e.prototype.getlink=function(){if(this.ready)return this.info.webContentLink},e.prototype.action=function(t,e,n){var r,i,o,a,s,u,c;switch(a=this,c=C.getMID(),P.loading(c,"GAPI"),t){case"read":if(!this.info.id)return;return this.isFolder()?gapi.client.drive.files.list({q:"'"+a.info.id+"' in parents and trashed = false",fields:"files("+a.fields()+")"}).then(function(t){var e,r,i,o;if(P.loaded(c,"OK"),t.result.files){for(r=0,i=(o=t.result.files).length;r<i;r++)(e=o[r]).path=a.child(e.name),e.mime=e.mimeType,e.filename=e.name,e.type="file",e.gid=e.id,"application/vnd.google-apps.folder"===e.mimeType&&(e.mime="dir",e.type="dir",e.size=0),y[e.path]={id:e.gid,mime:e.mime};return n({result:t.result.files})}}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot read : {0}",a.path),P.throwe("OS.VFS"),t)}):gapi.client.drive.files.get({fileId:a.info.id,alt:"media"}).then(function(t){return P.loaded(c,"OK"),n("binary"!==e?t.body:t.body.asUint8Array())}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot read : {0}",a.path),P.throwe("OS.VFS"),t)});case"mk":if(!this.isFolder())return n({error:__("{0} is not a directory",this.path)});s={name:e,parents:[this.info.id],mimeType:"application/vnd.google-apps.folder"},gapi.client.drive.files.create({resource:s,fields:"id"}).then(function(t){return P.loaded(c,"OK"),t&&t.result?(y[a.child(e)]={id:t.result.id,mime:"dir"},n(t)):C.oserror(__("VFS cannot create : {0}",e),P.throwe("OS.VFS"),t)}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot create : {0}",e),P.throwe("OS.VFS"),t)});break;case"write":return o=void 0,y[a.path]&&(o=y[a.path].id),o?(P.loaded(c,"OK"),this.save(o,e,n)):(i=this.parent().asFileHandler()).onready(function(){return s={name:a.basename,mimeType:e,parents:[i.info.id]},gapi.client.drive.files.create({resource:s,fields:"id"}).then(function(t){return P.loaded(c,"OK"),t&&t.result?(y[a.path]={id:t.result.id,mime:e},a.save(t.result.id,e,n)):C.oserror(__("VFS cannot write : {0}",a.path),P.throwe("OS.VFS"),t)}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot write : {0}",a.path),P.throwe("OS.VFS"),t)})});case"upload":if(!this.isFolder())return;return u=$("<input>").attr("type","file").css("display","none"),P.loaded(c,"OK"),u.change(function(){var t,e;return e=u[0].files[0],(t=a.child(e.name).asFileHandler()).cache=e,t.write(e.type,n),u.remove()}),u.click();case"remove":if(!this.info.id)return;return gapi.client.drive.files.delete({fileId:a.info.id}).then(function(t){return P.loaded(c,"OK"),t?(y[a.path]=null,n({result:!0})):C.oserror(__("VFS cannot delete : {0}",a.path),P.throwe("OS.VFS"),t)}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot delete : {0}",a.path),P.throwe("OS.VFS"),t)});case"publish":P.loaded(c,"OK");break;case"download":return gapi.client.drive.files.get({fileId:a.info.id,alt:"media"}).then(function(t){var e,n,r,i,o;if(P.loaded(c,"OK"),!t.body)return C.oserror(__("VFS cannot download file : {0}",a.path),P.throwe("OS.VFS"),t);for(n=[],r=i=0,o=t.body.length-1;0<=o?i<=o:i>=o;r=0<=o?++i:--i)n.push(t.body.charCodeAt(r));return n=new Uint8Array(n),e=new Blob([n],{type:"octet/stream"}),P.saveblob(a.basename,e)}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot download file : {0}",a.path),P.throwe("OS.VFS"),t)});case"move":return(r=e.asFileHandler().parent().asFileHandler()).onready(function(){var t;return t=a.info.parents.join(","),gapi.client.drive.files.update({fileId:a.info.id,addParents:r.info.id,removeParents:t,fields:"id"}).then(function(t){return P.loaded(c,"OK"),t?n(t):C.oserror(__("VFS cannot move : {0}",a.path),P.throwe("OS.VFS"),t)}).catch(function(t){return P.loaded(c,"FAIL"),C.oserror(__("VFS cannot move : {0}",a.gid),P.throwe("OS.VFS"),t)})},function(t){return P.loaded(c,"FAIL")});default:return P.loaded(c,"FAIL"),C.osfail(__("VFS unknown action: {0}",t),P.throwe("OS.VFS"),t)}},e}(this.OS.API.VFS.BaseFileHandler),q.OS.API.VFS.register("^gdv$",v),q.OS.API.onsearch("Google Drive",function(t){var e,n,r,i,o;for(r in e=[],i=new RegExp(t,"i"),y)o=y[r],(r.match(i)||o&&o.mime.match(i))&&((n=r.asFileHandler()).text=n.basename,n.mime=o.mime,n.iconclass="fa fa-file","dir"===n.mime&&(n.iconclass="fa fa-folder"),n.complex=!0,n.detail=[{text:n.path}],e.push(n));return e}),q.OS.onexit("cleanUpGoogleDrive",function(){var t;if(y={"gdv://":{id:"root",mime:"dir"}},D.setting.VFS.gdrive&&P.libready(D.setting.VFS.gdrive.apilink)&&(t=gapi.auth2.getAuthInstance()))return t.isSignedIn.get()?$("<iframe/>",{src:"https://www.google.com/accounts/Logout",frameborder:0,onload:function(){return t.disconnect()}}):void 0}),f=function(){function t(t){this.table=t}return t.prototype.save=function(t,e){return P.handler.dbquery("save",{table:this.table,data:t},e)},t.prototype.delete=function(t,e){var n;return n={table:this.table},t&&""!==t?(isNaN(t)?n.cond=t:n.id=t,P.handler.dbquery("delete",n,e)):C.oserror(__("VDB Unknown condition for delete command"),P.throwe("OS.DB"),t)},t.prototype.get=function(t,e){return P.handler.dbquery("get",{table:this.table,id:t},e)},t.prototype.find=function(t,e){return P.handler.dbquery("select",{table:this.table,cond:t},e)},t}(),q.OS.API.DB=f,q.OS.GUI={subwindows:new Object,dialog:void 0,fullscreen:!1,shortcut:{ALT:{},CTRL:{},SHIFT:{},META:{}},SYS_MENU:[{text:"",iconclass:"fa fa-eercast",dataid:"sys-menu-root",child:[{text:"__(Applications)",child:[],dataid:"sys-apps",iconclass:"fa fa-adn",onmenuselect:function(t){return I.launch(t.item.data.app)}}],onmenuselect:function(t){return"sys-logout"===t.item.data.dataid?D.exit():"os-fullsize"===t.item.data.dataid?I.toggleFullscreen():t.item.data.dataid?void 0:I.launch(t.item.data.app)}}],htmlToScheme:function(t,e,n){var r;return r=$.parseHTML(t),e.scheme&&$(e.scheme).remove(),$(n).append(r),e.scheme=r[0],riot.mount($(r),{observable:e.observable}),e.main(),e.show()},loadScheme:function(t,e,n){return t.asFileHandler().read(function(t){return t?I.htmlToScheme(t,e,n):null})},clearTheme:function(){return $("head link#ostheme").attr("href","")},loadTheme:function(t,e){var n;return e&&I.clearTheme(),n="resources/themes/"+t+"/"+t+".css",$("head link#ostheme").attr("href",n)},pushServices:function(t){if(t.length>0)return C.observable.one("srvroutineready",function(){return t.splice(0,1),I.pushServices(t)}),I.pushService(t[0])},openDialog:function(t,e,n,r){var i;if(!I.dialog)return I.subwindows[t]?(I.dialog=new I.subwindows[t],I.dialog.parent=I,I.dialog.handler=e,I.dialog.pid=-1,I.dialog.data=r,I.dialog.title=n,I.dialog.init()):(i=P.throwe("Dialog"),C.oserror(__("Dialog {0} not found",t),i,null));I.dialog.show()},pushService:function(t){var e,n,r;return n=t.split("/"),r=n[1],e=n[0],D.APP[r]?T.createProcess(r,D.APP[r]):I.loadApp(e,function(t){if(D.APP[r])return T.createProcess(r,D.APP[r])},function(t,e){return C.trigger("srvroutineready",r),C.osfail(__("Cannot read service script: {0}",r),t,e)})},appsByMime:function(t){var e,n,r,i,o,a,s,u,c,l;for(u=function(){var t,e;for(o in e=[],t=D.setting.system.packages)(l=t[o])&&l.app&&e.push(l);return e}(),c=function(){var t,e,n;for(n=[],t=0,e=u.length;t<e;t++)(s=u[t])&&n.push(s.mimes);return n}(),e=[],n=function(n,r){var i;try{return n.filter(function(n,i){return!!t.match(new RegExp(n,"g"))&&(!(e.indexOf(u[r])>=0)&&(e.push(u[r]),!1))})}catch(e){return i=e,C.osfail(__("Error find app by mimes {0}",t),i,t)}},r=i=0,a=c.length;i<a;r=++i)(s=c[r])&&n(s,r);return e},appsWithServices:function(){var t,e,n,r;for(t in e={},n=D.setting.system.packages)(r=n[t])&&r.services&&r.services.length>0&&(e[t]=r);return e},openWith:function(t){var e,n,r;if(t)return"app"===t.type&&t.app?I.launch(t.app):"app"===t.type?C.osinfo(__("Application {0} is not executable",t.text)):0===(e=I.appsByMime("dir"===t.type?"dir":t.mime)).length?C.osinfo(__("No application available to open {0}",t.filename)):1===e.length?I.launch(e[0].app,[t.path]):(r=function(){var t,r,i;for(i=[],t=0,r=e.length;t<r;t++)n=e[t],i.push({text:n.app,icon:n.icon,iconclass:n.iconclass});return i}(),I.openDialog("SelectionDialog",function(e){return I.launch(e.text,[t.path])},__("Open with"),r))},forceLaunch:function(t,e){return console.warn("This method is used for developing only, please use the launch method instead"),I.unloadApp(t),I.launch(t,e)},unloadApp:function(t){return T.killAll(t,!0),D.APP[t]&&D.APP[t].style&&$(D.APP[t].style).remove(),delete D.APP[t]},loadApp:function(t,e,n){var r;return r="os://packages/"+t,D.setting.system.packages[t].path&&(r=D.setting.system.packages[t].path),(r+"/main.js").asFileHandler().read(function(n){return(r+"/package.json").asFileHandler().read(function(n){var i,o,a,s,u;if(n.path=r,D.APP[t]&&(D.APP[t].meta=n),n.services)for(o=0,a=(s=n.services).length;o<a;o++)u=s[o],D.APP[u].meta=n;return(i=r+"/main.css").asFileHandler().onready(function(n){var r,o;return o=(new Date).timestamp(),r=$("<link>",{rel:"stylesheet",type:"text/css",href:P.handler.get+"/"+i+"?stamp="+o}).appendTo("head"),D.APP[t]&&(D.APP[t].style=r[0]),e(t)},function(){return e(t)})},"json")},"script")},launch:function(t,e){return D.APP[t]?D.APP[t]?T.createProcess(t,D.APP[t],e):void 0:I.loadApp(t,function(t){return T.createProcess(t,D.APP[t],e)},function(t,e){})},dock:function(t,e){var n,r;return n={icon:null,iconclass:e.iconclass||"",app:t,onbtclick:function(){return t.toggle()}},e.icon&&(n.icon=e.path+"/"+e.icon),e.icon||e.iconclass||(n.iconclass="fa fa-cogs"),r=$("#sysdock"),t.init(),t.one("rendered",function(){return r.get(0).newapp(n),t.sysdock=r.get(0),t.appmenu=$("[data-id = 'appmenu']","#syspanel")[0],t.subscribe("systemlocalechange",function(e){return t.update()}),t.subscribe("appregistry",function(e){if(e.name===t.name)return t.applySetting(e.data.m)})})},toggleFullscreen:function(){var t;if(t=$("body")[0],I.fullscreen){if(document.exitFullscreen)return document.exitFullscreen();if(document.mozCancelFullScreen)return document.mozCancelFullScreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen();if(document.cancelFullScreen)return document.cancelFullScreen()}else{if(t.requestFullscreen)return t.requestFullscreen();if(t.mozRequestFullScreen)return t.mozRequestFullScreen();if(t.webkitRequestFullscreen)return t.webkitRequestFullscreen();if(t.msRequestFullscreen)return t.msRequestFullscreen()}},undock:function(t){return $("#sysdock").get(0).removeapp(t)},attachservice:function(t){return $("#syspanel")[0].attachservice(t),t.init(),t.subscribe("systemlocalechange",function(e){return t.update()})},detachservice:function(t){return $("#syspanel")[0].detachservice(t)},bindContextMenu:function(t){var e;return(e=function(n){var r;return n.contextmenuHandler?n.contextmenuHandler(t,$("#contextmenu")[0]):(r=$(n).parent().get(0))!==$("#workspace").get(0)?e(r):void 0})(t.target),t.preventDefault()},bindKey:function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),I.shortcut[i]))return I.shortcut[i][r]=e},wallpaper:function(t){var e;return t&&(D.setting.appearance.wp=t),e=D.setting.appearance.wp,$("body").css("background-image","url("+P.handler.get+"/"+e.url+")").css("background-size",e.size).css("background-repeat",e.repeat)},showTooltip:function(t,e,n){var r,i,o,a,s,u,c,l;switch(t=t[0],o=$("#systooltip")[0],$("#workspace").on("mousemove",function(e){if(0===$(e.target).closest(t).length)return $(o).hide(),$("#workspace").off("mousemove")}),u=e,(r=e.split(/:(.+)/)).length>1&&(u=r[1]),s=$(t).offset(),l=$(t).width(),i=$(t).height(),o.set("text",u),$(o).show(),r[0]){case"cr":return a=s.left+l+5,c=s.top+i/2-$(o).height()/2,$(o).css("top",c+"px").css("left",a+"px");default:if(!n)return;return $(o).css("top",n.clientY+5+"px").css("left",n.clientX+5+"px")}},initDM:function(){return P.resource("schemes/dm.html",function(t){var e,n,r;return t?(r=$.parseHTML(t),$("#wrapper").append(r),C.observable.one("sysdockloaded",function(){return $(window).bind("keydown",function(t){var e,n,r,i;if((r=$("#sysdock")[0])&&(e=r.get("selectedApp"),n=String.fromCharCode(t.which).toUpperCase(),i=void 0,t.ctrlKey?i="CTRL":t.metaKey?i="META":t.shiftKey?i="SHIFT":t.altKey&&(i="ALT"),i)){if(!(!e||e.shortcut(i,n,t)))return t.preventDefault();if(I.shortcut[i]&&I.shortcut[i][n])return I.shortcut[i][n](t),t.preventDefault()}})}),riot.mount($("#syspanel",$("#wrapper"))),riot.mount($("#sysdock",$("#workspace")),{items:[]}),riot.mount($("#systooltip",$("#wrapper"))),riot.mount($("#contextmenu",$("#wrapper"))),$("#workspace").contextmenu(function(t){return I.bindContextMenu(t)}),$("#workspace").mouseover(function(t){var e;if((e=$(t.target).closest("[tooltip]")).length>0)return I.showTooltip(e,$(e).attr("tooltip"),t)}),e=$("#desktop"),n=D.setting.desktop.path.asFileHandler(),e[0].fetch=function(){var t;return t=function(){return(n=D.setting.desktop.path.asFileHandler()).read(function(t){var n;return t.error?C.osfail(t.error,P.throwe("OS.VFS"),t.error):(n=[],$.each(t.result,function(t,e){if("."!==e.filename[0]||D.setting.desktop.showhidden)return e.text=e.filename,e.iconclass=e.type,n.push(e)}),e[0].set("items",n),e[0].refresh())})},n.onready(function(){return t()},function(e){var r;return console.log(n.path+" not found"),r=n.basename,n.parent().asFileHandler().mk(r,function(e){var n;return n=P.throwe("OS.VFS"),e.error?C.osfail(d.error,n,d.error):t()})})},e[0].ready=function(t){return t.observable=C,window.onresize=function(){return C.trigger("desktopresize"),t.refresh()},e[0].set("onlistselect",function(t){return $("#sysdock").get(0).set("selectedApp",null)}),e[0].set("onlistdbclick",function(t){var n;return $("#sysdock").get(0).set("selectedApp",null),n=e[0].get("selected"),I.openWith(n)}),e.on("click",function(t){if(t.target===e[0])return e[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null)}),e[0].contextmenuHandler=function(t,n){var r,i,o;return t.target===e[0]&&e[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null),i=(i=[{text:__("Open"),dataid:"desktop-open"},{text:__("Refresh"),dataid:"desktop-refresh"}]).concat(function(){var t,e;for(r in e=[],t=D.setting.desktop.menu)o=t[r],e.push(o);return e}()),n.set("items",i),n.set("onmenuselect",function(t){var n;switch(t.item.data.dataid){case"desktop-open":return(n=e[0].get("selected"))?I.openWith(n):((n=D.setting.desktop.path.asFileHandler()).mime="dir",I.openWith(n));case"desktop-refresh":return e[0].fetch();default:if(t.item.data.app)return I.launch(t.item.data.app,t.item.data.args)}}),n.show(t)},e[0].fetch(),C.observable.on("VFS",function(t){if(t.data.file.hash()===n.hash()||t.data.file.parent().hash()===n.hash())return e[0].fetch()}),C.ostrigger("desktoploaded")},riot.mount(e)):null},function(t,e){return alert(__("System fail: Cannot init desktop manager")),console.log(e,t)})},refreshDesktop:function(){return $("#desktop")[0].fetch()},refreshSystemMenu:function(){var t,e,n,r;for(t in I.SYS_MENU[0].child.length=1,I.SYS_MENU[0].child[0].child.length=0,e=D.setting.system.packages)(r=e[t])&&r.app&&I.SYS_MENU[0].child[0].child.push(r);for(t in n=D.setting.system.menu)r=n[t],I.SYS_MENU[0].child.push(r);return I.SYS_MENU[0].child.push({text:"__(Toggle Full screen)",dataid:"os-fullsize",iconclass:"fa fa-tv"}),I.SYS_MENU[0].child.push({text:"__(Log out)",dataid:"sys-logout",iconclass:"fa fa-user-times"}),$("[data-id = 'os_menu']","#syspanel")[0].update()},buildSystemMenu:function(){return $("[data-id = 'os_menu']","#syspanel")[0].set("items",I.SYS_MENU)},mkdialog:function(t){return new I.BasicDialog(t.name,t.layout)},login:function(){return P.resource("schemes/login.html",function(t){var e;return t?(e=$.parseHTML(t),$("#wrapper").append(e),$("#btlogin").click(function(){var t;return t={username:$("#txtuser").val(),password:$("#txtpass").val()},P.handler.login(t,function(t){return t.error?$("#login_error").html(t.error):I.startAntOS(t.result)})}),$("#txtpass").keyup(function(t){if(13===t.which)return $("#btlogin").click()})):null},function(t,e){return alert(__("System fail: Cannot init login screen"))})},startAntOS:function(t){return D.cleanup(),D.systemSetting(t),I.loadTheme(D.setting.appearance.theme),I.wallpaper(),C.observable.one("syspanelloaded",function(){return C.observable.on("systemlocalechange",function(t){return $("#syspanel")[0].update()}),P.packages.cache(function(t){if(t.result)return P.packages.fetch(function(t){var e,n,r,i,o,a,s,u;if(t.result)for(r in o=t.result)(u=o[r]).text=u.name,u.filename=r,u.type="app",u.mime="antos/app",u.icon&&(u.icon=u.path+"/"+u.icon),u.iconclass||u.icon||(u.iconclass="fa fa-adn");for(D.setting.system.packages=t.result?t.result:void 0,I.refreshSystemMenu(),I.buildSystemMenu(),I.pushServices(function(){var t,e,n,r;for(r=[],t=0,e=(n=D.setting.system.startup.services).length;t<e;t++)u=n[t],r.push(u);return r}()),s=[],n=0,i=(a=D.setting.system.startup.apps).length;n<i;n++)e=a[n],s.push(I.launch(e));return s})})}),P.setLocale(D.setting.system.locale,function(){return I.initDM()})}},s=function(){function t(t,e){var n;this.name=t,this.args=e,this.observable=riot.observable(),this._api=q.OS.API,this._gui=q.OS.GUI,this.systemsetting=q.OS.setting,n=this,this.on("exit",function(){return n.quit()}),this.host="#desktop",this.dialog=void 0}return t.prototype.render=function(t){return I.loadScheme(t,this,this.host)},t.prototype.quit=function(t){var e;if(e=new I.BaseEvent("exit",t),this.onexit(e),!e.prevent)return this.observable.off("*"),delete this.observable,this.dialog&&this.dialog.quit(),T.kill(this)},t.prototype.path=function(){var t;return(t=this.meta())&&t.path?t.path:null},t.prototype.call=function(t,e){return this._api.apigateway(t,!1,e)},t.prototype.stream=function(){return this._api.apigateway(null,!0,null)},t.prototype.init=function(){},t.prototype.onexit=function(t){},t.prototype.one=function(t,e){return this.observable.one(t,e)},t.prototype.on=function(t,e){return this.observable.on(t,e)},t.prototype.off=function(t,e){return e?this.observable.off(t,e):this.observable.off(t)},t.prototype.trigger=function(t,e){return this.observable.trigger(t,e)},t.prototype.subscribe=function(t,e){return C.on(t,e,this)},t.prototype.openDialog=function(t,e,n,r){if(!this.dialog){if("string"==typeof t){if(!I.subwindows[t])return void this.error(__("Dialog {0} not found",t));this.dialog=new I.subwindows[t]}else this.dialog=t;return this.dialog.parent=this,this.dialog.handler=e,this.dialog.pid=this.pid,this.dialog.data=r,this.dialog.title=n,this.dialog.init()}this.dialog.show()},t.prototype.ask=function(t,e,n){return this._gui.openDialog("YesNoDialog",function(t){if(t)return n()},t,{text:e})},t.prototype.publish=function(t,e,n){var r,i;return r=void 0,(i=this.meta()).icon&&(r=i.path+"/"+i.icon),C.trigger(t,{id:this.pid,name:this.name,data:{m:e,icon:r,iconclass:i.iconclass},error:n})},t.prototype.notify=function(t){return this.publish("notification",t)},t.prototype.warn=function(t){return this.publish("warning",t)},t.prototype.error=function(t){return this.publish("error",t,this._api.throwe(this.name))},t.prototype.fail=function(t){return this.publish("fail",t)},t.prototype.throwe=function(){return this._api.throwe(this.name)},t.prototype.update=function(){if(this.scheme)return this.scheme.update()},t.prototype.find=function(t){if(this.scheme)return $("[data-id='"+t+"']",this.scheme)[0]},t.prototype.select=function(t){if(this.scheme)return $(t,this.scheme)},t}(),this.OS.GUI.BaseModel=s,(n=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),D.setting.applications[this.name]&&!Array.isArray(OS.setting.applications[this.name])||(D.setting.applications[this.name]={}),this.setting=D.setting.applications[this.name],this.keycomb={ALT:{},CTRL:{},SHIFT:{},META:{}}}return M(e,t),e.prototype.init=function(){var t;return t=this,this.off("*"),this.on("exit",function(){return t.quit()}),this.on("focus",function(){if(t.sysdock.set("selectedApp",t),t.appmenu.pid=t.pid,t.appmenu.set("items",t.baseMenu()||[]),t.appmenu.set("onmenuselect",function(e){return t.trigger("menuselect",e)}),t.dialog)return t.dialog.show()}),this.on("hide",function(){if(t.sysdock.set("selectedApp",null),t.appmenu.set("items",[]),t.dialog)return t.dialog.hide()}),this.on("menuselect",function(e){switch(e.e.item.data.dataid){case t.name+"-about":return t.openDialog("AboutDialog",function(){});case t.name+"-exit":return t.trigger("exit")}}),this.on("apptitlechange",function(){return t.sysdock.update()}),this.loadScheme()},e.prototype.loadScheme=function(){var t;return t=this.meta().path+"/scheme.html",this.render(t)},e.prototype.bindKey=function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),this.keycomb[i]))return this.keycomb[i][r]=e},e.prototype.shortcut=function(t,e,n){return!this.keycomb[t]||(!this.keycomb[t][e]||(this.keycomb[t][e](n),!1))},e.prototype.applySetting=function(t){},e.prototype.applyAllSetting=function(){var t,e,n;for(t in n=[],e=this.setting)e[t],n.push(this.applySetting(t));return n},e.prototype.registry=function(t,e){return this.setting[t]=e,this.publish("appregistry",t)},e.prototype.show=function(){return this.trigger("focus")},e.prototype.blur=function(){return this.appmenu&&this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),this.trigger("blur")},e.prototype.hide=function(){return this.trigger("hide")},e.prototype.toggle=function(){return this.trigger("toggle")},e.prototype.title=function(){return this.scheme.get("apptitle")},e.prototype.onexit=function(t){if(this.cleanup(t),!t.prevent)return this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),$(this.scheme).remove()},e.prototype.meta=function(){return D.APP[this.name].meta},e.prototype.baseMenu=function(){return[{text:D.APP[this.name].meta.name,child:[{text:"__(About)",dataid:this.name+"-about"},{text:"__(Exit)",dataid:this.name+"-exit"}]}].concat(this.menu()||[])},e.prototype.main=function(){},e.prototype.menu=function(){return[]},e.prototype.open=function(){},e.prototype.data=function(){},e.prototype.cleanup=function(t){},e}(this.OS.GUI.BaseModel)).type=1,this.OS.GUI.BaseApplication=n,(u=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),this.icon=void 0,this.iconclass="fa-paper-plane-o",this.text="",this.timer=void 0,this.holder=void 0}return M(e,t),e.prototype.init=function(){},e.prototype.meta=function(){return D.APP[this.name].meta},e.prototype.attach=function(t){return this.holder=t},e.prototype.update=function(){if(this.holder&&this.holder.update(),this.scheme)return this.scheme.update()},e.prototype.watch=function(t,e){var n,r;return r=this,(n=function(){return e(),r.timer=setTimeout(function(){return n()},t)})()},e.prototype.onexit=function(t){if(this.timer&&console.log("clean timer"),this.timer&&clearTimeout(this.timer),this.cleanup(t),this.scheme)return $(this.scheme).remove()},e.prototype.main=function(){},e.prototype.show=function(){},e.prototype.awake=function(t){},e.prototype.cleanup=function(t){},e}(this.OS.GUI.BaseModel)).type=2,u.singleton=!0,this.OS.GUI.BaseService=u,o=function(){function t(t,e){this.name=t,this.force=e,this.prevent=!1}return t.prototype.preventDefault=function(){if(!this.force)return this.prevent=!0},t}(),this.OS.GUI.BaseEvent=o,(k=function(t){function e(t){e.__super__.constructor.call(this,t,null),this.parent=void 0,this.modal=!1}return M(e,t),e.prototype.quit=function(){var t;if(t=new I.BaseEvent("exit"),this.onexit(t),!t.prevent&&(delete this.observable,this.scheme&&$(this.scheme).remove(),this.dialog))return this.dialog.quit()},e.prototype.init=function(){},e.prototype.main=function(){},e.prototype.meta=function(){return this.parent.meta()},e.prototype.show=function(){return this.trigger("focus"),$(this.scheme).css("z-index",window._zindex+2)},e.prototype.hide=function(){return this.trigger("hide")},e}(this.OS.GUI.BaseModel)).type=3,this.OS.GUI.SubWindow=k,i=function(t){function e(t){e.__super__.constructor.call(this,t),this.handler=void 0}return M(e,k),e.prototype.onexit=function(t){if(this.parent)return this.parent.dialog=void 0},e}(),this.OS.GUI.BaseDialog=i,c=function(t){function e(t,n,r){this.conf=n,this.title=r,e.__super__.constructor.call(this,t)}return M(e,i),e.prototype.init=function(){var t,e,n,r,i;for(e in this.title||(this.title=this.name),t="<afx-app-window  data-id = '"+this.name+"'  width='"+this.conf.width+"' height='"+this.conf.height+"'>",t+="<afx-hbox><div data-width='7'></div><afx-vbox><div data-height='5'></div>",n=this.conf.tags)t+="<"+(i=n[e]).tag+" "+i.att+"  data-id = 'content"+e+"'></"+i.tag+">";for(e in t+="<div data-height = '35' style=' text-align:right;padding-top:3px;'>",r=this.conf.buttons)t+="<afx-button data-id = 'bt"+e+"' text = '"+(i=r[e]).label+"' style='margin-left:5px;'></afx-button>";return t+="</div><div data-height='5'></div></afx-vbox><div data-width='7'></div></afx-hbox></afx-app-window>",I.htmlToScheme(t,this,this.host)},e.prototype.main=function(){var t,e,n,r,i;for(e in this.scheme.set("apptitle",this.title),this.scheme.set("minimizable",!1),void 0!==this.conf.resizable&&this.scheme.set("resizable",this.conf.resizable),n=this,t=function(t){return function(){return t.onclick(n)}},r=this.conf.buttons)i=r[e],n.find("bt"+e).set("onbtclick",t(i));if(this.conf.filldata&&this.conf.filldata(this),this.conf.xtra)return this.conf.xtra(this)},e}(),this.OS.GUI.BasicDialog=c,b=function(t){function e(){e.__super__.constructor.call(this,"PromptDialog",{tags:[{tag:"afx-label"},{tag:"input",att:"type = 'text' data-height='25'"}],width:200,height:120,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;return""===(e=t.find("content1").value)?t.quit():(t.handler&&t.handler(e),t.quit())}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("text",t.data.label),t.data.value&&(t.find("content1").value=t.data.value),t.data.type?$(t.find("content1")).attr("type",t.data.type):void 0},xtra:function(t){return $(t.find("content1")).keyup(function(e){if(13===e.which)return t.find("bt0").trigger()})}})}return M(e,c),e}(),this.OS.register("PromptDialog",b),p=function(t){function e(){e.__super__.constructor.call(this,"CalendarDialog",{tags:[{tag:"afx-calendar-view"}],width:300,height:230,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;return(e=t.find("content0").get("selectedDate"))?(t.handler&&t.handler(e),t.quit()):t.notify(__("Please select a date"))}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}]})}return M(e,c),e}(),this.OS.register("CalendarDialog",p),h=function(t){function e(){e.__super__.constructor.call(this,"ColorPickerDialog",{tags:[{tag:"afx-color-picker"},{tag:"div",att:'data-height="5"'}],width:313,height:250,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;return(e=t.find("content0").get("selectedColor"))?(t.handler&&t.handler(e),t.quit()):t.notify("Please select a color")}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}]})}return M(e,c),e}(),this.OS.register("ColorPickerDialog",h),_=function(t){function e(){e.__super__.constructor.call(this,"InfoDialog",{tags:[{tag:"afx-grid-view"}],width:250,height:300,resizable:!0,buttons:[{label:"__(Cancel)",onclick:function(t){return t.quit()}}],filldata:function(t){var e,n,r,i;if(t.data){for(e in r=[],n=t.data)i=n[e],r.push([{value:e},{value:i}]);return t.find("content0").set("rows",r)}}})}return M(e,c),e}(),this.OS.register("InfoDialog",_),x=function(t){function e(){e.__super__.constructor.call(this,"YesNoDialog",{tags:[{tag:"afx-label"}],width:300,height:100,resizable:!0,buttons:[{label:"__(Yes)",onclick:function(t){return t.handler&&t.handler(!0),t.quit()}},{label:"__(No)",onclick:function(t){return t.handler&&t.handler(!1),t.quit()}}],filldata:function(t){var e,n,r,i,o;if(t.data){for(e in n=t.find("content0"),i=[],r=t.data)o=r[e],i.push(n.set(e,o));return i}}})}return M(e,c),e}(),this.OS.register("YesNoDialog",x),w=function(t){function e(){e.__super__.constructor.call(this,"SelectionDialog",{tags:[{tag:"afx-list-view"}],width:250,height:300,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;if(e=t.find("content0").get("selected"))return t.handler&&t.handler(e),t.quit()}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("items",t.data)},xtra:function(t){return t.find("content0").set("onlistdbclick",function(e){return t.find("bt0").trigger()})}})}return M(e,c),e}(),this.OS.register("SelectionDialog",w),t=function(t){function e(){e.__super__.constructor.call(this,"AboutDialog")}return M(e,i),e.prototype.init=function(){return this.render("os://resources/schemes/about.html")},e.prototype.main=function(){var t,e,n,r,i;if(e=this.meta(),this.scheme.set("apptitle",__("About: {0}",e.name)),this.find("mylabel").set("*",{icon:e.icon,iconclass:e.iconclass,text:e.name+"(v"+e.version+")"}),$(this.find("mydesc")).html(e.description),e.info){for(t in r=[],n=e.info)i=n[t],r.push([{value:t},{value:i}]);return this.find("mygrid").set("rows",r)}},e}(),this.OS.register("AboutDialog",t),g=function(t){function e(){e.__super__.constructor.call(this,"FileDiaLog")}return M(e,i),e.prototype.init=function(){return this.render("os://resources/schemes/filedialog.html")},e.prototype.main=function(){var t,e,n,r,i,o;if(e=this.find("fileview"),r=this.find("location"),t=this.find("filename"),i=this,this.scheme.set("apptitle",this.title),e.set("fetch",function(t,e){if(t.child)return t.child.path.asFileHandler().read(function(n){return n.error?i.error(__("Resource not found: {0}",t.child.path)):e(n.result)})}),o=function(t){return t.asFileHandler().read(function(n){return n.error?i.error(__("Resource not found: {0}",t)):(e.set("path",t),e.set("data",n.result))})},this.data&&this.data.root?($(r).hide(),this.trigger("calibrate"),o(this.data.root)):(r.set("onlistselect",function(t){if(t&&t.data.path)return o(t.data.path)}),r.set("items",function(){var t,e,r,i;for(i=[],t=0,e=(r=this.systemsetting.VFS.mountpoints).length;t<e;t++)"app"!==(n=r[t]).type&&i.push(n);return i}.call(this)),r.get("selected")||r.set("selected",0)),e.set("onfileselect",function(e){if("file"===e.type)return $(t).val(e.filename)}),this.find("bt-ok").set("onbtclick",function(n){var r,o,a,s,u,c,l;if(!(o=e.get("selectedFile")))return i.notify(__("Please select a file/fofler"));if(i.data&&i.data.type&&i.data.type!==o.type)return i.notify(__("Please select {0} only",i.data.type));if(i.data&&i.data.mimes){if(u=!1,o.mime)for(a=0,s=(c=i.data.mimes).length;a<s;a++)if(l=c[a],o.mime.match(new RegExp(l,"g"))){u=!0;break}if(!u)return i.notify(__("Only {0} could be selected",i.data.mimes.join(",")))}return r=o.path,"file"===o.type&&(r=o.path.asFileHandler().parent()),i.handler&&i.handler(r,$(t).val(),o.path,o),i.quit()}),this.find("bt-cancel").set("onbtclick",function(t){return i.quit()}),this.data&&this.data.file&&($(t).css("display","block").val(this.data.file.basename||"Untitled"),this.trigger("resize")),this.data&&this.data.hidden)return e.set("showhidden",this.data.hidden)},e}(),this.OS.register("FileDiaLog",g),I=q.OS.GUI,P=q.OS.API,T=q.OS.PM,D=q.OS,C=q.OS.courrier,this.onload=function(){return $(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){return I.fullscreen=!I.fullscreen}),q.OS.boot()}}).call(this);