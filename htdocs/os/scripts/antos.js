(function(){"use strict";var t,e,n,i,o,a,s,u,c,l,p,h,f,g,m,y,v,_,b,S,w,F,k,O,A,x,I,P,V,D,T,H,C,q=function(t,e){for(var n in e)M.call(e,n)&&(t[n]=e[n]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},M={}.hasOwnProperty;(C=this).OS||(C.OS={API:{},GUI:{},APP:{},setting:{user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},courrier:{observable:riot.observable(),quota:0,listeners:{},on:function(t,e,n){return H.listeners[n.pid]||(H.listeners[n.pid]=[]),H.listeners[n.pid].push({e:t,f:e}),H.observable.on(t,e)},trigger:function(t,e){return H.observable.trigger(t,e)},osfail:function(t,e,n){return H.ostrigger("fail",{m:t,e:e,s:n})},oserror:function(t,e,n){return H.ostrigger("error",{m:t,e:e,s:n})},osinfo:function(t){return H.ostrigger("info",{m:t,e:null,s:null})},ostrigger:function(t,e){return H.trigger(t,{id:0,data:e,name:"OS"})},unregister:function(t){var e,n,r,i;if(H.listeners[t.pid]&&0<H.listeners[t.pid].length){for(n=0,r=(i=H.listeners[t.pid]).length;n<r;n++)e=i[n],H.observable.off(e.e,e.f);return delete H.listeners[t.pid]}},getMID:function(){return H.quota+=1,H.quota}},register:function(t,e){return 3===e.type?C.OS.GUI.subwindows[t]=e:V.APP[t]=e},PM:{pidalloc:0,processes:{},createProcess:function(e,i,n){var t,r,o;return t=function(){var t;if(i.singleton&&D.processes[e]&&1===D.processes[e].length?D.processes[e][0].show():(D.processes[e]||(D.processes[e]=[]),(t=new i(n)).birth=(new Date).getTime(),D.pidalloc++,t.pid=D.pidalloc,D.processes[e].push(t),1===i.type?P.dock(t,i.meta):P.attachservice(t)),2===i.type)return H.trigger("srvroutineready",e)},i.dependencies?(r=function(){var t,e,n,r;for(r=[],t=0,e=(n=i.dependencies).length;t<e;t++)o=n[t],r.push(o);return r}(),I.requires(r,t)):t()},appByPid:function(i){var t,e,n,r;for(n in t=void 0,e=function(t){var e,n,r;for(n=0,r=t.length;n<r;n++)if((e=t[n]).pid===i)return e},r=D.processes)if(t=e(r[n]))break;return t},kill:function(t){var e;if(t.name&&D.processes[t.name])return 0<=(e=D.processes[t.name].indexOf(t))?(1===V.APP[t.name].type?P.undock(t):P.detachservice(t),H.unregister(t),delete D.processes[t.name][e],D.processes[t.name].splice(e,1)):void 0},killAll:function(t,e){var n,r,i,o,a;if(D.processes[t]){for(a=[],r=0,i=(o=D.processes[t]).length;r<i;r++)n=o[r],a.push(n.quit(e));return a}}},cleanup:function(){var t,e;for(t in console.log("Clean up system"),e=D.processes)e[t],D.killAll(t,!0);return H.observable&&H.observable.off("*"),$(window).off("keydown"),$("#workspace").off("mouseover"),delete H.observable,$("#wrapper").empty(),P.clearTheme(),H.observable=riot.observable(),H.quota=0,V.APP={},V.setting={user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},D.processes={},D.pidalloc=0},boot:function(){return console.log("Booting sytem"),I.handler.auth(function(t){return t.error?P.login():P.startAntOS(t.result)})},cleanupHandlers:{},exit:function(){var t,e;for(t in e=V.cleanupHandlers)(0,e[t])();return I.handler.setting(function(t){return V.cleanup(),I.handler.logout()})},onexit:function(t,e){if(!C.OS.cleanupHandlers[t])return C.OS.cleanupHandlers[t]=e}}),m=function(){function t(t,e){var n,r,i;if(this.fs=t,this.values=[],e)for(n=r=0,i=e.length-1;0<=i?r<=i:i<=r;n=0<=i?++r:--r)this.values[n]=e[n]}return t.prototype.toString=function(){return this.__()},t.prototype.__=function(){var n;return(n=this).fs.l().replace(/{(\d+)}/g,function(t,e){return void 0!==n.values[e]?n.values[e].__():t})},t.prototype.hash=function(){return this.__().hash()},t.prototype.asBase64=function(){return this.__().asBase64()},t.prototype.unescape=function(){return this.__().unescape()},t.prototype.asUint8Array=function(){return this.__().asUint8Array()},t.prototype.format=function(){var t,e,n,r,i;for(i=[],e=n=0,r=(t=arguments).length-1;0<=r?n<=r:r<=n;e=0<=r?++n:--n)i.push(this.values[e]=t[e]);return i},t}(),A=function(){function t(t){var e,n,r;if(this.string=t,e=this.string.split("-"),n={r:3,b:2,a:1},this.branch=3,2===e.length&&n[e[1]]&&(this.branch=n[e[1]]),!(r=e[0].match(/\d+/g)))throw new Error(__("Version string is in invalid format: {0}",this.string));this.major=0,this.minor=0,this.patch=0,1<=r.length&&(this.major=Number(r[0])),2<=r.length&&(this.minor=Number(r[1])),3<=r.length&&(this.patch=Number(r[2]))}return t.prototype.compare=function(t){var e;return e=t.__v(),this.branch>e.branch?1:this.branch<e.branch?-1:this.major===e.major&&this.minor===e.minor&&this.patch===e.patch?0:this.major>e.major?1:this.major<e.major?-1:this.minor>e.minor?1:this.minor<e.minor?-1:this.patch>e.patch?1:-1},t.prototype.nt=function(t){return 1===this.compare(t)},t.prototype.ot=function(t){return-1===this.compare(t)},t.prototype.__v=function(){return this},t.prototype.toString=function(){return this.string},t}(),Object.defineProperty(Object.prototype,"__",{value:function(){return this.toString()},enumerable:!1,writable:!0}),String.prototype.hash=function(){var t,e;for(t=5381,e=this.length;e;)t=33*t^this.charCodeAt(--e);return t>>>0},String.prototype.__v=function(){return new A(this)},String.prototype.asBase64=function(){var t;return t=encodeURIComponent(this),btoa(t.replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}))},String.prototype.unescape=function(){return this.replace(/\\\\/g,"\\").replace(/\\"/g,'"').replace(/\\n/g,"\n").replace(/\\t/g,"\t").replace(/\\b/g,"\b").replace(/\\f/g,"\f").replace(/\\r/g,"\r")},String.prototype.asUint8Array=function(){var t,e,n,r;for(t=[],e=n=0,r=this.length-1;0<=r?n<=r:r<=n;e=0<=r?++n:--n)t.push(this.charCodeAt(e));return t=new Uint8Array(t)},String.prototype.format||(String.prototype.format=function(){var n;return n=arguments,this.replace(/{(\d+)}/g,function(t,e){return void 0!==n[e]?n[e].__():t})}),String.prototype.f=function(){return new m(this,arguments)},String.prototype.__=function(){var t;return(t=this.match(/^__\((.*)\)$/))?t[1].l():this},String.prototype.l=function(){var t;return(t=window.OS.API).lang[this]||(t.lang[this]=this),t.lang[this]},this.__=function(){var r,t,i;return window.OS.API,0<(r=arguments).length?((t=r[0]).l(),new m(t,function(){var t,e,n;for(n=[],i=t=1,e=r.length-1;1<=e?t<=e:e<=t;i=1<=e?++t:--t)n.push(r[i]);return n}())):"Undefined"},Date.prototype.toString=function(){var t,e,n,r,i,o;return t=this.getDate(),r=this.getMonth()+1,o=this.getFullYear(),t<10&&(t="0"+t),r<10&&(r="0"+r),(e=this.getHours())<10&&(e="0"+e),(n=this.getMinutes())<10&&(n="0"+n),(i=this.getSeconds())<10&&(i="0"+i),t+"/"+r+"/"+o+" "+e+":"+n+":"+i},Date.prototype.timestamp=function(){return this.getTime()/1e3|0},C.OS.API={handler:{},shared:{},searchHandler:{},lang:{},mid:function(){return H.getMID()},post:function(n,t,e,r){var i;return i=H.getMID(),I.loading(i,n),$.ajax({type:"POST",url:n,contentType:"application/json",data:JSON.stringify(t,{dataType:"json",success:null})}).done(function(t){return I.loaded(i,n,"OK"),e(t)}).fail(function(t,e){return I.loaded(i,n,"FAIL"),r(t,e)})},blob:function(e,n,r){var i,t;return i=H.getMID(),(t=new XMLHttpRequest).open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(t){return 200===this.status&&4===this.readyState?(n(this.response),I.loaded(i,e,"OK")):(r(t,this),I.loaded(i,e,"FAIL"))},I.loading(i,e),t.send()},upload:function(n,e,r,i){var o,a;return a=H.getMID(),(o=$("<input>").attr("type","file").css("display","none")).change(function(){var t;return I.loading(a,n),(t=new FormData).append("path",e),t.append("upload",o[0].files[0]),$.ajax({url:n,data:t,type:"POST",contentType:!1,processData:!1}).done(function(t){return I.loaded(a,n,"OK"),r(t),o.remove()}).fail(function(t,e){return I.loaded(a,n,"FAIL"),i(t,e),o.remove()})}),o.click()},saveblob:function(t,e){var n,r;return r=window.URL.createObjectURL(e),(n=$("<a>").attr("href",r).attr("download",t).css("display","none").appendTo("body"))[0].click(),window.URL.revokeObjectURL(r),n.remove()},systemConfig:function(){return I.request("config",function(t){return console.log(t)})},loading:function(t,e){return H.trigger("loading",{id:t,data:{m:""+e,s:!0},name:"OS"})},loaded:function(t,e,n){return H.trigger("loaded",{id:t,data:{m:n+": "+e,s:!1},name:"OS"})},get:function(n,e,r,t){var i,o;return i={type:"GET",url:n},t&&(i.dataType=t),o=H.getMID(),I.loading(o,n),$.ajax(i).done(function(t){return I.loaded(o,n,"OK"),e(t)}).fail(function(t,e){return I.loaded(o,n,"FAIL"),r(t,e)})},script:function(n,e,r){var i;return i=H.getMID(),I.loading(i,n),$.getScript(n).done(function(t){return I.loaded(i,n,"OK"),e(t)}).fail(function(t,e){return I.loaded(i,n,"FAIL"),r(t,e)})},resource:function(t,e,n){var r;return r="resources/"+t,I.get(r,e,n)},libready:function(t){return I.shared[t]||!1},require:function(n,i){var o,a;return I.shared[n]?(console.log(n,"Library exist, no need to load"),i&&i(),H.trigger("sharedlibraryloaded",n)):n.match(/^(https?:\/\/[^\s]+)/g)?I.script(n,function(){if(I.shared[n]=!0,H.trigger("sharedlibraryloaded",n),i)return i()},function(t,e){return H.oserror(__("Cannot load 3rd library at: {0}",n),t,r)}):(o=""+(a="os://scripts/")+n+".js").asFileHandler().onready(function(t){var e;if(I.shared[n]=!0,$("<script>",{src:I.handler.get+"/"+o}).appendTo("head"),(e=""+a+n+".css").asFileHandler().onready(function(t){return $("<link>",{rel:"stylesheet",type:"text/css",href:I.handler.get+"/"+e}).appendTo("head")},function(){}),console.log("loaded",n),H.trigger("sharedlibraryloaded",n),i)return i()})},requires:function(e,n){return 0<e.length?(H.observable.one("sharedlibraryloaded",function(t){return e.splice(0,1),I.requires(e,n)}),I.require(e[0],null)):n()},packages:{fetch:function(t){var n,r;return I.handler.packages({command:"list",args:{paths:function(){var t,e;for(n in e=[],t=V.setting.system.pkgpaths)r=t[n],e.push(r);return e}()}},t)},cache:function(t){var n,r;return I.handler.packages({command:"cache",args:{paths:function(){var t,e;for(n in e=[],t=V.setting.system.pkgpaths)r=t[n],e.push(r);return e}()}},t)}},setting:function(t){return I.handler.setting(t)},search:function(t){var e,n,r,i;for(e in n=[],r=I.searchHandler)r[e],0<(i=I.searchHandler[e](t)).length&&(i.unshift({text:e,class:"search-header",dataid:"header"}),n=n.concat(i));return n},onsearch:function(t,e){if(!C.OS.API.searchHandler[t])return C.OS.API.searchHandler[t]=e},setLocale:function(e,n){var r;return r="resources/languages/"+e+".json",I.get(r,function(t){return V.setting.system.locale=e,I.lang=t,n?n():H.trigger("systemlocalechange",e)},function(t,e){if(H.oserror(__("Language file {0} not found",r),t,e),n)return n()},"json")},throwe:function(t){var e;e=void 0;try{throw new Error(t)}catch(t){e=t}return e||""},switcher:function(){var t,e,n,r,i,o,a,s;for(i={},o={},e=n=0,a=arguments.length-1;0<=a?n<=a:a<=n;e=0<=a?++n:--n)o[arguments[e]]=!1;for(r in Object.defineProperty(i,"__p",{enumerable:!1,value:o}),t=function(r,i){return Object.defineProperty(r,i,{enumerable:!0,set:function(t){var e,n;for(e in n=this.__p)n[e],this.__p[e]=!1;return r.__p[i]=t},get:function(){return r.__p[i]}})},s=i.__p)s[r],t(i,r);return Object.defineProperty(i,"selected",{configurable:!0,enumerable:!1,get:function(){var t;for(r in t=i.__p)if(t[r])return r}}),i}},C.OS.systemSetting=function(t){return t.desktop&&(V.setting.desktop=t.desktop),t.applications&&(V.setting.applications=t.applications),t.appearance&&(V.setting.appearance=t.appearance),V.setting.appearance.wp||(V.setting.appearance.wp={url:"os://resources/themes/system/wp/wp2.jpg",size:"cover",repeat:"repeat"}),V.setting.appearance.wps||(V.setting.appearance.wps=[]),V.setting.user=t.user,t.VFS&&(V.setting.VFS=t.VFS),V.setting.desktop.path||(V.setting.desktop.path="home://.desktop"),V.setting.desktop.menu||(V.setting.desktop.menu={}),V.setting.VFS.mountpoints||(V.setting.VFS.mountpoints=[{text:"__(Applications)",path:"app://",iconclass:"fa  fa-adn",type:"app"},{text:"__(Home)",path:"home://",iconclass:"fa fa-home",type:"fs"},{text:"__(Desktop)",path:V.setting.desktop.path,iconclass:"fa fa-desktop",type:"fs"},{text:"__(OS)",path:"os://",iconclass:"fa fa-inbox",type:"fs"},{text:"__(Google Drive)",path:"gdv://",iconclass:"fa fa-inbox",type:"fs"},{text:"__(Shared)",path:"shared://",iconclass:"fa fa-share-square",type:"fs"}]),t.system&&(V.setting.system=t.system),V.setting.system.startup||(V.setting.system.startup={services:["CoreServices/PushNotification","CoreServices/UserService","CoreServices/Calendar","CoreServices/Spotlight"],apps:[]}),V.setting.system.pkgpaths||(V.setting.system.pkgpaths={user:"home://.packages",system:"os://packages"}),V.setting.system.locale||(V.setting.system.locale="en_GB"),V.setting.system.menu||(V.setting.system.menu={}),V.setting.system.repositories||(V.setting.system.repositories=[]),V.setting.appearance.theme||(V.setting.appearance.theme="antos"),V.setting.VFS.gdrive||(V.setting.VFS.gdrive={CLIENT_ID:"",API_KEY:"",apilink:"https://apis.google.com/js/api.js",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES:"https://www.googleapis.com/auth/drive"}),I.onsearch("__(Applications)",function(t){var e,n,r,i,o,a,s,u,c,l,p,h;for(i in e=[],l=new RegExp(t,"i"),u=V.setting.system.packages)if((p=u[i]).app)if(p.name.match(l)||p.description&&p.description.match(l)){for(o in h={},p)n=p[o],"selected"!==o&&(h[o]=n);h.detail=[{text:h.path}],h.complex=!0,e.push(h)}else if(p.mimes)for(r=0,a=(c=p.mimes).length;r<a;r++)if(s=c[r],t.match(new RegExp(s,"g"))){for(o in h={},p)n=p[o],"selected"!==o&&(h[o]=p[o]);h.detail=[{text:h.path}],h.complex=!0,e.push(h);break}return e})},C.OS.API.HOST=C.location.hostname+(C.location.port?":"+C.location.port:""),C.OS.API.REST=C.location.protocol+"//"+C.OS.API.HOST,C.OS.API.TERMURI="wss://lxsang.me/wterm",T=C.OS.API.REST,C.OS.API.handler={get:T+"/VFS/get",shared:T+"/VFS/shared",scandir:function(n,t){var e;return e=T+"/VFS/scandir",I.post(e,{path:n},t,function(t,e){return H.osfail(__("Fail to scan directory: {0}",n),t,e)})},mkdir:function(n,t){var e;return e=T+"/VFS/mkdir",I.post(e,{path:n},t,function(t,e){return H.osfail(__("Fail to create directory: {0}",n),t,e)})},sharefile:function(n,t,e){var r;return r=T+"/VFS/publish",I.post(r,{path:n,publish:t},e,function(t,e){return H.osfail(__("Fail to publish file: {0}",n),t,e)})},fileinfo:function(n,t){var e;return e=T+"/VFS/fileinfo",I.post(e,{path:n},t,function(t,e){return H.osfail(__("Fail to get file meta data: {0}",n),t,e)})},readfile:function(n,t,e){var r;return r=T+"/VFS/get/",I.get(r+n,t,function(t,e){return H.osfail(__("Fail to read file: {0}",n),t,e)},e)},move:function(t,n,e){var r;return r=T+"/VFS/move",I.post(r,{src:t,dest:n},e,function(t,e){return H.osfail(__("Fail to move file: {0} -> {1}",e,n),t,e)})},delete:function(n,t){var e;return e=T+"/VFS/delete",I.post(e,{path:n},t,function(t,e){return H.osfail(__("Fail to delete: {0}",n),t,e)})},fileblob:function(n,t){var e;return e=T+"/VFS/get/",I.blob(e+n,t,function(t,e){return H.osfail("Fail to read file: "+n,t,e)})},packages:function(n,t){var e;return e=T+"/system/packages",I.post(e,n,t,function(t,e){return H.osfail(__("Fail to {0} package",n.command),t,e)})},upload:function(n,t){var e;return e=T+"/VFS/upload",I.upload(e,n,t,function(t,e){return H.osfail(__("Fail to upload file to: {0}",n),t,e)})},write:function(n,t,e){var r;return r=T+"/VFS/write",I.post(r,{path:n,data:t},e,function(t,e){return H.osfail(__("Fail to write to file: {0}",n),t,e)})},scanapp:function(t,e){return T+"/system/application"},auth:function(t){var n;return n=T+"/user/auth",I.post(n,{},t,function(t,e){return console.log(t,e),alert(__("Resource not found: {0}",n))})},login:function(t,e){var n;return n=T+"/user/login",I.post(n,t,e,function(){return alert(__("Resource not found: {0}",n))})},logout:function(){var t;return t=T+"/user/logout",I.post(t,{},function(t){return V.boot()},function(){return alert(__("Resource not found: {0}",t))})},setting:function(r){var i;return i=T+"/system/settings",I.post(i,V.setting,function(t){if(t.error&&H.oserror(__("Cannot save system setting"),t.error),r)return r(t)},function(t,e){var n;if(n=__("Fail to make request: {0}",i),H.osfail(n,t,e),r)return r({error:n})})},dbquery:function(t,e,n){var r;return r=T+"/VDB/"+t,I.post(r,e,n,function(t,e){return H.osfail(__("Fail to query data from database: {0}",r),t,e)})}},String.prototype.asFileHandler=function(){var t,e;return e=this.split("://"),(t=I.VFS.findHandlers(e[0]))&&0!==t.length?new t[0](this):(H.osfail(__("VFS unknown handler: {0}",this),I.throwe("OS.VFS"),this),null)},this.OS.API.VFS={handlers:{},register:function(t,e){return C.OS.API.VFS.handlers[t]=e},findHandlers:function(n){var r,i;return function(){var t,e;for(r in e=[],t=I.VFS.handlers)i=t[r],n.trim().match(new RegExp(r,"g"))&&e.push(i);return e}()}},a=function(){function t(t){this.dirty=!1,this.cache=void 0,this.setPath(t)}return t.prototype.setPath=function(t){var e,n;if(this.ready=!1,t&&(this.path=t.toString(),e=this.path.split("://"),this.protocol=e[0],1<e.length&&""!==(n=e[1].replace(/^\/+|\/+$/g,""))))return this.genealogy=n.split("/"),this.isRoot()||(this.basename=this.genealogy[this.genealogy.length-1]),0!==this.basename.lastIndexOf(".")&&-1!==this.basename.indexOf(".")?this.ext=this.basename.split(".").pop():void 0},t.prototype.asFileHandler=function(){return this},t.prototype.isRoot=function(){return!this.genealogy||0===this.genealogy.size},t.prototype.child=function(t){return this.isRoot()?this.path+t:this.path+"/"+t},t.prototype.isHidden=function(){return!!this.basename&&"."===this.basename[0]},t.prototype.hash=function(){return this.path?this.path.hash():-1},t.prototype.sendB64=function(t,e){var n,r,i,o;return r="object"===t?"text/plain":t,(i=this).cache?"object"===t||"string"==typeof this.cache?(n="object"===t?JSON.stringify(this.cache).asBase64():this.cache.asBase64(),e(n="data:"+r+";base64,"+n)):((o=new FileReader).readAsDataURL(this.cache),o.onload=function(){return e(o.result)},o.onerror=function(t){return H.osfail(__("VFS Cannot encode file: {0}",i.path),I.throwe("OS.VFS"),t)}):e("")},t.prototype.parent=function(){return this.isRoot()?this:this.protocol+"://"+this.genealogy.slice(0,this.genealogy.length-1).join("/")},t.prototype.onready=function(e,n){var r;return this.ready?e():(r=this).meta(function(t){return t.error?n?n(t):H.osfail(r.path+": "+t.error,I.throwe("OS.VFS"),t.error):(r.info=t.result,r.ready=!0,e())})},t.prototype.read=function(t,e){var n;return(n=this).onready(function(){return n.action("read",e,t)})},t.prototype.write=function(t,e){var n;return(n=this).action("write",t,function(t){return t.result&&H.ostrigger("VFS",{m:"write",file:n}),e(t)})},t.prototype.mk=function(t,e){var n;return(n=this).onready(function(){return n.action("mk",t,function(t){return t.result&&H.ostrigger("VFS",{m:"mk",file:n}),e(t)})})},t.prototype.remove=function(e){var n;return(n=this).onready(function(){return n.action("remove",null,function(t){return t.result&&H.ostrigger("VFS",{m:"remove",file:n}),e(t)})})},t.prototype.upload=function(e){var n;return(n=this).onready(function(){return n.action("upload",null,function(t){return t.result&&H.ostrigger("VFS",{m:"upload",file:n}),e(t)})})},t.prototype.publish=function(e){var n;return(n=this).onready(function(){return n.action("publish",null,function(t){return t.result&&H.ostrigger("VFS",{m:"publish",file:n}),e(t)})})},t.prototype.download=function(t){var e;return(e=this).onready(function(){return e.action("download",null,t)})},t.prototype.move=function(e,n){var t;return(t=this).onready(function(){return t.action("move",e,function(t){return t.result&&H.ostrigger("VFS",{m:"move",file:e.asFileHandler()}),n(t)})})},t.prototype.execute=function(t){var e;return(e=this).onready(function(){return e.action("execute",null,t)})},t.prototype.meta=function(t){},t.prototype.getlink=function(){return this.path},t.prototype.action=function(t,e,n){return H.osfail(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)},t}(),C.OS.API.VFS.BaseFileHandler=a,S=function(t){function e(t){e.__super__.constructor.call(this,t)}return q(e,t),e.prototype.meta=function(t){return I.handler.fileinfo(this.path,t)},e.prototype.getlink=function(){return I.handler.get+"/"+this.path},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return"dir"===this.info.type?I.handler.scandir(this.path,n):"binary"===e?I.handler.fileblob(this.path,n):I.handler.readfile(this.path,n,e||"text");case"mk":return"file"===this.info.type?n({error:__("{0} is not a directory",this.path)}):I.handler.mkdir(this.path+"/"+e,n);case"write":return"base64"===e?I.handler.write(r.path,r.cache,n):this.sendB64(e,function(t){return I.handler.write(r.path,t,n)});case"upload":if("file"===this.info.type)return;return I.handler.upload(this.path,n);case"remove":return I.handler.delete(this.path,n);case"publish":return I.handler.sharefile(this.path,!0,n);case"download":if("dir"===this.info.type)return;return I.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),I.saveblob(r.basename,e)});case"move":return I.handler.move(this.path,e,n);default:return H.osfail(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)}},e}(C.OS.API.VFS.BaseFileHandler),C.OS.API.VFS.register("^(home|desktop|os|Untitled)$",S),e=function(t){function e(t){e.__super__.constructor.call(this,t),this.basename&&(this.info=V.setting.system.packages[this.basename]),this.ready=!0}return q(e,t),e.prototype.meta=function(t){return t()},e.prototype.action=function(t,e,n){var r,i;switch(this,t){case"read":if(this.info)return n({result:this.info});if(!this.isRoot())return;return n({result:function(){var t,e;for(r in e=[],t=V.setting.system.packages)i=t[r],e.push(i);return e}()});case"mk":case"write":case"upload":case"remove":case"publish":case"download":case"move":break;default:return H.osfail(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)}},e}(C.OS.API.VFS.BaseFileHandler),C.OS.API.VFS.register("^app$",e),l=function(t){function r(t,e,n){r.__super__.constructor.call(this,t),n&&(this.cache=n),this.info={mime:e,path:t,size:n?n.length:0,name:this.basename,type:"file"}}return q(r,t),r.prototype.meta=function(t){return t()},r.prototype.onchange=function(t){return this.onchange=t},r.prototype.action=function(t,e,n){var r;switch(this,t){case"read":return n({result:this.cache});case"mk":break;case"write":return this.cache=e,this.onchange&&this.onchange(this),n({result:!0});case"upload":case"remove":case"publish":break;case"download":return r=new Blob([this.cache],{type:"octet/stream"}),I.saveblob(this.basename,r);case"move":break;default:return H.osfail(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)}},r}(C.OS.API.VFS.BaseFileHandler),C.OS.API.VFS.register("^mem$",l),O=function(t){function e(t){e.__super__.constructor.call(this,t),this.ready=!0}return q(e,t),e.prototype.meta=function(t){return t({result:!0})},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return I.get(this.path,function(t){return n(t)},function(t,e){return H.oserror(__("VFS cannot read : {0}",r.path),t,e)},e||"text");default:return H.oserror(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)}},e}(C.OS.API.VFS.BaseFileHandler),C.OS.API.VFS.register("^(http|https)$",O),F=function(t){function e(t){e.__super__.constructor.call(this,t),this.isRoot()&&(this.ready=!0)}return q(e,t),e.prototype.meta=function(t){return I.handler.fileinfo(this.path,t)},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return this.isRoot()?I.get(I.handler.shared+"/all",n,function(t,e){}):"binary"===e?I.handler.fileblob(this.path,n):I.handler.readfile(this.path,n,e||"text");case"mk":break;case"write":return I.handler.write(this.path,e,n);case"remove":return I.handler.sharefile(this.basename,!1,n);case"upload":break;case"publish":return n({result:this.basename});case"download":if("dir"===this.info.type)return;return I.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),I.saveblob(r.basename,e)});case"move":break;default:return H.osfail(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)}},e}(C.OS.API.VFS.BaseFileHandler),C.OS.API.VFS.register("^shared$",F),y={"gdv://":{id:"root",mime:"dir"}},v=function(t){function e(t){if(e.__super__.constructor.call(this,t),this.setting=V.setting.VFS.gdrive,!this.setting)return H.oserror(__("Unknown API setting for {0}","GAPI"),I.throwe("OS.VFS"),null);this.isRoot()&&(this.gid="root"),this.cache=""}return q(e,t),e.prototype.oninit=function(e){var n,t;if((t=this).setting)return n=function(t){return t?e():(y={"gdv://":{id:"root",mime:"dir"}},gapi.auth2.getAuthInstance().signIn())},I.libready(this.setting.apilink)?(gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return n(t)}),n(gapi.auth2.getAuthInstance().isSignedIn.get())):I.require(this.setting.apilink,function(){var e;return e=H.getMID(),gapi.load("client:auth2",function(){return I.loading(e,"GAPI"),gapi.client.init({apiKey:t.setting.API_KEY,clientId:t.setting.CLIENT_ID,discoveryDocs:t.setting.DISCOVERY_DOCS,scope:t.setting.SCOPES}).then(function(){return I.loaded(e,"OK"),gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return n(t)}),P.openDialog("YesNoDialog",function(t){return t?n(gapi.auth2.getAuthInstance().isSignedIn.get()):H.osinfo(__("User abort the authentication"))},__("Authentication"),{text:__("Would you like to login to {0}?","Google Drive")})}).catch(function(t){return I.loaded(e,"FAIL"),H.oserror(__("VFS cannot init {0}: {1}","GAPI",t.error),I.throwe("OS.VFS"),t)})})})},e.prototype.meta=function(i){var o;return(o=this).oninit(function(){var r,e;return e=H.getMID(),y[o.path]&&(o.gid=y[o.path].id),o.gid?(I.loading(e,"GAPI"),gapi.client.drive.files.get({fileId:o.gid,fields:o.fields()}).then(function(t){if(I.loaded(e,"OK"),t.result)return t.result.mime=t.result.mimeType,i(t)}).catch(function(t){return I.loaded(e,"FAIL"),H.oserror(__("VFS cannot get meta data for {0}",o.gid),I.throwe("OS.VFS"),t)})):(r=o.parent().asFileHandler()).meta(function(t){var e,n;return e=t.result,n=H.getMID(),I.loading(n,"GAPI"),y[r.path]={id:e.id,mime:e.mimeType},gapi.client.drive.files.list({q:"name = '"+o.basename+"' and '"+e.id+"' in parents and trashed = false",fields:"files("+o.fields()+")"}).then(function(t){if(I.loaded(n,"OK"),t.result.files&&0<t.result.files.length)return y[o.path]={id:t.result.files[0].id,mime:t.result.files[0].mimeType},t.result.files[0].mime=t.result.files[0].mimeType,i({result:t.result.files[0]})}).catch(function(t){return I.loaded(n,"FAIL"),H.oserror(__("VFS cannot get meta data for {0}",o.path),I.throwe("OS.VFS"),t)})})})},e.prototype.fields=function(){return"webContentLink, id, name,mimeType,description, kind, parents, properties, iconLink, createdTime, modifiedTime, owners, permissions, fullFileExtension, fileExtension, size"},e.prototype.isFolder=function(){return"application/vnd.google-apps.folder"===this.info.mimeType},e.prototype.save=function(t,e,n){var r,i,o,a,s,u;return i=this,o=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,a=H.getMID(),s="https://www.googleapis.com/upload/drive/v3/files/"+t+"?uploadType=media",(u=new XMLHttpRequest).open("PATCH",s),u.setRequestHeader("Authorization","Bearer "+o),u.setRequestHeader("Content-Type",e),u.setRequestHeader("Content-Encoding","base64"),u.setRequestHeader("Content-Transfer-Encoding","base64"),I.loading(a,"GAPI"),r=function(t,e){return I.loaded(a,"FAIL"),H.oserror(__("VFS cannot save : {0}",i.path),t,e)},u.onreadystatechange=function(){if(4===u.readyState)return 200===u.status?(I.loaded(a,"OK"),n({result:JSON.parse(u.responseText)})):r(u,u.status)},u.onerror=function(){return r(u,u.status)},"base64"===e?u.send(i.cache.replace(/^data:[^;]+;base64,/g,"")):this.sendB64(e,function(t){return u.send(t.replace(/^data:[^;]+;base64,/g,""))})},e.prototype.getlink=function(){if(this.ready)return this.info.webContentLink},e.prototype.action=function(t,e,o){var n,r,i,a,s,u,c;switch(a=this,c=H.getMID(),I.loading(c,"GAPI"),t){case"read":if(!this.info.id)return;return this.isFolder()?gapi.client.drive.files.list({q:"'"+a.info.id+"' in parents and trashed = false",fields:"files("+a.fields()+")"}).then(function(t){var e,n,r,i;if(I.loaded(c,"OK"),t.result.files){for(n=0,r=(i=t.result.files).length;n<r;n++)(e=i[n]).path=a.child(e.name),e.mime=e.mimeType,e.filename=e.name,e.type="file",e.gid=e.id,"application/vnd.google-apps.folder"===e.mimeType&&(e.mime="dir",e.type="dir",e.size=0),y[e.path]={id:e.gid,mime:e.mime};return o({result:t.result.files})}}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot read : {0}",a.path),I.throwe("OS.VFS"),t)}):gapi.client.drive.files.get({fileId:a.info.id,alt:"media"}).then(function(t){return I.loaded(c,"OK"),o("binary"!==e?t.body:t.body.asUint8Array())}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot read : {0}",a.path),I.throwe("OS.VFS"),t)});case"mk":if(!this.isFolder())return o({error:__("{0} is not a directory",this.path)});s={name:e,parents:[this.info.id],mimeType:"application/vnd.google-apps.folder"},gapi.client.drive.files.create({resource:s,fields:"id"}).then(function(t){return I.loaded(c,"OK"),t&&t.result?(y[a.child(e)]={id:t.result.id,mime:"dir"},o(t)):H.oserror(__("VFS cannot create : {0}",e),I.throwe("OS.VFS"),t)}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot create : {0}",e),I.throwe("OS.VFS"),t)});break;case"write":return i=void 0,y[a.path]&&(i=y[a.path].id),i?(I.loaded(c,"OK"),this.save(i,e,o)):(r=this.parent().asFileHandler()).onready(function(){return s={name:a.basename,mimeType:e,parents:[r.info.id]},gapi.client.drive.files.create({resource:s,fields:"id"}).then(function(t){return I.loaded(c,"OK"),t&&t.result?(y[a.path]={id:t.result.id,mime:e},a.save(t.result.id,e,o)):H.oserror(__("VFS cannot write : {0}",a.path),I.throwe("OS.VFS"),t)}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot write : {0}",a.path),I.throwe("OS.VFS"),t)})});case"upload":if(!this.isFolder())return;return u=$("<input>").attr("type","file").css("display","none"),I.loaded(c,"OK"),u.change(function(){var t,e;return e=u[0].files[0],(t=a.child(e.name).asFileHandler()).cache=e,t.write(e.type,o),u.remove()}),u.click();case"remove":if(!this.info.id)return;return gapi.client.drive.files.delete({fileId:a.info.id}).then(function(t){return I.loaded(c,"OK"),t?(y[a.path]=null,o({result:!0})):H.oserror(__("VFS cannot delete : {0}",a.path),I.throwe("OS.VFS"),t)}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot delete : {0}",a.path),I.throwe("OS.VFS"),t)});case"publish":I.loaded(c,"OK");break;case"download":return gapi.client.drive.files.get({fileId:a.info.id,alt:"media"}).then(function(t){var e,n,r,i,o;if(I.loaded(c,"OK"),!t.body)return H.oserror(__("VFS cannot download file : {0}",a.path),I.throwe("OS.VFS"),t);for(n=[],r=i=0,o=t.body.length-1;0<=o?i<=o:o<=i;r=0<=o?++i:--i)n.push(t.body.charCodeAt(r));return n=new Uint8Array(n),e=new Blob([n],{type:"octet/stream"}),I.saveblob(a.basename,e)}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot download file : {0}",a.path),I.throwe("OS.VFS"),t)});case"move":return(n=e.asFileHandler().parent().asFileHandler()).onready(function(){var t;return t=a.info.parents.join(","),gapi.client.drive.files.update({fileId:a.info.id,addParents:n.info.id,removeParents:t,fields:"id"}).then(function(t){return I.loaded(c,"OK"),t?o(t):H.oserror(__("VFS cannot move : {0}",a.path),I.throwe("OS.VFS"),t)}).catch(function(t){return I.loaded(c,"FAIL"),H.oserror(__("VFS cannot move : {0}",a.gid),I.throwe("OS.VFS"),t)})},function(t){return I.loaded(c,"FAIL")});default:return I.loaded(c,"FAIL"),H.osfail(__("VFS unknown action: {0}",t),I.throwe("OS.VFS"),t)}},e}(this.OS.API.VFS.BaseFileHandler),C.OS.API.VFS.register("^gdv$",v),C.OS.API.onsearch("Google Drive",function(t){var e,n,r,i,o;for(r in e=[],i=new RegExp(t,"i"),y)o=y[r],(r.match(i)||o&&o.mime.match(i))&&((n=r.asFileHandler()).text=n.basename,n.mime=o.mime,n.iconclass="fa fa-file","dir"===n.mime&&(n.iconclass="fa fa-folder"),n.complex=!0,n.detail=[{text:n.path}],e.push(n));return e}),C.OS.onexit("cleanUpGoogleDrive",function(){var t;if(y={"gdv://":{id:"root",mime:"dir"}},V.setting.VFS.gdrive&&I.libready(V.setting.VFS.gdrive.apilink)&&(t=gapi.auth2.getAuthInstance()))return t.isSignedIn.get()?$("<iframe/>",{src:"https://www.google.com/accounts/Logout",frameborder:0,onload:function(){return t.disconnect()}}):void 0}),f=function(){function t(t){this.table=t}return t.prototype.save=function(t,e){return I.handler.dbquery("save",{table:this.table,data:t},e)},t.prototype.delete=function(t,e){var n;return n={table:this.table},t&&""!==t?(isNaN(t)?n.cond=t:n.id=t,I.handler.dbquery("delete",n,e)):H.oserror(__("VDB Unknown condition for delete command"),I.throwe("OS.DB"),t)},t.prototype.get=function(t,e){return I.handler.dbquery("get",{table:this.table,id:t},e)},t.prototype.find=function(t,e){return I.handler.dbquery("select",{table:this.table,cond:t},e)},t}(),C.OS.API.DB=f,C.OS.GUI={subwindows:new Object,dialog:void 0,fullscreen:!1,shortcut:{ALT:{},CTRL:{},SHIFT:{},META:{}},SYS_MENU:[{text:"",iconclass:"fa fa-eercast",dataid:"sys-menu-root",child:[{text:"__(Applications)",child:[],dataid:"sys-apps",iconclass:"fa fa-adn",onmenuselect:function(t){return P.launch(t.item.data.app)}}],onmenuselect:function(t){return"sys-logout"===t.item.data.dataid?V.exit():"os-fullsize"===t.item.data.dataid?P.toggleFullscreen():t.item.data.dataid?void 0:P.launch(t.item.data.app)}}],htmlToScheme:function(t,e,n){var r;return r=$.parseHTML(t),e.scheme&&$(e.scheme).remove(),$(n).append(r),e.scheme=r[0],riot.mount($(r),{observable:e.observable}),e.main(),e.show()},loadScheme:function(t,e,n){return t.asFileHandler().read(function(t){return t?P.htmlToScheme(t,e,n):null})},clearTheme:function(){return $("head link#ostheme").attr("href","")},loadTheme:function(t,e){var n;return e&&P.clearTheme(),n="resources/themes/"+t+"/"+t+".css",$("head link#ostheme").attr("href",n)},pushServices:function(t){if(0<t.length)return H.observable.one("srvroutineready",function(){return t.splice(0,1),P.pushServices(t)}),P.pushService(t[0])},openDialog:function(t,e,n,r){var i;if(!P.dialog)return P.subwindows[t]?(P.dialog=new P.subwindows[t],(P.dialog.parent=P).dialog.handler=e,P.dialog.pid=-1,P.dialog.data=r,P.dialog.title=n,P.dialog.init()):(i=I.throwe("Dialog"),H.oserror(__("Dialog {0} not found",t),i,null));P.dialog.show()},pushService:function(t){var e,n,r;return n=t.split("/"),r=n[1],e=n[0],V.APP[r]?D.createProcess(r,V.APP[r]):P.loadApp(e,function(t){if(V.APP[r])return D.createProcess(r,V.APP[r])},function(t,e){return H.trigger("srvroutineready",r),H.osfail(__("Cannot read service script: {0}",r),t,e)})},appsByMime:function(r){var i,t,e,n,o,a,s,u,c,l;for(u=function(){var t,e;for(o in e=[],t=V.setting.system.packages)(l=t[o])&&l.app&&e.push(l);return e}(),c=function(){var t,e,n;for(n=[],t=0,e=u.length;t<e;t++)(s=u[t])&&n.push(s.mimes);return n}(),i=[],t=function(t,n){var e;try{return t.filter(function(t,e){return r.match(new RegExp(t,"g"))&&(0<=i.indexOf(u[n])||i.push(u[n])),!1})}catch(t){return e=t,H.osfail(__("Error find app by mimes {0}",r),e,r)}},e=n=0,a=c.length;n<a;e=++n)(s=c[e])&&t(s,e);return i},appsWithServices:function(){var t,e,n,r;for(t in e={},n=V.setting.system.packages)(r=n[t])&&r.services&&0<r.services.length&&(e[t]=r);return e},openWith:function(e){var r,i,t;if(e)return"app"===e.type&&e.app?P.launch(e.app):"app"===e.type?H.osinfo(__("Application {0} is not executable",e.text)):0===(r=P.appsByMime("dir"===e.type?"dir":e.mime)).length?H.osinfo(__("No application available to open {0}",e.filename)):1===r.length?P.launch(r[0].app,[e.path]):(t=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)i=r[t],n.push({text:i.app,icon:i.icon,iconclass:i.iconclass});return n}(),P.openDialog("SelectionDialog",function(t){return P.launch(t.text,[e.path])},__("Open with"),t))},forceLaunch:function(t,e){return console.warn("This method is used for developing only, please use the launch method instead"),P.unloadApp(t),P.launch(t,e)},unloadApp:function(t){return D.killAll(t,!0),V.APP[t]&&V.APP[t].style&&$(V.APP[t].style).remove(),delete V.APP[t]},loadApp:function(a,s,t){var u;return u="os://packages/"+a,V.setting.system.packages[a].path&&(u=V.setting.system.packages[a].path),(u+"/main.js").asFileHandler().read(function(t){return(u+"/package.json").asFileHandler().read(function(t){var r,e,n,i,o;if(t.path=u,V.APP[a]&&(V.APP[a].meta=t),t.services)for(e=0,n=(i=t.services).length;e<n;e++)o=i[e],V.APP[o].meta=t;return(r=u+"/main.css").asFileHandler().onready(function(t){var e,n;return n=(new Date).timestamp(),e=$("<link>",{rel:"stylesheet",type:"text/css",href:I.handler.get+"/"+r+"?stamp="+n}).appendTo("head"),V.APP[a]&&(V.APP[a].style=e[0]),s(a)},function(){return s(a)})},"json")},"script")},launch:function(t,e){return V.APP[t]?V.APP[t]?D.createProcess(t,V.APP[t],e):void 0:P.loadApp(t,function(t){return D.createProcess(t,V.APP[t],e)},function(t,e){})},dock:function(e,t){var n,r;return n={icon:null,iconclass:t.iconclass||"",app:e,onbtclick:function(){return e.toggle()}},t.icon&&(n.icon=t.path+"/"+t.icon),t.icon||t.iconclass||(n.iconclass="fa fa-cogs"),r=$("#sysdock"),e.init(),e.one("rendered",function(){return r.get(0).newapp(n),e.sysdock=r.get(0),e.appmenu=$("[data-id = 'appmenu']","#syspanel")[0],e.subscribe("systemlocalechange",function(t){return e.update()}),e.subscribe("appregistry",function(t){if(t.name===e.name)return e.applySetting(t.data.m)})})},toggleFullscreen:function(){var t;if(t=$("body")[0],P.fullscreen){if(document.exitFullscreen)return document.exitFullscreen();if(document.mozCancelFullScreen)return document.mozCancelFullScreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen();if(document.cancelFullScreen)return document.cancelFullScreen()}else{if(t.requestFullscreen)return t.requestFullscreen();if(t.mozRequestFullScreen)return t.mozRequestFullScreen();if(t.webkitRequestFullscreen)return t.webkitRequestFullscreen();if(t.msRequestFullscreen)return t.msRequestFullscreen()}},undock:function(t){return $("#sysdock").get(0).removeapp(t)},attachservice:function(e){return $("#syspanel")[0].attachservice(e),e.init(),e.subscribe("systemlocalechange",function(t){return e.update()})},detachservice:function(t){return $("#syspanel")[0].detachservice(t)},bindContextMenu:function(n){var r;return(r=function(t){var e;return t.contextmenuHandler?t.contextmenuHandler(n,$("#contextmenu")[0]):(e=$(t).parent().get(0))!==$("#workspace").get(0)?r(e):void 0})(n.target),n.preventDefault()},bindKey:function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),P.shortcut[i]))return P.shortcut[i][r]=e},wallpaper:function(t){var e;return t&&(V.setting.appearance.wp=t),e=V.setting.appearance.wp,$("body").css("background-image","url("+I.handler.get+"/"+e.url+")").css("background-size",e.size).css("background-repeat",e.repeat)},showTooltip:function(e,t,n){var r,i,o,a,s,u,c,l;switch(e=e[0],o=$("#systooltip")[0],$("#workspace").on("mousemove",function(t){if(0===$(t.target).closest(e).length)return $(o).hide(),$("#workspace").off("mousemove")}),1<(r=(u=t).split(/:(.+)/)).length&&(u=r[1]),s=$(e).offset(),l=$(e).width(),i=$(e).height(),o.set("text",u),$(o).show(),r[0]){case"cr":return a=s.left+l+5,c=s.top+i/2-$(o).height()/2,$(o).css("top",c+"px").css("left",a+"px");default:if(!n)return;return $(o).css("top",n.clientY+5+"px").css("left",n.clientX+5+"px")}},initDM:function(){return I.resource("schemes/dm.html",function(t){var o,r,e;return t?(e=$.parseHTML(t),$("#wrapper").append(e),H.observable.one("sysdockloaded",function(){return $(window).bind("keydown",function(t){var e,n,r,i;if((r=$("#sysdock")[0])&&(e=r.get("selectedApp"),n=String.fromCharCode(t.which).toUpperCase(),i=void 0,t.ctrlKey?i="CTRL":t.metaKey?i="META":t.shiftKey?i="SHIFT":t.altKey&&(i="ALT"),i)){if(!(!e||e.shortcut(i,n,t)))return t.preventDefault();if(P.shortcut[i]&&P.shortcut[i][n])return P.shortcut[i][n](t),t.preventDefault()}})}),riot.mount($("#syspanel",$("#wrapper"))),riot.mount($("#sysdock",$("#workspace")),{items:[]}),riot.mount($("#systooltip",$("#wrapper"))),riot.mount($("#contextmenu",$("#wrapper"))),$("#workspace").contextmenu(function(t){return P.bindContextMenu(t)}),$("#workspace").mouseover(function(t){var e;if(0<(e=$(t.target).closest("[tooltip]")).length)return P.showTooltip(e,$(e).attr("tooltip"),t)}),o=$("#desktop"),r=V.setting.desktop.path.asFileHandler(),o[0].fetch=function(){var n;return n=function(){return(r=V.setting.desktop.path.asFileHandler()).read(function(t){var n;return t.error?H.osfail(t.error,I.throwe("OS.VFS"),t.error):(n=[],$.each(t.result,function(t,e){if("."!==e.filename[0]||V.setting.desktop.showhidden)return e.text=e.filename,e.iconclass=e.type,n.push(e)}),o[0].set("items",n),o[0].refresh())})},r.onready(function(){return n()},function(t){var e;return console.log(r.path+" not found"),e=r.basename,r.parent().asFileHandler().mk(e,function(t){var e;return e=I.throwe("OS.VFS"),t.error?H.osfail(d.error,e,d.error):n()})})},o[0].ready=function(t){return t.observable=H,window.onresize=function(){return H.trigger("desktopresize"),t.refresh()},o[0].set("onlistselect",function(t){return $("#sysdock").get(0).set("selectedApp",null)}),o[0].set("onlistdbclick",function(t){var e;return $("#sysdock").get(0).set("selectedApp",null),e=o[0].get("selected"),P.openWith(e)}),o.on("click",function(t){if(t.target===o[0])return o[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null)}),o[0].contextmenuHandler=function(t,e){var n,r,i;return t.target===o[0]&&o[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null),r=(r=[{text:__("Open"),dataid:"desktop-open"},{text:__("Refresh"),dataid:"desktop-refresh"}]).concat(function(){var t,e;for(n in e=[],t=V.setting.desktop.menu)i=t[n],e.push(i);return e}()),e.set("items",r),e.set("onmenuselect",function(t){var e;switch(t.item.data.dataid){case"desktop-open":return(e=o[0].get("selected"))||((e=V.setting.desktop.path.asFileHandler()).mime="dir"),P.openWith(e);case"desktop-refresh":return o[0].fetch();default:if(t.item.data.app)return P.launch(t.item.data.app,t.item.data.args)}}),e.show(t)},o[0].fetch(),H.observable.on("VFS",function(t){if(t.data.file.hash()===r.hash()||t.data.file.parent().hash()===r.hash())return o[0].fetch()}),H.ostrigger("desktoploaded")},riot.mount(o)):null},function(t,e){return alert(__("System fail: Cannot init desktop manager")),console.log(e,t)})},refreshDesktop:function(){return $("#desktop")[0].fetch()},refreshSystemMenu:function(){var t,e,n,r;for(t in P.SYS_MENU[0].child.length=1,P.SYS_MENU[0].child[0].child.length=0,e=V.setting.system.packages)(r=e[t])&&r.app&&P.SYS_MENU[0].child[0].child.push(r);for(t in n=V.setting.system.menu)r=n[t],P.SYS_MENU[0].child.push(r);return P.SYS_MENU[0].child.push({text:"__(Toggle Full screen)",dataid:"os-fullsize",iconclass:"fa fa-tv"}),P.SYS_MENU[0].child.push({text:"__(Log out)",dataid:"sys-logout",iconclass:"fa fa-user-times"}),$("[data-id = 'os_menu']","#syspanel")[0].update()},buildSystemMenu:function(){return $("[data-id = 'os_menu']","#syspanel")[0].set("items",P.SYS_MENU)},mkdialog:function(t){return new P.BasicDialog(t.name,t.layout)},login:function(){return I.resource("schemes/login.html",function(t){var e;return t?(e=$.parseHTML(t),$("#wrapper").append(e),$("#btlogin").click(function(){var t;return t={username:$("#txtuser").val(),password:$("#txtpass").val()},I.handler.login(t,function(t){return t.error?$("#login_error").html(t.error):P.startAntOS(t.result)})}),$("#txtpass").keyup(function(t){if(13===t.which)return $("#btlogin").click()})):null},function(t,e){return alert(__("System fail: Cannot init login screen"))})},startAntOS:function(t){return V.cleanup(),V.systemSetting(t),P.loadTheme(V.setting.appearance.theme),P.wallpaper(),H.observable.one("syspanelloaded",function(){return H.observable.on("systemlocalechange",function(t){return $("#syspanel")[0].update()}),I.packages.cache(function(t){if(t.result)return I.packages.fetch(function(t){var e,n,r,i,o,a,s,u;if(t.result)for(r in o=t.result)(u=o[r]).text=u.name,u.filename=r,u.type="app",u.mime="antos/app",u.icon&&(u.icon=u.path+"/"+u.icon),u.iconclass||u.icon||(u.iconclass="fa fa-adn");for(V.setting.system.packages=t.result?t.result:void 0,P.refreshSystemMenu(),P.buildSystemMenu(),P.pushServices(function(){var t,e,n,r;for(r=[],t=0,e=(n=V.setting.system.startup.services).length;t<e;t++)u=n[t],r.push(u);return r}()),s=[],n=0,i=(a=V.setting.system.startup.apps).length;n<i;n++)e=a[n],s.push(P.launch(e));return s})})}),I.setLocale(V.setting.system.locale,function(){return P.initDM()})}},s=function(){function t(t,e){var n;this.name=t,this.args=e,this.observable=riot.observable(),this._api=C.OS.API,this._gui=C.OS.GUI,this.systemsetting=C.OS.setting,(n=this).on("exit",function(){return n.quit()}),this.host="#desktop",this.dialog=void 0}return t.prototype.render=function(t){return P.loadScheme(t,this,this.host)},t.prototype.quit=function(t){var e;if(e=new P.BaseEvent("exit",t),this.onexit(e),!e.prevent)return this.observable.off("*"),delete this.observable,this.dialog&&this.dialog.quit(),D.kill(this)},t.prototype.path=function(){var t;return(t=this.meta())&&t.path?t.path:null},t.prototype.init=function(){},t.prototype.onexit=function(t){},t.prototype.one=function(t,e){return this.observable.one(t,e)},t.prototype.on=function(t,e){return this.observable.on(t,e)},t.prototype.off=function(t,e){return e?this.observable.off(t,e):this.observable.off(t)},t.prototype.trigger=function(t,e){return this.observable.trigger(t,e)},t.prototype.subscribe=function(t,e){return H.on(t,e,this)},t.prototype.openDialog=function(t,e,n,r){if(!this.dialog){if("string"==typeof t){if(!P.subwindows[t])return void this.error(__("Dialog {0} not found",t));this.dialog=new P.subwindows[t]}else this.dialog=t;return(this.dialog.parent=this).dialog.handler=e,this.dialog.pid=this.pid,this.dialog.data=r,this.dialog.title=n,this.dialog.init()}this.dialog.show()},t.prototype.ask=function(t,e,n){return this._gui.openDialog("YesNoDialog",function(t){if(t)return n()},t,{text:e})},t.prototype.publish=function(t,e,n){var r,i;return r=void 0,(i=this.meta()).icon&&(r=i.path+"/"+i.icon),H.trigger(t,{id:this.pid,name:this.name,data:{m:e,icon:r,iconclass:i.iconclass},error:n})},t.prototype.notify=function(t){return this.publish("notification",t)},t.prototype.warn=function(t){return this.publish("warning",t)},t.prototype.error=function(t){return this.publish("error",t,this._api.throwe(this.name))},t.prototype.fail=function(t){return this.publish("fail",t)},t.prototype.throwe=function(){return this._api.throwe(this.name)},t.prototype.update=function(){if(this.scheme)return this.scheme.update()},t.prototype.find=function(t){if(this.scheme)return $("[data-id='"+t+"']",this.scheme)[0]},t.prototype.select=function(t){if(this.scheme)return $(t,this.scheme)},t}(),this.OS.GUI.BaseModel=s,(n=function(t){function n(t,e){n.__super__.constructor.call(this,t,e),V.setting.applications[this.name]||(V.setting.applications[this.name]={}),this.setting=V.setting.applications[this.name],this.keycomb={ALT:{},CTRL:{},SHIFT:{},META:{}}}return q(n,t),n.prototype.init=function(){var e;return(e=this).off("*"),this.on("exit",function(){return e.quit()}),this.on("focus",function(){if(e.sysdock.set("selectedApp",e),e.appmenu.pid=e.pid,e.appmenu.set("items",e.baseMenu()||[]),e.appmenu.set("onmenuselect",function(t){return e.trigger("menuselect",t)}),e.dialog)return e.dialog.show()}),this.on("hide",function(){if(e.sysdock.set("selectedApp",null),e.appmenu.set("items",[]),e.dialog)return e.dialog.hide()}),this.on("menuselect",function(t){switch(t.e.item.data.dataid){case e.name+"-about":return e.openDialog("AboutDialog",function(){});case e.name+"-exit":return e.trigger("exit")}}),this.on("apptitlechange",function(){return e.sysdock.update()}),this.loadScheme()},n.prototype.loadScheme=function(){var t;return t=this.meta().path+"/scheme.html",this.render(t)},n.prototype.bindKey=function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),this.keycomb[i]))return this.keycomb[i][r]=e},n.prototype.shortcut=function(t,e,n){return!this.keycomb[t]||(!this.keycomb[t][e]||(this.keycomb[t][e](n),!1))},n.prototype.applySetting=function(t){},n.prototype.applyAllSetting=function(){var t,e,n;for(t in n=[],e=this.setting)e[t],n.push(this.applySetting(t));return n},n.prototype.registry=function(t,e){return this.setting[t]=e,this.publish("appregistry",t)},n.prototype.show=function(){return this.trigger("focus")},n.prototype.blur=function(){return this.appmenu&&this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),this.trigger("blur")},n.prototype.hide=function(){return this.trigger("hide")},n.prototype.toggle=function(){return this.trigger("toggle")},n.prototype.title=function(){return this.scheme.get("apptitle")},n.prototype.onexit=function(t){if(this.cleanup(t),!t.prevent)return this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),$(this.scheme).remove()},n.prototype.meta=function(){return V.APP[this.name].meta},n.prototype.baseMenu=function(){return[{text:V.APP[this.name].meta.name,child:[{text:"__(About)",dataid:this.name+"-about"},{text:"__(Exit)",dataid:this.name+"-exit"}]}].concat(this.menu()||[])},n.prototype.main=function(){},n.prototype.menu=function(){return[]},n.prototype.open=function(){},n.prototype.data=function(){},n.prototype.cleanup=function(t){},n}(this.OS.GUI.BaseModel)).type=1,this.OS.GUI.BaseApplication=n,(u=function(t){function n(t,e){n.__super__.constructor.call(this,t,e),this.icon=void 0,this.iconclass="fa-paper-plane-o",this.text="",this.timer=void 0,this.holder=void 0}return q(n,t),n.prototype.init=function(){},n.prototype.meta=function(){return V.APP[this.name].meta},n.prototype.attach=function(t){return this.holder=t},n.prototype.update=function(){if(this.holder&&this.holder.update(),this.scheme)return this.scheme.update()},n.prototype.watch=function(t,e){var n,r;return r=this,(n=function(){return e(),r.timer=setTimeout(function(){return n()},t)})()},n.prototype.onexit=function(t){if(this.timer&&console.log("clean timer"),this.timer&&clearTimeout(this.timer),this.cleanup(t),this.scheme)return $(this.scheme).remove()},n.prototype.main=function(){},n.prototype.show=function(){},n.prototype.awake=function(t){},n.prototype.cleanup=function(t){},n}(this.OS.GUI.BaseModel)).type=2,u.singleton=!0,this.OS.GUI.BaseService=u,o=function(){function t(t,e){this.name=t,this.force=e,this.prevent=!1}return t.prototype.preventDefault=function(){if(!this.force)return this.prevent=!0},t}(),this.OS.GUI.BaseEvent=o,(k=function(t){function e(t){e.__super__.constructor.call(this,t,null),this.parent=void 0,this.modal=!1}return q(e,t),e.prototype.quit=function(){var t;if(t=new P.BaseEvent("exit"),this.onexit(t),!t.prevent&&(delete this.observable,this.scheme&&$(this.scheme).remove(),this.dialog))return this.dialog.quit()},e.prototype.init=function(){},e.prototype.main=function(){},e.prototype.meta=function(){return this.parent.meta()},e.prototype.show=function(){return this.trigger("focus"),$(this.scheme).css("z-index",window._zindex+2)},e.prototype.hide=function(){return this.trigger("hide")},e}(this.OS.GUI.BaseModel)).type=3,this.OS.GUI.SubWindow=k,i=function(t){function e(t){e.__super__.constructor.call(this,t),this.handler=void 0}return q(e,k),e.prototype.onexit=function(t){if(this.parent)return this.parent.dialog=void 0},e}(),this.OS.GUI.BaseDialog=i,c=function(t){function r(t,e,n){this.conf=e,this.title=n,r.__super__.constructor.call(this,t)}return q(r,i),r.prototype.init=function(){var t,e,n,r,i;for(e in this.title||(this.title=this.name),t="<afx-app-window  data-id = '"+this.name+"'  width='"+this.conf.width+"' height='"+this.conf.height+"'>",t+="<afx-hbox><div data-width='7'></div><afx-vbox><div data-height='5'></div>",n=this.conf.tags)t+="<"+(i=n[e]).tag+" "+i.att+"  data-id = 'content"+e+"'></"+i.tag+">";for(e in t+="<div data-height = '35' style=' text-align:right;padding-top:3px;'>",r=this.conf.buttons)t+="<afx-button data-id = 'bt"+e+"' text = '"+(i=r[e]).label+"' style='margin-left:5px;'></afx-button>";return t+="</div><div data-height='5'></div></afx-vbox><div data-width='7'></div></afx-hbox></afx-app-window>",P.htmlToScheme(t,this,this.host)},r.prototype.main=function(){var t,e,n,r,i;for(e in this.scheme.set("apptitle",this.title),this.scheme.set("minimizable",!1),void 0!==this.conf.resizable&&this.scheme.set("resizable",this.conf.resizable),t=function(t){return function(){return t.onclick(n)}},r=(n=this).conf.buttons)i=r[e],n.find("bt"+e).set("onbtclick",t(i));if(this.conf.filldata&&this.conf.filldata(this),this.conf.xtra)return this.conf.xtra(this)},r}(),this.OS.GUI.BasicDialog=c,b=function(t){function e(){e.__super__.constructor.call(this,"PromptDialog",{tags:[{tag:"afx-label"},{tag:"input",att:"type = 'text' data-height='25'"}],width:200,height:120,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;return""===(e=t.find("content1").value)||t.handler&&t.handler(e),t.quit()}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("text",t.data.label),t.data.value?t.find("content1").value=t.data.value:void 0},xtra:function(e){return $(e.find("content1")).keyup(function(t){if(13===t.which)return e.find("bt0").trigger()})}})}return q(e,c),e}(),this.OS.register("PromptDialog",b),p=function(t){function e(){e.__super__.constructor.call(this,"CalendarDialog",{tags:[{tag:"afx-calendar-view"}],width:300,height:230,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;return(e=t.find("content0").get("selectedDate"))?(t.handler&&t.handler(e),t.quit()):t.notify(__("Please select a date"))}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}]})}return q(e,c),e}(),this.OS.register("CalendarDialog",p),h=function(t){function e(){e.__super__.constructor.call(this,"ColorPickerDialog",{tags:[{tag:"afx-color-picker"},{tag:"div",att:'data-height="5"'}],width:313,height:250,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;return(e=t.find("content0").get("selectedColor"))?(t.handler&&t.handler(e),t.quit()):t.notify("Please select a color")}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}]})}return q(e,c),e}(),this.OS.register("ColorPickerDialog",h),_=function(t){function e(){e.__super__.constructor.call(this,"InfoDialog",{tags:[{tag:"afx-grid-view"}],width:250,height:300,resizable:!0,buttons:[{label:"__(Cancel)",onclick:function(t){return t.quit()}}],filldata:function(t){var e,n,r,i;if(t.data){for(e in r=[],n=t.data)i=n[e],r.push([{value:e},{value:i}]);return t.find("content0").set("rows",r)}}})}return q(e,c),e}(),this.OS.register("InfoDialog",_),x=function(t){function e(){e.__super__.constructor.call(this,"YesNoDialog",{tags:[{tag:"afx-label"}],width:300,height:100,resizable:!0,buttons:[{label:"__(Yes)",onclick:function(t){return t.handler&&t.handler(!0),t.quit()}},{label:"__(No)",onclick:function(t){return t.handler&&t.handler(!1),t.quit()}}],filldata:function(t){var e,n,r,i,o;if(t.data){for(e in n=t.find("content0"),i=[],r=t.data)o=r[e],i.push(n.set(e,o));return i}}})}return q(e,c),e}(),this.OS.register("YesNoDialog",x),w=function(t){function e(){e.__super__.constructor.call(this,"SelectionDialog",{tags:[{tag:"afx-list-view"}],width:250,height:300,resizable:!1,buttons:[{label:"__(Ok)",onclick:function(t){var e;if(e=t.find("content0").get("selected"))return t.handler&&t.handler(e),t.quit()}},{label:"__(Cancel)",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("items",t.data)},xtra:function(e){return e.find("content0").set("onlistdbclick",function(t){return e.find("bt0").trigger()})}})}return q(e,c),e}(),this.OS.register("SelectionDialog",w),t=function(t){function e(){e.__super__.constructor.call(this,"AboutDialog")}return q(e,i),e.prototype.init=function(){return this.render("os://resources/schemes/about.html")},e.prototype.main=function(){var t,e,n,r,i;if(e=this.meta(),this.scheme.set("apptitle",__("About: {0}",e.name)),this.find("mylabel").set("*",{icon:e.icon,iconclass:e.iconclass,text:e.name+"(v"+e.version+")"}),$(this.find("mydesc")).html(e.description),e.info){for(t in r=[],n=e.info)i=n[t],r.push([{value:t},{value:i}]);return this.find("mygrid").set("rows",r)}},e}(),this.OS.register("AboutDialog",t),g=function(t){function e(){e.__super__.constructor.call(this,"FileDiaLog")}return q(e,i),e.prototype.init=function(){return this.render("os://resources/schemes/filedialog.html")},e.prototype.main=function(){var u,c,i,t,l,e;if(c=this.find("fileview"),t=this.find("location"),u=this.find("filename"),(l=this).scheme.set("apptitle",this.title),c.set("fetch",function(e,n){if(e.child)return e.child.path.asFileHandler().read(function(t){return t.error?l.error(__("Resource not found: {0}",e.child.path)):n(t.result)})}),e=function(e){return e.asFileHandler().read(function(t){return t.error?l.error(__("Resource not found: {0}",e)):(c.set("path",e),c.set("data",t.result))})},this.data&&this.data.root?($(t).hide(),this.trigger("calibrate"),e(this.data.root)):(t.set("onlistselect",function(t){if(t&&t.data.path)return e(t.data.path)}),t.set("items",function(){var t,e,n,r;for(r=[],t=0,e=(n=this.systemsetting.VFS.mountpoints).length;t<e;t++)"app"!==(i=n[t]).type&&r.push(i);return r}.call(this)),t.get("selected")||t.set("selected",0)),c.set("onfileselect",function(t){if("file"===t.type)return $(u).val(t.filename)}),this.find("bt-ok").set("onbtclick",function(t){var e,n,r,i,o,a,s;if(!(n=c.get("selectedFile")))return l.notify(__("Please select a file/fofler"));if(l.data&&l.data.type&&l.data.type!==n.type)return l.notify(__("Please select {0} only",l.data.type));if(l.data&&l.data.mimes){if(o=!1,n.mime)for(r=0,i=(a=l.data.mimes).length;r<i;r++)if(s=a[r],n.mime.match(new RegExp(s,"g"))){o=!0;break}if(!o)return l.notify(__("Only {0} could be selected",l.data.mimes.join(",")))}return e=n.path,"file"===n.type&&(e=n.path.asFileHandler().parent()),l.handler&&l.handler(e,$(u).val(),n.path,n),l.quit()}),this.find("bt-cancel").set("onbtclick",function(t){return l.quit()}),this.data&&this.data.file&&($(u).css("display","block").val(this.data.file.basename||"Untitled"),this.trigger("resize")),this.data&&this.data.hidden)return c.set("showhidden",this.data.hidden)},e}(),this.OS.register("FileDiaLog",g),P=C.OS.GUI,I=C.OS.API,D=C.OS.PM,V=C.OS,H=C.OS.courrier,this.onload=function(){return $(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){return P.fullscreen=!P.fullscreen}),C.OS.boot()}}).call(this);