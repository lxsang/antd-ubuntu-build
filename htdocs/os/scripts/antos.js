(function(){var t,e,n,i,o,a,s,u,c,l,p,h,f,g,m,y,v,b,S,w,F,k,O,A,x,I,P,_,V,D,T=function(t,e){for(var n in e)H.call(e,n)&&(t[n]=e[n]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},H={}.hasOwnProperty;(D=this).OS||(D.OS={API:{},GUI:{},APP:{},setting:{user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},courrier:{observable:riot.observable(),quota:0,listeners:new Object,on:function(t,e,n){return V.listeners[n.pid]||(V.listeners[n.pid]=[]),V.listeners[n.pid].push({e:t,f:e}),V.observable.on(t,e)},trigger:function(t,e){return V.observable.trigger(t,e)},osfail:function(t,e,n){return V.ostrigger("fail",{m:t,e:e,s:n})},oserror:function(t,e,n){return V.ostrigger("error",{m:t,e:e,s:n})},osinfo:function(t){return V.ostrigger("info",{m:t,e:null,s:null})},ostrigger:function(t,e){return V.trigger(t,{id:0,data:e,name:"OS"})},unregister:function(t){var e,n,r,i;if(V.listeners[t.pid]&&V.listeners[t.pid].length>0){for(n=0,r=(i=V.listeners[t.pid]).length;n<r;n++)e=i[n],V.observable.off(e.e,e.f);return delete V.listeners[t.pid],V.listeners[t.pid]=[]}},getMID:function(){return V.quota+=1,V.quota}},register:function(t,e){return 3===e.type?D.OS.GUI.subwindows[t]=e:I.APP[t]=e},PM:{pidalloc:0,processes:{},createProcess:function(t,e,n){var r,i,o;return r=function(){var r;if(e.singleton&&P.processes[t]&&1===P.processes[t].length?P.processes[t][0].show():(P.processes[t]||(P.processes[t]=[]),(r=new e(n)).birth=(new Date).getTime(),P.pidalloc++,r.pid=P.pidalloc,P.processes[t].push(r),1===e.type?x.dock(r,e.meta):x.attachservice(r)),2===e.type)return V.trigger("srvroutineready",t)},e.dependencies?(i=function(){var t,n,r,i;for(i=[],t=0,n=(r=e.dependencies).length;t<n;t++)o=r[t],i.push(o);return i}(),A.requires(i,r)):r()},appByPid:function(t){var e,n,r,i;for(r in e=void 0,n=function(e){var n,r,i;for(r=0,i=e.length;r<i;r++)if((n=e[r]).pid===t)return n},i=P.processes)if(e=n(i[r]))break;return e},kill:function(t){var e;if(t.name&&P.processes[t.name])return(e=P.processes[t.name].indexOf(t))>=0?(1===I.APP[t.name].type?x.undock(t):x.detachservice(t),V.unregister(t),delete P.processes[t.name][e],P.processes[t.name].splice(e,1)):void 0},killAll:function(t){var e,n,r,i,o,a,s,u;if(P.processes[t]){for(s=[],n=0,r=(o=P.processes[t]).length;n<r;n++)e=o[n],s.push(e);for(a=[],u=0,i=s.length;u<i;u++)e=s[u],a.push(e.quit());return a}}},cleanup:function(){return console.log("Clean up system"),$("#wrapper").empty(),x.clearTheme(),V.observable=riot.observable(),V.quota=0,I.APP={},I.setting={user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},P.processes={},P.pidalloc=0},boot:function(){return console.log("Booting sytem"),A.handler.auth(function(t){return t.error?x.login():x.startAntOS(t.result)})},cleanupHandlers:{},exit:function(){var t,e;for(t in e=I.cleanupHandlers)(0,e[t])();return A.handler.setting(function(){return A.handler.logout()})},onexit:function(t,e){if(!D.OS.cleanupHandlers[t])return D.OS.cleanupHandlers[t]=e}}),String.prototype.hash=function(){var t,e;for(t=5381,e=this.length;e;)t=33*t^this.charCodeAt(--e);return t>>>0},String.prototype.asBase64=function(){var t;return t=encodeURIComponent(this),btoa(t.replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}))},String.prototype.unescape=function(){return this.replace(/\\\\/g,"\\").replace(/\\"/g,'"').replace(/\\n/g,"\n").replace(/\\t/g,"\t").replace(/\\b/g,"\b").replace(/\\f/g,"\f").replace(/\\r/g,"\r")},String.prototype.asUnit8Array=function(){var t,e,n,r;for(t=[],e=n=0,r=this.length-1;0<=r?n<=r:n>=r;e=0<=r?++n:--n)t.push(this.charCodeAt(e));return t=new Uint8Array(t)},Date.prototype.toString=function(){var t,e,n,r,i,o;return t=this.getDate(),r=this.getMonth()+1,o=this.getFullYear(),t<10&&(t="0"+t),r<10&&(r="0"+r),(e=this.getHours())<10&&(e="0"+e),(n=this.getMinutes())<10&&(n="0"+n),(i=this.getSeconds())<10&&(i="0"+i),t+"/"+r+"/"+o+" "+e+":"+n+":"+i},Date.prototype.timestamp=function(){return this.getTime()/1e3|0},D.OS.API={handler:{},shared:{},searchHandler:{},mid:function(){return V.getMID()},post:function(t,e,n,r){var i;return i=V.getMID(),A.loading(i,t),$.ajax({type:"POST",url:t,contentType:"application/json",data:JSON.stringify(e,{dataType:"json",success:null})}).done(function(e){return A.loaded(i,t,"OK"),n(e)}).fail(function(e,n){return A.loaded(i,t,"FAIL"),r(e,n)})},blob:function(t,e,n){var r,i;return r=V.getMID(),(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(i){return 200===this.status&&4===this.readyState?(e(this.response),A.loaded(r,t,"OK")):(n(i,this),A.loaded(r,t,"FAIL"))},A.loading(r,t),i.send()},upload:function(t,e,n,r){var i,o;return o=V.getMID(),(i=$("<input>").attr("type","file").css("display","none")).change(function(){var a;return A.loading(o,t),(a=new FormData).append("path",e),a.append("upload",i[0].files[0]),$.ajax({url:t,data:a,type:"POST",contentType:!1,processData:!1}).done(function(e){return A.loaded(o,t,"OK"),n(e),i.remove()}).fail(function(e,n){return A.loaded(o,t,"FAIL"),r(e,n),i.remove()})}),i.click()},saveblob:function(t,e){var n,r;return r=window.URL.createObjectURL(e),(n=$("<a>").attr("href",r).attr("download",t).css("display","none").appendTo("body"))[0].click(),window.URL.revokeObjectURL(r),n.remove()},systemConfig:function(){return A.request("config",function(t){return console.log(t)})},loading:function(t,e){return V.trigger("loading",{id:t,data:{m:""+e,s:!0},name:"OS"})},loaded:function(t,e,n){return V.trigger("loaded",{id:t,data:{m:n+": "+e,s:!1},name:"OS"})},get:function(t,e,n,r){var i,o;return i={type:"GET",url:t},r&&(i.dataType=r),o=V.getMID(),A.loading(o,t),$.ajax(i).done(function(n){return A.loaded(o,t,"OK"),e(n)}).fail(function(e,r){return A.loaded(o,t,"FAIL"),n(e,r)})},script:function(t,e,n){var r;return r=V.getMID(),A.loading(r,t),$.getScript(t).done(function(n){return A.loaded(r,t,"OK"),e(n)}).fail(function(e,i){return A.loaded(r,t,"FAIL"),n(e,i)})},resource:function(t,e,n){var r;return r="resources/"+t,A.get(r,e,n)},libready:function(t){return A.shared[t]||!1},require:function(t,e){var n,i;return A.shared[t]?(console.log(t,"Library exist, no need to load"),V.trigger("sharedlibraryloaded",t)):t.match(/^(https?:\/\/[^\s]+)/g)?A.script(t,function(){if(A.shared[t]=!0,V.trigger("sharedlibraryloaded",t),e)return e()},function(e,n){return V.oserror("Cannot load 3rd library at: "+t,e,r)}):(n=""+(i="os:///scripts/")+t+".js").asFileHandler().onready(function(r){var o;if(A.shared[t]=!0,$("<script>",{src:A.handler.get+"/"+n}).appendTo("head"),(o=""+i+t+".css").asFileHandler().onready(function(t){return $("<link>",{rel:"stylesheet",type:"text/css",href:A.handler.get+"/"+o}).appendTo("head")},function(){}),console.log("loaded",t),V.trigger("sharedlibraryloaded",t),e)return e()})},requires:function(t,e){return t.length>0?(V.observable.one("sharedlibraryloaded",function(n){return t.splice(0,1),A.requires(t,e)}),A.require(t[0],null)):e()},packages:{fetch:function(t){var e,n;return A.handler.packages({command:"list",args:{paths:function(){var t,r;for(e in r=[],t=I.setting.system.pkgpaths)n=t[e],r.push(n);return r}()}},t)},cache:function(t){var e,n;return A.handler.packages({command:"cache",args:{paths:function(){var t,r;for(e in r=[],t=I.setting.system.pkgpaths)n=t[e],r.push(n);return r}()}},t)}},search:function(t){var e,n,r,i;for(e in n=[],r=A.searchHandler)r[e],(i=A.searchHandler[e](t)).length>0&&(i.unshift({text:e,class:"search-header",dataid:"header"}),n=n.concat(i));return n},onsearch:function(t,e){if(!D.OS.API.searchHandler[t])return D.OS.API.searchHandler[t]=e},throwe:function(t){var e;e=void 0;try{throw new Error(t)}catch(t){e=t}return e||""}},D.OS.systemSetting=function(t){return t.desktop&&(I.setting.desktop=t.desktop),t.applications&&(I.setting.applications=t.applications),t.appearance&&(I.setting.appearance=t.appearance),I.setting.user=t.user,t.VFS&&(I.setting.VFS=t.VFS),I.setting.desktop.path||(I.setting.desktop.path="home:///.desktop"),I.setting.desktop.menu||(I.setting.desktop.menu={}),I.setting.VFS.mountpoints||(I.setting.VFS.mountpoints=[{text:"Applications",path:"app:///",iconclass:"fa  fa-adn",type:"app"},{text:"Home",path:"home:///",iconclass:"fa fa-home",type:"fs"},{text:"Desktop",path:I.setting.desktop.path,iconclass:"fa fa-desktop",type:"fs"},{text:"OS",path:"os:///",iconclass:"fa fa-inbox",type:"fs"},{text:"Google Drive",path:"gdv:///",iconclass:"fa fa-inbox",type:"fs"},{text:"Shared",path:"shared:///",iconclass:"fa fa-share-square",type:"fs"}]),t.system&&(I.setting.system=t.system),I.setting.system.startup||(I.setting.system.startup={services:["CoreServices/PushNotification","CoreServices/UserService","CoreServices/Calendar","CoreServices/Spotlight"],apps:[]}),I.setting.system.pkgpaths||(I.setting.system.pkgpaths={user:"home:///.packages",system:"os:///packages"}),I.setting.system.menu||(I.setting.system.menu={}),I.setting.system.repositories||(I.setting.system.repositories=[]),I.setting.appearance.theme||(I.setting.appearance.theme="antos"),I.setting.VFS.gdrive||(I.setting.VFS.gdrive={CLIENT_ID:"",API_KEY:"",apilink:"https://apis.google.com/js/api.js",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES:"https://www.googleapis.com/auth/drive"}),A.onsearch("Applications",function(t){var e,n,r,i,o,a,s,u,c,l,p,h;for(i in e=[],l=new RegExp(t,"i"),u=I.setting.system.packages)if((p=u[i]).app)if(p.name.match(l)||p.description&&p.description.match(l)){for(o in h={},p)n=p[o],"selected"!==o&&(h[o]=n);h.detail=[{text:h.path}],h.complex=!0,e.push(h)}else if(p.mimes)for(r=0,a=(c=p.mimes).length;r<a;r++)if(s=c[r],t.match(new RegExp(s,"g"))){for(o in h={},p)n=p[o],"selected"!==o&&(h[o]=p[o]);h.detail=[{text:h.path}],h.complex=!0,e.push(h);break}return e})},D.OS.API.HOST=D.location.hostname+(D.location.port?":"+D.location.port:""),D.OS.API.REST=D.location.protocol+"//"+D.OS.API.HOST+"/lua-api/os",_=D.OS.API.REST,D.OS.API.handler={get:_+"/fs/get",shared:_+"/fs/shared",scandir:function(t,e){var n;return n=_+"/fs/scandir",A.post(n,{path:t},e,function(e,n){return V.osfail("Fail to scan directory: "+t,e,n)})},mkdir:function(t,e){var n;return n=_+"/fs/mkdir",A.post(n,{path:t},e,function(e,n){return V.osfail("Fail to create directory: "+t,e,n)})},sharefile:function(t,e,n){var r;return r=_+"/fs/publish",A.post(r,{path:t,publish:e},n,function(e,n){return V.osfail("Fail to publish file: "+t,e,n)})},fileinfo:function(t,e){var n;return n=_+"/fs/fileinfo",A.post(n,{path:t},e,function(e,n){return V.osfail("Fail to get file metadata: "+t,e,n)})},readfile:function(t,e,n){var r;return r=_+"/fs/get/",A.get(r+t,e,function(e,n){return V.osfail("Fail to read file: "+t,e,n)},n)},move:function(t,e,n){var r;return r=_+"/fs/move",A.post(r,{src:t,dest:e},n,function(t,n){return V.osfail("Fail to move file: "+n+" -> "+e,t,n)})},delete:function(t,e){var n;return n=_+"/fs/delete",A.post(n,{path:t},e,function(e,n){return V.osfail("Fail to delete: "+t,e,n)})},fileblob:function(t,e){var n;return n=_+"/fs/get/",A.blob(n+t,e,function(e,n){return V.osfail("Fail to read file: "+t,e,n)})},packages:function(t,e){var n;return n=_+"/system/packages",A.post(n,t,e,function(e,n){return V.osfail("Fail to "+t.command+" package",e,n)})},upload:function(t,e){var n;return n=_+"/fs/upload",A.upload(n,t,e,function(e,n){return V.osfail("Fail to upload file to: "+t,e,n)})},write:function(t,e,n){var r;return r=_+"/fs/write",A.post(r,{path:t,data:e},n,function(e,n){return V.osfail("Fail to write to file: "+t,e,n)})},scanapp:function(t,e){return _+"/system/application"},auth:function(t){var e;return e=_+"/system/auth",A.post(e,{},t,function(){return alert("Resource not found: "+e)})},login:function(t,e){var n;return n=_+"/system/login",A.post(n,t,e,function(){return alert("Resource not found: "+n)})},logout:function(){var t;return t=_+"/system/logout",A.post(t,{},function(t){return I.boot()},function(){return alert("Resource not found "+t)})},setting:function(t){var e;return e=_+"/system/settings",A.post(e,I.setting,function(e){if(e.error&&V.oserror("Cannot save system setting",e.error),t)return t()},function(n,r){if(V.osfail("Fail to make request: "+e,n,r),t)return t()})},dbquery:function(t,e,n){var r;return r=_+"/db/"+t,A.post(r,e,n,function(t,e){return V.osfail("Fail to query data from database: "+r,t,e)})}},String.prototype.asFileHandler=function(){var t,e;return e=this.split(":///"),(t=A.VFS.findHandlers(e[0]))&&0!==t.length?new t[0](this):(V.osfail("VFS unknown handler: "+this,A.throwe("OS.VFS"),this),null)},this.OS.API.VFS={handlers:{},register:function(t,e){return D.OS.API.VFS.handlers[t]=e},findHandlers:function(t){var e,n;return function(){var r,i;for(e in i=[],r=A.VFS.handlers)n=r[e],t.trim().match(new RegExp(e,"g"))&&i.push(n);return i}()}},a=function(){function t(t){this.dirty=!1,this.cache=void 0,this.setPath(t)}return t.prototype.setPath=function(t){var e,n;if(this.ready=!1,t&&(this.path=t.toString(),e=this.path.split(":///"),this.protocol=e[0],e.length>1&&""!==(n=e[1].replace(/^\/+|\/+$/g,""))))return this.genealogy=n.split("/"),this.isRoot()||(this.basename=this.genealogy[this.genealogy.length-1]),0!==this.basename.lastIndexOf(".")&&-1!==this.basename.indexOf(".")?this.ext=this.basename.split(".").pop():void 0},t.prototype.isRoot=function(){return!this.genealogy||0===this.genealogy.size},t.prototype.child=function(t){return this.isRoot()?this.path+t:this.path+"/"+t},t.prototype.isHidden=function(){return!!this.basename&&"."===this.basename[0]},t.prototype.hash=function(){return this.path?this.path.hash():-1},t.prototype.sendB64=function(t,e){var n,r,i;return r=this,this.cache?"string"==typeof this.cache?(n=this.cache.asBase64(),e(n="data:"+t+";base64,"+n)):((i=new FileReader).readAsDataURL(this.cache),i.onload=function(){return e(i.result)},i.onerror=function(t){return V.osfail("Cannot ecode file: "+r.path,A.throwe("OS.VFS"),t)}):e("")},t.prototype.parent=function(){return this.isRoot()?this:this.protocol+":///"+this.genealogy.slice(0,this.genealogy.length-1).join("/")},t.prototype.onready=function(t,e){var n;return this.ready?t():(n=this).meta(function(r){return r.error?e?e(r):V.osfail(n.path+": "+r.error,A.throwe("OS.VFS"),r.error):(n.info=r.result,n.ready=!0,t())})},t.prototype.read=function(t,e){var n;return n=this,this.onready(function(){return n.action("read",e,t)})},t.prototype.write=function(t,e){var n;return n=this,this.action("write",t,function(t){return t.result&&V.ostrigger("VFS",{m:"write",file:n}),e(t)})},t.prototype.mk=function(t,e){var n;return n=this,this.onready(function(){return n.action("mk",t,function(t){return t.result&&V.ostrigger("VFS",{m:"mk",file:n}),e(t)})})},t.prototype.remove=function(t){var e;return e=this,this.onready(function(){return e.action("remove",null,function(n){return n.result&&V.ostrigger("VFS",{m:"remove",file:e}),t(n)})})},t.prototype.upload=function(t){var e;return e=this,this.onready(function(){return e.action("upload",null,function(n){return n.result&&V.ostrigger("VFS",{m:"upload",file:e}),t(n)})})},t.prototype.publish=function(t){var e;return e=this,this.onready(function(){return e.action("publish",null,function(n){return n.result&&V.ostrigger("VFS",{m:"publish",file:e}),t(n)})})},t.prototype.download=function(t){var e;return e=this,this.onready(function(){return e.action("download",null,t)})},t.prototype.move=function(t,e){var n;return n=this,this.onready(function(){return n.action("move",t,function(n){return n.result&&V.ostrigger("VFS",{m:"move",file:t.asFileHandler()}),e(n)})})},t.prototype.execute=function(t){var e;return e=this,this.onready(function(){return e.action("execute",null,t)})},t.prototype.meta=function(t){},t.prototype.action=function(t,e,n){return V.osfail("VFS unknown action: "+t,A.throwe("OS.VFS"),t)},t}(),D.OS.API.VFS.BaseFileHandler=a,S=function(t){function e(t){e.__super__.constructor.call(this,t)}return T(e,t),e.prototype.meta=function(t){return A.handler.fileinfo(this.path,t)},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return"dir"===this.info.type?A.handler.scandir(this.path,n):"binary"===e?A.handler.fileblob(this.path,n):A.handler.readfile(this.path,n,e||"text");case"mk":return"file"===this.info.type?n({error:this.path+" is not a directory"}):A.handler.mkdir(this.path+"/"+e,n);case"write":return this.sendB64(e,function(t){return A.handler.write(r.path,t,n)});case"upload":if("file"===this.info.type)return;return A.handler.upload(this.path,n);case"remove":return A.handler.delete(this.path,n);case"publish":return A.handler.sharefile(this.path,!0,n);case"download":if("dir"===this.info.type)return;return A.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),A.saveblob(r.basename,e)});case"move":return A.handler.move(this.path,e,n);default:return V.osfail("VFS unknown action: "+t,A.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^(home|desktop|os|Untitled)$",S),e=function(t){function e(t){e.__super__.constructor.call(this,t),this.basename&&(this.info=I.setting.system.packages[this.basename]),this.ready=!0}return T(e,t),e.prototype.meta=function(t){return t()},e.prototype.action=function(t,e,n){var r,i;switch(this,t){case"read":if(this.info)return n({result:this.info});if(!this.isRoot())return;return n({result:function(){var t,e;for(r in e=[],t=I.setting.system.packages)i=t[r],e.push(i);return e}()});case"mk":case"write":case"upload":case"remove":case"publish":case"download":case"move":break;default:return V.osfail("VFS unknown action: "+t,A.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^app$",e),l=function(t){function e(t,n,r){e.__super__.constructor.call(this,t),r&&(this.cache=r),this.info={mime:n,path:t,size:r?r.length:0,name:this.basename,type:"file"}}return T(e,t),e.prototype.meta=function(t){return t()},e.prototype.onchange=function(t){return this.onchange=t},e.prototype.action=function(t,e,n){var r;switch(this,t){case"read":return n({result:this.cache});case"mk":break;case"write":return this.cache=e,this.onchange&&this.onchange(this),n({result:!0});case"upload":case"remove":case"publish":break;case"download":return r=new Blob([this.cache],{type:"octet/stream"}),A.saveblob(this.basename,r);case"move":break;default:return V.osfail("VFS unknown action: "+t,A.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^mem$",l),F=function(t){function e(t){e.__super__.constructor.call(this,t),this.isRoot()&&(this.ready=!0)}return T(e,t),e.prototype.meta=function(t){return A.handler.fileinfo(this.path,t)},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return this.isRoot()?A.get(A.handler.shared+"/all",n,function(t,e){}):"binary"===e?A.handler.fileblob(this.path,n):A.handler.readfile(this.path,n,e||"text");case"mk":break;case"write":return A.handler.write(this.path,e,n);case"remove":return A.handler.sharefile(this.basename,!1,n);case"upload":break;case"publish":return n({result:this.basename});case"download":if("dir"===this.info.type)return;return A.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),A.saveblob(r.basename,e)});case"move":break;default:return V.osfail("VFS unknown action: "+t,A.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^shared$",F),m={"gdv:///":{id:"root",mime:"dir"}},y=function(t){function e(t){if(e.__super__.constructor.call(this,t),this,this.setting=I.setting.VFS.gdrive,!this.setting)return V.oserror("Unknown API setting for google drive VFS",A.throwe("OS.VFS"),null);this.isRoot()&&(this.gid="root"),this.cache=""}return T(e,t),e.prototype.oninit=function(t){var e,n;if(n=this,this.setting)return e=function(e){return e?t():(m={"gdv:///":{id:"root",mime:"dir"}},gapi.auth2.getAuthInstance().signIn())},A.libready(this.setting.apilink)?(gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return e(t)}),e(gapi.auth2.getAuthInstance().isSignedIn.get())):A.require(this.setting.apilink,function(){var t;return t=V.getMID(),gapi.load("client:auth2",function(){return A.loading(t,"GAPI"),gapi.client.init({apiKey:n.setting.API_KEY,clientId:n.setting.CLIENT_ID,discoveryDocs:n.setting.DISCOVERY_DOCS,scope:n.setting.SCOPES}).then(function(){return A.loaded(t,"OK"),gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return e(t)}),x.openDialog("YesNoDialog",function(t){return t?e(gapi.auth2.getAuthInstance().isSignedIn.get()):V.osinfo("User abort the authentification")},"Authentification",{text:"Would you like to login to Google Drive ?"})}).catch(function(e){return A.loaded(t,"FAIL"),V.oserror("VFS cannot init GAPI: "+e.error,A.throwe("OS.VFS"),e)})})})},e.prototype.meta=function(t){var e;return e=this,this.oninit(function(){var n,r;return r=V.getMID(),m[e.path]&&(e.gid=m[e.path].id),e.gid?(A.loading(r,"GAPI"),gapi.client.drive.files.get({fileId:e.gid,fields:e.fields()}).then(function(e){if(A.loaded(r,"OK"),e.result)return e.result.mime=e.result.mimeType,t(e)}).catch(function(t){return A.loaded(r,"FAIL"),V.oserror("VFS cannot get meta "+e.gid,A.throwe("OS.VFS"),t)})):(n=e.parent().asFileHandler()).meta(function(r){var i,o;return i=r.result,o=V.getMID(),A.loading(o,"GAPI"),m[n.path]={id:i.id,mime:i.mimeType},gapi.client.drive.files.list({q:"name = '"+e.basename+"' and '"+i.id+"' in parents and trashed = false",fields:"files("+e.fields()+")"}).then(function(n){if(A.loaded(o,"OK"),n.result.files&&n.result.files.length>0)return m[e.path]={id:n.result.files[0].id,mime:n.result.files[0].mimeType},n.result.files[0].mime=n.result.files[0].mimeType,t({result:n.result.files[0]})}).catch(function(t){return A.loaded(o,"FAIL"),V.oserror("VFS cannot get meta "+e.path,A.throwe("OS.VFS"),t)})})})},e.prototype.fields=function(){return"webContentLink, id, name,mimeType,description, kind, parents, properties, iconLink, createdTime, modifiedTime, owners, permissions, fullFileExtension, fileExtension, size"},e.prototype.isFolder=function(){return"application/vnd.google-apps.folder"===this.info.mimeType},e.prototype.save=function(t,e,n){var r,i,o,a,s,u;return i=this,o=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,a=V.getMID(),s="https://www.googleapis.com/upload/drive/v3/files/"+t+"?uploadType=media",(u=new XMLHttpRequest).open("PATCH",s),u.setRequestHeader("Authorization","Bearer "+o),u.setRequestHeader("Content-Type",e),u.setRequestHeader("Content-Encoding","base64"),u.setRequestHeader("Content-Transfer-Encoding","base64"),A.loading(a,"GAPI"),r=function(t,e){return A.loaded(a,"FAIL"),V.oserror("VFS cannot save : "+i.path,t,e)},u.onreadystatechange=function(){if(4===u.readyState)return 200===u.status?(A.loaded(a,"OK"),n({result:JSON.parse(u.responseText)})):r(u,u.status)},u.onerror=function(){return r(u,u.status)},this.sendB64(e,function(t){return u.send(t.replace(/^data:[^;]+;base64,/g,""))})},e.prototype.action=function(t,e,n){var r,i,o,a,s,u,c;switch(a=this,c=V.getMID(),A.loading(c,"GAPI"),t){case"read":if(!this.info.id)return;return this.isFolder()?gapi.client.drive.files.list({q:"'"+a.info.id+"' in parents and trashed = false",fields:"files("+a.fields()+")"}).then(function(t){var e,r,i,o;if(A.loaded(c,"OK"),t.result.files){for(r=0,i=(o=t.result.files).length;r<i;r++)(e=o[r]).path=a.child(e.name),e.mime=e.mimeType,e.filename=e.name,e.type="file",e.gid=e.id,"application/vnd.google-apps.folder"===e.mimeType&&(e.mime="dir",e.type="dir",e.size=0),m[e.path]={id:e.gid,mime:e.mime};return n({result:t.result.files})}}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot read "+a.path,A.throwe("OS.VFS"),t)}):gapi.client.drive.files.get({fileId:a.info.id,alt:"media"}).then(function(t){return A.loaded(c,"OK"),n("binary"!==e?t.body:t.body.asUnit8Array())}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot get read "+a.path,A.throwe("OS.VFS"),t)});case"mk":if(!this.isFolder())return n({error:this.path+" is not a directory"});s={name:e,parents:[this.info.id],mimeType:"application/vnd.google-apps.folder"},gapi.client.drive.files.create({resource:s,fields:"id"}).then(function(t){return A.loaded(c,"OK"),t&&t.result?(m[a.child(e)]={id:t.result.id,mime:"dir"},n(t)):V.oserror("VFS cannot create : "+e,A.throwe("OS.VFS"),t)}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot create "+e,A.throwe("OS.VFS"),t)});break;case"write":return o=void 0,m[a.path]&&(o=m[a.path].id),o?(A.loaded(c,"OK"),this.save(o,e,n)):(i=this.parent().asFileHandler()).onready(function(){return s={name:a.basename,mimeType:e,parents:[i.info.id]},gapi.client.drive.files.create({resource:s,fields:"id"}).then(function(t){return A.loaded(c,"OK"),t&&t.result?(m[a.path]={id:t.result.id,mime:e},a.save(t.result.id,e,n)):V.oserror("VFS cannot write : "+a.path,A.throwe("OS.VFS"),t)}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot write "+a.path,A.throwe("OS.VFS"),t)})});case"upload":if(!this.isFolder())return;return u=$("<input>").attr("type","file").css("display","none"),A.loaded(c,"OK"),u.change(function(){var t,e;return e=u[0].files[0],(t=a.child(e.name).asFileHandler()).cache=e,t.write(e.type,n),u.remove()}),u.click();case"remove":if(!this.info.id)return;return gapi.client.drive.files.delete({fileId:a.info.id}).then(function(t){return A.loaded(c,"OK"),t?(m[a.path]=null,n({result:!0})):V.oserror("VFS cannot delete : "+a.path,A.throwe("OS.VFS"),t)}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot delete "+a.path,A.throwe("OS.VFS"),t)});case"publish":A.loaded(c,"OK");break;case"download":return gapi.client.drive.files.get({fileId:a.info.id,alt:"media"}).then(function(t){var e,n,r,i,o;if(A.loaded(c,"OK"),!t.body)return V.oserror("VFS cannot get file : "+a.path,A.throwe("OS.VFS"),t);for(n=[],r=i=0,o=t.body.length-1;0<=o?i<=o:i>=o;r=0<=o?++i:--i)n.push(t.body.charCodeAt(r));return n=new Uint8Array(n),e=new Blob([n],{type:"octet/stream"}),A.saveblob(a.basename,e)}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot fetch "+a.path,A.throwe("OS.VFS"),t)});case"move":return(r=e.asFileHandler().parent().asFileHandler()).onready(function(){var t;return t=a.info.parents.join(","),gapi.client.drive.files.update({fileId:a.info.id,addParents:r.info.id,removeParents:t,fields:"id"}).then(function(t){return A.loaded(c,"OK"),t?n(t):V.oserror("VFS cannot move : "+a.path,A.throwe("OS.VFS"),t)}).catch(function(t){return A.loaded(c,"FAIL"),V.oserror("VFS cannot move "+a.gid,A.throwe("OS.VFS"),t)})},function(t){return A.loaded(c,"FAIL")});default:return A.loaded(c,"FAIL"),V.osfail("VFS unknown action: "+t,A.throwe("OS.VFS"),t)}},e}(this.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^gdv$",y),D.OS.API.onsearch("Google Drive",function(t){var e,n,r,i,o;for(r in e=[],i=new RegExp(t,"i"),m)o=m[r],(r.match(i)||o&&o.mime.match(i))&&((n=r.asFileHandler()).text=n.basename,n.mime=o.mime,n.iconclass="fa fa-file","dir"===n.mime&&(n.iconclass="fa fa-folder"),n.complex=!0,n.detail=[{text:n.path}],e.push(n));return e}),D.OS.onexit("cleanUpGoogleDrive",function(){var t;if(m={"gdv:///":{id:"root",mime:"dir"}},I.setting.VFS.gdrive&&A.libready(I.setting.VFS.gdrive.apilink)&&(t=gapi.auth2.getAuthInstance()))return t.isSignedIn.get()?$("<iframe/>",{src:"https://www.google.com/accounts/Logout",frameborder:0,onload:function(){return t.disconnect()}}):void 0}),f=function(){function t(t){this.table=t}return t.prototype.save=function(t,e){return A.handler.dbquery("save",{table:this.table,data:t},e)},t.prototype.delete=function(t,e){var n;return n={table:this.table},t&&""!==t?(isNaN(t)?n.cond=t:n.id=t,A.handler.dbquery("delete",n,e)):V.oserror("Unknown condition for delete command",A.throwe("OS.DB"),t)},t.prototype.get=function(t,e){return A.handler.dbquery("get",{table:this.table,id:t},e)},t.prototype.find=function(t,e){return A.handler.dbquery("select",{table:this.table,cond:t},e)},t}(),D.OS.API.DB=f,D.OS.GUI={subwindows:new Object,dialog:void 0,fullscreen:!1,shortcut:{ALT:{},CTRL:{},SHIFT:{},META:{}},SYS_MENU:[{text:"Applications",child:[],dataid:"sys-apps",iconclass:"fa fa-adn",onmenuselect:function(t){return x.launch(t.item.data.app)}}],htmlToScheme:function(t,e,n){var r;return r=$.parseHTML(t),$(n).append(r),riot.mount($(r),{observable:e.observable}),e.scheme=r[0],e.main(),e.show()},loadScheme:function(t,e,n){return t.asFileHandler().read(function(t){return t?x.htmlToScheme(t,e,n):null})},clearTheme:function(){return $("head link#ostheme").attr("href","")},loadTheme:function(t,e){var n;return e&&x.clearTheme(),n="resources/themes/"+t+"/"+t+".css",$("head link#ostheme").attr("href",n)},pushServices:function(t){if(t.length>0)return V.observable.one("srvroutineready",function(){return t.splice(0,1),x.pushServices(t)}),x.pushService(t[0])},openDialog:function(t,e,n,r){var i;if(!x.dialog)return x.subwindows[t]?(x.dialog=new x.subwindows[t],x.dialog.parent=x,x.dialog.handler=e,x.dialog.pid=-1,x.dialog.data=r,x.dialog.title=n,x.dialog.init()):(i=A.throwe("Dialog"),V.oserror("Dialog "+t+" not found",i,null));x.dialog.show()},pushService:function(t){var e,n,r;return n=t.split("/"),r=n[1],e=n[0],I.APP[r]?P.createProcess(r,I.APP[r]):x.loadApp(e,function(t){if(I.APP[r])return P.createProcess(r,I.APP[r])},function(t,e){return V.trigger("srvroutineready",r),V.osfail("Cannot read service script: "+r+" ",t,e)})},appsByMime:function(t){var e,n,r,i,o,a,s,u,c,l;for(u=function(){var t,e;for(o in e=[],t=I.setting.system.packages)(l=t[o]).app&&e.push(l);return e}(),c=function(){var t,e,n;for(n=[],t=0,e=u.length;t<e;t++)(s=u[t])&&n.push(s.mimes);return n}(),e=[],n=function(n,r){var i;try{return n.filter(function(n,i){return!!t.match(new RegExp(n,"g"))&&(e.push(u[r]),!1)})}catch(e){return i=e,V.osfail("Find app by mimes "+t,i,t)}},r=i=0,a=c.length;i<a;r=++i)(s=c[r])&&n(s,r);return e},appsWithServices:function(){var t,e,n,r;for(t in e={},n=I.setting.system.packages)(r=n[t]).services&&r.services.length>0&&(e[t]=r);return e},openWith:function(t){var e,n,r;if(t)return"app"===t.type&&t.app?x.launch(t.app):"app"===t.type?V.osinfo("Application"+t.text+" is not executable"):0===(e=x.appsByMime("dir"===t.type?"dir":t.mime)).length?V.osinfo("No application available to open "+t.filename):1===e.length?x.launch(e[0].app,[t.path]):(r=function(){var t,r,i;for(i=[],t=0,r=e.length;t<r;t++)n=e[t],i.push({text:n.app,icon:n.icon,iconclass:n.iconclass});return i}(),x.openDialog("SelectionDialog",function(e){return x.launch(e.text,[t.path])},"Open width",r))},forceLaunch:function(t,e){return console.log("This method is used for developing only, please use the launch method instead"),P.killAll(t),I.APP[t]&&I.APP[t].style&&$(I.APP[t].style).remove(),I.APP[t]=void 0,x.launch(t,e)},loadApp:function(t,e,n){var r;return r="os:///packages/"+t,I.setting.system.packages[t].path&&(r=I.setting.system.packages[t].path),(r+"/main.js").asFileHandler().read(function(n){return(r+"/package.json").asFileHandler().read(function(n){var i,o,a,s,u;if(n.path=r,I.APP[t]&&(I.APP[t].meta=n),n.services)for(o=0,a=(s=n.services).length;o<a;o++)u=s[o],I.APP[u].meta=n;return(i=r+"/main.css").asFileHandler().onready(function(n){var r;return r=$("<link>",{rel:"stylesheet",type:"text/css",href:A.handler.get+"/"+i}).appendTo("head"),I.APP[t]&&(I.APP[t].style=r[0]),e(t)},function(){return e(t)})},"json")},"script")},launch:function(t,e){return I.APP[t]?I.APP[t]?P.createProcess(t,I.APP[t],e):void 0:x.loadApp(t,function(t){return P.createProcess(t,I.APP[t],e)},function(t,e){})},dock:function(t,e){var n,r;return n={icon:null,iconclass:e.iconclass||"",app:t,onbtclick:function(){return t.toggle()}},e.icon&&(n.icon=A.handler.get+"/"+e.path+"/"+e.icon),e.icon||e.iconclass||(n.iconclass="fa fa-cogs"),r=$("#sysdock"),t.one("rendered",function(){return r.get(0).newapp(n),t.sysdock=r.get(0),t.appmenu=$("[data-id = 'appmenu']","#syspanel")[0]}),t.init()},toggleFullscreen:function(){var t;if(t=$("body")[0],x.fullscreen){if(document.exitFullscreen)return document.exitFullscreen();if(document.mozCancelFullScreen)return document.mozCancelFullScreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen();if(document.cancelFullScreen)return document.cancelFullScreen()}else{if(t.requestFullscreen)return t.requestFullscreen();if(t.mozRequestFullScreen)return t.mozRequestFullScreen();if(t.webkitRequestFullscreen)return t.webkitRequestFullscreen();if(t.msRequestFullscreen)return t.msRequestFullscreen()}},undock:function(t){return $("#sysdock").get(0).removeapp(t)},attachservice:function(t){return $("#syspanel")[0].attachservice(t),t.init()},detachservice:function(t){return $("#syspanel")[0].detachservice(t)},bindContextMenu:function(t){var e;return(e=function(n){var r;return n.contextmenuHandler?n.contextmenuHandler(t,$("#contextmenu")[0]):(r=$(n).parent().get(0))!==$("#workspace").get(0)?e(r):void 0})(t.target),t.preventDefault()},bindKey:function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),x.shortcut[i]))return x.shortcut[i][r]=e},initDM:function(){return $(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){return x.fullscreen=!x.fullscreen}),A.resource("schemes/dm.html",function(t){var e,n,r;return t?(r=$.parseHTML(t),$("#wrapper").append(r),V.observable.one("sysdockloaded",function(){return $(window).bind("keydown",function(t){var e,n,r,i;if((r=$("#sysdock")[0])&&(e=r.get("selectedApp"),n=String.fromCharCode(t.which).toUpperCase(),i=void 0,t.ctrlKey?i="CTRL":t.metaKey?i="META":t.shiftKey?i="SHIFT":t.altKey&&(i="ALT"),i)){if(!(!e||e.shortcut(i,n,t)))return t.preventDefault();if(x.shortcut[i]&&x.shortcut[i][n])return x.shortcut[i][n](t),t.preventDefault()}})}),riot.mount($("#syspanel",$("#wrapper"))),riot.mount($("#sysdock",$("#wrapper")),{items:[]}),riot.mount($("#contextmenu")),$("#workspace").contextmenu(function(t){return x.bindContextMenu(t)}),e=$("#desktop"),n=I.setting.desktop.path.asFileHandler(),e[0].fetch=function(){var t;return t=function(){return n.read(function(t){var n;return t.error?V.osfail(t.error,A.throwe("OS.VFS"),t.error):(n=[],$.each(t.result,function(t,e){if("."!==e.filename[0]||I.setting.desktop.showhidden)return e.text=e.filename,e.iconclass=e.type,n.push(e)}),e[0].set("items",n),e[0].refresh())})},n.onready(function(){return t()},function(e){var r;return console.log(n.path+" not found"),r=n.basename,n.parent().asFileHandler().mk(r,function(e){var n;return n=A.throwe("OS.VFS"),e.error?V.osfail(d.error,n,d.error):t()})})},e[0].ready=function(t){return t.observable=V,window.onresize=function(){return V.trigger("desktopresize"),t.refresh()},e[0].set("onlistselect",function(t){return $("#sysdock").get(0).set("selectedApp",null)}),e[0].set("onlistdbclick",function(t){var n;return $("#sysdock").get(0).set("selectedApp",null),n=e[0].get("selected"),x.openWith(n)}),e.on("click",function(t){if(t.target===e[0])return e[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null)}),e[0].contextmenuHandler=function(t,n){var r,i,o;return t.target===e[0]&&e[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null),i=(i=[{text:"Open",dataid:"desktop-open"},{text:"Refresh",dataid:"desktop-refresh"}]).concat(function(){var t,e;for(r in e=[],t=I.setting.desktop.menu)o=t[r],e.push(o);return e}()),n.set("items",i),n.set("onmenuselect",function(t){var n;switch(t.item.data.dataid){case"desktop-open":return(n=e[0].get("selected"))?x.openWith(n):((n=I.setting.desktop.path.asFileHandler()).mime="dir",x.openWith(n));case"desktop-refresh":return e[0].fetch();default:if(t.item.data.app)return x.launch(t.item.data.app,t.item.data.args)}}),n.show(t)},e[0].fetch(),V.observable.on("VFS",function(t){if(t.data.file.hash()===n.hash()||t.data.file.parent().hash()===n.hash())return e[0].fetch()}),V.ostrigger("desktoploaded")},riot.mount(e)):null},function(t,e){return alert("System fall: Cannot init desktop manager"),console.log(e,t)})},refreshSystemMenu:function(){var t,e,n,r;for(t in x.SYS_MENU.length=1,x.SYS_MENU[0].child.length=0,e=I.setting.system.packages)(r=e[t])&&r.app&&x.SYS_MENU[0].child.push(r);for(t in n=I.setting.system.menu)r=n[t],x.SYS_MENU.push(r);return x.SYS_MENU.push({text:"Toggle Full screen",dataid:"os-fullsize",iconclass:"fa fa-tv"}),x.SYS_MENU.push({text:"Log out",dataid:"sys-logout",iconclass:"fa fa-user-times"})},buildSystemMenu:function(){var t;return(t={text:"",iconclass:"fa fa-eercast",dataid:"sys-menu-root",child:x.SYS_MENU}).onmenuselect=function(t){return"sys-logout"===t.item.data.dataid?I.exit():"os-fullsize"===t.item.data.dataid?x.toggleFullscreen():t.item.data.dataid?void 0:x.launch(t.item.data.app)},t=[t],$("[data-id = 'os_menu']","#syspanel")[0].set("items",t)},login:function(){return I.cleanup(),A.resource("schemes/login.html",function(t){var e;return t?(e=$.parseHTML(t),$("#wrapper").append(e),$("#btlogin").click(function(){var t;return t={username:$("#txtuser").val(),password:$("#txtpass").val()},A.handler.login(t,function(t){return t.error?$("#login_error").html(t.error):x.startAntOS(t.result)})}),$("#txtpass").keyup(function(t){if(13===t.which)return $("#btlogin").click()})):null},function(t,e){return alert("System fall: Cannot init login screen")})},startAntOS:function(t){return I.cleanup(),I.systemSetting(t),x.loadTheme(I.setting.appearance.theme),x.initDM(),V.observable.one("syspanelloaded",function(){return A.packages.cache(function(t){if(t.result)return A.packages.fetch(function(t){var e,n,r,i,o,a,s,u;if(t.result)for(r in o=t.result)(u=o[r]).text=u.name,u.filename=r,u.type="app",u.mime="antos/app",u.iconclass||u.icon||(u.iconclass="fa fa-adn");for(I.setting.system.packages=t.result?t.result:void 0,x.refreshSystemMenu(),x.buildSystemMenu(),x.pushServices(function(){var t,e,n,r;for(r=[],t=0,e=(n=I.setting.system.startup.services).length;t<e;t++)u=n[t],r.push(u);return r}()),s=[],n=0,i=(a=I.setting.system.startup.apps).length;n<i;n++)e=a[n],s.push(x.launch(e));return s})})})}},s=function(){function t(t,e){var n;this.name=t,this.args=e,this.observable=riot.observable(),this._api=D.OS.API,this._gui=D.OS.GUI,this.systemsetting=D.OS.setting,n=this,this.on("exit",function(){return n.quit()}),this.host="#desktop",this.dialog=void 0}return t.prototype.render=function(t){return x.loadScheme(t,this,this.host)},t.prototype.quit=function(){var t;if(t=new x.BaseEvent("exit"),this.onexit(t),!t.prevent)return delete this.observable,this.dialog&&this.dialog.quit(),P.kill(this)},t.prototype.path=function(){var t;return(t=this.meta())&&t.path?t.path:null},t.prototype.init=function(){},t.prototype.onexit=function(t){},t.prototype.one=function(t,e){return this.observable.one(t,e)},t.prototype.on=function(t,e){return this.observable.on(t,e)},t.prototype.trigger=function(t,e){return this.observable.trigger(t,e)},t.prototype.subscribe=function(t,e){return V.on(t,e,this)},t.prototype.openDialog=function(t,e,n,r){if(this.dialog)this.dialog.show();else{if(x.subwindows[t])return this.dialog=new x.subwindows[t],this.dialog.parent=this,this.dialog.handler=e,this.dialog.pid=this.pid,this.dialog.data=r,this.dialog.title=n,this.dialog.init();this.error("Dialog "+t+" not found")}},t.prototype.publish=function(t,e){var n;return n=this.meta(),V.trigger(t,{id:this.pid,name:this.name,data:{m:e,icon:n.icon,iconclass:n.iconclass}})},t.prototype.notify=function(t){return this.publish("notification",t)},t.prototype.warn=function(t){return this.publish("warning",t)},t.prototype.error=function(t){return this.publish("error",t+this._api.throwe(this.name))},t.prototype.fail=function(t){return this.publish("fail",t)},t.prototype.throwe=function(){return this._api.throwe(this.name)},t.prototype.find=function(t){if(this.scheme)return $("[data-id='"+t+"']",this.scheme)[0]},t.prototype.select=function(t){if(this.scheme)return $(t,this.scheme)},t}(),this.OS.GUI.BaseModel=s,(n=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),I.setting.applications[this.name]||(I.setting.applications[this.name]={}),this.setting=I.setting.applications[this.name],this.keycomb={ALT:{},CTRL:{},SHIFT:{},META:{}}}return T(e,t),e.prototype.init=function(){var t,e;return t=this,this.subscribe("appregistry",function(e){if(e.name===t.name)return t.applySetting(e.data.m)}),this.on("focus",function(){if(t.sysdock.set("selectedApp",t),t.appmenu.pid=t.pid,t.appmenu.set("items",t.baseMenu()||[]),t.appmenu.set("onmenuselect",function(e){return t.trigger("menuselect",e)}),t.dialog)return t.dialog.show()}),this.on("hide",function(){if(t.sysdock.set("selectedApp",null),t.appmenu.set("items",[]),t.dialog)return t.dialog.hide()}),this.on("menuselect",function(e){switch(e.e.item.data.dataid){case t.name+"-about":return t.openDialog("AboutDialog",function(){});case t.name+"-exit":return t.trigger("exit")}}),e=this.meta().path+"/scheme.html",this.render(e)},e.prototype.bindKey=function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),this.keycomb[i]))return this.keycomb[i][r]=e},e.prototype.shortcut=function(t,e,n){return!this.keycomb[t]||(!this.keycomb[t][e]||(this.keycomb[t][e](n),!1))},e.prototype.applySetting=function(t){},e.prototype.registry=function(t,e){return this.setting[t]=e,this.publish("appregistry",t)},e.prototype.show=function(){return this.trigger("focus")},e.prototype.blur=function(){return this.appmenu&&this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),this.trigger("blur")},e.prototype.hide=function(){return this.trigger("hide")},e.prototype.toggle=function(){return this.trigger("toggle")},e.prototype.onexit=function(t){if(this.cleanup(t),!t.prevent)return this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),$(this.scheme).remove()},e.prototype.meta=function(){return I.APP[this.name].meta},e.prototype.baseMenu=function(){return[{text:I.APP[this.name].meta.name,child:[{text:"About",dataid:this.name+"-about"},{text:"Exit",dataid:this.name+"-exit"}]}].concat(this.menu()||[])},e.prototype.main=function(){},e.prototype.menu=function(){return[]},e.prototype.open=function(){},e.prototype.data=function(){},e.prototype.update=function(){},e.prototype.cleanup=function(t){},e}(this.OS.GUI.BaseModel)).type=1,this.OS.GUI.BaseApplication=n,(u=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),this.icon=void 0,this.iconclass="fa-paper-plane-o",this.text="",this.timer=void 0,this.holder=void 0}return T(e,t),e.prototype.init=function(){},e.prototype.meta=function(){return I.APP[this.name].meta},e.prototype.attach=function(t){return this.holder=t},e.prototype.update=function(){if(this.holder)return this.holder.update()},e.prototype.watch=function(t,e){var n,r;return r=this,(n=function(){return e(),r.timer=setTimeout(function(){return n()},t)})()},e.prototype.onexit=function(t){if(this.timer&&console.log("clean timer"),this.timer&&clearTimeout(this.timer),this.cleanup(t),this.scheme)return $(this.scheme).remove()},e.prototype.main=function(){},e.prototype.show=function(){},e.prototype.awake=function(t){},e.prototype.cleanup=function(t){},e}(this.OS.GUI.BaseModel)).type=2,u.singleton=!0,this.OS.GUI.BaseService=u,o=function(){function t(t){this.name=t,this.prevent=!1}return t.prototype.preventDefault=function(){return this.prevent=!0},t}(),this.OS.GUI.BaseEvent=o,(k=function(t){function e(t){e.__super__.constructor.call(this,t,null),this.parent=void 0,this.modal=!1}return T(e,t),e.prototype.quit=function(){var t;if(t=new x.BaseEvent("exit"),this.onexit(t),!t.prevent&&(delete this.observable,this.scheme&&$(this.scheme).remove(),this.dialog))return this.dialog.quit()},e.prototype.init=function(){},e.prototype.main=function(){},e.prototype.meta=function(){return this.parent.meta()},e.prototype.show=function(){return this.trigger("focus"),$(this.scheme).css("z-index",window._zindex+2)},e.prototype.hide=function(){return this.trigger("hide")},e}(this.OS.GUI.BaseModel)).type=3,this.OS.GUI.SubWindow=k,i=function(t){function e(t){e.__super__.constructor.call(this,t),this.handler=void 0}return T(e,k),e.prototype.onexit=function(t){if(this.parent)return this.parent.dialog=void 0},e}(),this.OS.GUI.BaseDialog=i,c=function(t){function e(t,n,r){this.conf=n,this.title=r,e.__super__.constructor.call(this,t)}return T(e,i),e.prototype.init=function(){var t,e,n,r,i;for(e in this.title||(this.title=this.name),t="<afx-app-window  data-id = 'dia-window' apptitle='"+this.title+"' width='"+this.conf.width+"' height='"+this.conf.height+"'> <afx-vbox>",n=this.conf.tags)t+="<"+(i=n[e]).tag+" "+i.att+" style = 'margin-left:5px; margin-right:5px;' data-id = 'content"+e+"'></"+i.tag+">";for(e in t+="<div data-height = '35' style=' text-align:right;padding-top:3px;'>",r=this.conf.buttons)t+="<afx-button data-id = 'bt"+e+"' text = '"+(i=r[e]).label+"' style='margin-right:5px;'></afx-button>";return t+="</div></afx-vbox></afx-app-window>",x.htmlToScheme(t,this,this.host)},e.prototype.main=function(){var t,e,n,r,i;for(e in this.scheme.set("minimizable",!1),void 0!==this.conf.resizable&&this.scheme.set("resizable",this.conf.resizable),n=this,t=function(t){return function(){return t.onclick(n)}},r=this.conf.buttons)i=r[e],n.find("bt"+e).set("onbtclick",t(i));if(this.conf.filldata&&this.conf.filldata(this),this.conf.xtra)return this.conf.xtra(this)},e}(),this.OS.GUI.BasicDialog=c,b=function(t){function e(){e.__super__.constructor.call(this,"PromptDialog",{tags:[{tag:"afx-label",att:"data-height = '20'"},{tag:"input",att:"type = 'text'"}],width:200,height:100,resizable:!1,buttons:[{label:"0k",onclick:function(t){var e;return""===(e=t.find("content1").value)?t.quit():(t.handler&&t.handler(e),t.quit())}},{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("text",t.data.label),t.data.value?t.find("content1").value=t.data.value:void 0},xtra:function(t){return $(t.find("content1")).keyup(function(e){if(13===e.which)return t.find("bt0").trigger()})}})}return T(e,c),e}(),this.OS.register("PromptDialog",b),p=function(t){function e(){e.__super__.constructor.call(this,"CalendarDialog",{tags:[{tag:"afx-calendar-view"}],width:300,height:220,resizable:!1,buttons:[{label:"Ok",onclick:function(t){var e;return(e=t.find("content0").get("selectedDate"))?(t.handler&&t.handler(e),t.quit()):t.notify("Please select a date")}},{label:"Cancel",onclick:function(t){return t.quit()}}]})}return T(e,c),e}(),this.OS.register("CalendarDialog",p),h=function(t){function e(){e.__super__.constructor.call(this,"ColorPickerDialog",{tags:[{tag:"afx-color-picker"}],width:313,height:220,resizable:!1,buttons:[{label:"Ok",onclick:function(t){var e;return(e=t.find("content0").get("selectedColor"))?(t.handler&&t.handler(e),t.quit()):t.notify("Please select a color")}},{label:"Cancel",onclick:function(t){return t.quit()}}]})}return T(e,c),e}(),this.OS.register("ColorPickerDialog",h),v=function(t){function e(){e.__super__.constructor.call(this,"InfoDialog",{tags:[{tag:"afx-grid-view"}],width:250,height:300,resizable:!0,buttons:[{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){var e,n,r,i;if(t.data){for(e in r=[],n=t.data)i=n[e],r.push([{value:e},{value:i}]);return t.find("content0").set("rows",r)}}})}return T(e,c),e}(),this.OS.register("InfoDialog",v),O=function(t){function e(){e.__super__.constructor.call(this,"YesNoDialog",{tags:[{tag:"afx-label",att:"style = 'padding-left:10px;'"}],width:300,height:100,resizable:!0,buttons:[{label:"Yes",onclick:function(t){return t.handler&&t.handler(!0),t.quit()}},{label:"No",onclick:function(t){return t.handler&&t.handler(!1),t.quit()}}],filldata:function(t){var e,n,r,i,o;if(t.data){for(e in n=t.find("content0"),i=[],r=t.data)o=r[e],i.push(n.set(e,o));return i}}})}return T(e,c),e}(),this.OS.register("YesNoDialog",O),w=function(t){function e(){e.__super__.constructor.call(this,"SelectionDialog",{tags:[{tag:"afx-list-view"}],width:250,height:300,resizable:!1,buttons:[{label:"Ok",onclick:function(t){var e;if(e=t.find("content0").get("selected"))return t.handler&&t.handler(e),t.quit()}},{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("items",t.data)},xtra:function(t){return t.find("content0").set("onlistdbclick",function(e){return t.find("bt0").trigger()})}})}return T(e,c),e}(),this.OS.register("SelectionDialog",w),t=function(t){function e(){e.__super__.constructor.call(this,"AboutDialog")}return T(e,i),e.prototype.init=function(){return this.render("os:///resources/schemes/about.html")},e.prototype.main=function(){var t,e,n,r,i;if(e=this.meta(),this.scheme.set("apptitle","About: "+e.name),this.find("mylabel").set("*",{icon:e.icon,iconclass:e.iconclass,text:e.name+"(v"+e.version+")"}),$(this.find("mydesc")).html(e.description),e.info){for(t in r=[],n=e.info)i=n[t],r.push([{value:t},{value:i}]);return this.find("mygrid").set("rows",r)}},e}(),this.OS.register("AboutDialog",t),g=function(t){function e(){e.__super__.constructor.call(this,"FileDiaLog")}return T(e,i),e.prototype.init=function(){return this.render("os:///resources/schemes/filedialog.html")},e.prototype.main=function(){var t,e,n,r,i;if(e=this.find("fileview"),r=this.find("location"),t=this.find("filename"),i=this,this.scheme.set("apptitle",""+this.title),e.set("fetch",function(t,e){if(t.child)return t.child.path.asFileHandler().read(function(n){return n.error?i.error("Resource not found "+t.child.path):e(n.result)})}),r.set("onlistselect",function(t){if(t&&t.data.path)return t.data.path.asFileHandler().read(function(n){return n.error?i.error("Resource not found "+t.data.path):(e.set("path",t.data.path),e.set("data",n.result))})}),r.set("items",function(){var t,e,r,i;for(i=[],t=0,e=(r=this.systemsetting.VFS.mountpoints).length;t<e;t++)"app"!==(n=r[t]).type&&i.push(n);return i}.call(this)),r.get("selected")||r.set("selected",0),e.set("onfileselect",function(e){if("file"===e.type)return $(t).val(e.filename)}),this.find("bt-ok").set("onbtclick",function(n){var r,o,a,s,u,c,l;if(!(o=e.get("selectedFile")))return i.notify("Please select a file");if(i.data&&i.data.mimes){for(u=!1,a=0,s=(c=i.data.mimes).length;a<s;a++)if(l=c[a],o.mime.match(new RegExp(l,"g"))){u=!0;break}if(!u)return i.notify("Only "+i.data.mimes.join(",")+" could be selected")}return r=o.path,"file"===o.type&&(r=o.path.asFileHandler().parent()),i.handler&&i.handler(r,$(t).val(),o.path),i.quit()}),this.find("bt-cancel").set("onbtclick",function(t){return i.quit()}),this.data&&this.data.file)return $(t).css("display","block").val(this.data.file.basename||"Untitled"),this.trigger("resize")},e}(),this.OS.register("FileDiaLog",g),x=D.OS.GUI,A=D.OS.API,P=D.OS.PM,I=D.OS,V=D.OS.courrier,this.onload=function(){return D.OS.boot()}}).call(this);