(function(){var t,e,n,i,o,s,a,u,c,l,p,h,f,g,m,y,v,b,S,w,k,F,O,x,P,A,_,I,V,D,T=function(t,e){for(var n in e)q.call(e,n)&&(t[n]=e[n]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},q={}.hasOwnProperty;(D=this).OS||(D.OS={API:{},GUI:{},APP:{},setting:{user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},courrier:{observable:riot.observable(),quota:0,listeners:new Object,on:function(t,e,n){return V.listeners[n.pid]||(V.listeners[n.pid]=[]),V.listeners[n.pid].push({e:t,f:e}),V.observable.on(t,e)},trigger:function(t,e){return V.observable.trigger(t,e)},osfail:function(t,e,n){return V.ostrigger("fail",{m:t,e:e,s:n})},oserror:function(t,e,n){return V.ostrigger("error",{m:t,e:e,s:n})},osinfo:function(t){return V.ostrigger("info",{m:t,e:null,s:null})},ostrigger:function(t,e){return V.trigger(t,{id:0,data:e,name:"OS"})},unregister:function(t){var e,n,r,i;if(V.listeners[t.pid]&&V.listeners[t.pid].length>0){for(n=0,r=(i=V.listeners[t.pid]).length;n<r;n++)e=i[n],V.observable.off(e.e,e.f);return delete V.listeners[t.pid],V.listeners[t.pid]=[]}},getMID:function(){return V.quota+=1,V.quota}},register:function(t,e){return 3===e.type?D.OS.GUI.subwindows[t]=e:A.APP[t]=e},PM:{pidalloc:0,processes:{},createProcess:function(t,e,n){var r,i,o;return r=function(){var r;if(e.singleton&&_.processes[t]&&1===_.processes[t].length?_.processes[t][0].show():(_.processes[t]||(_.processes[t]=[]),(r=new e(n)).birth=(new Date).getTime(),_.pidalloc++,r.pid=_.pidalloc,_.processes[t].push(r),1===e.type?P.dock(r,e.meta):P.attachservice(r)),2===e.type)return V.trigger("srvroutineready",t)},e.dependencies?(i=function(){var t,n,r,i;for(i=[],t=0,n=(r=e.dependencies).length;t<n;t++)o=r[t],i.push(o);return i}(),x.requires(i,r)):r()},appByPid:function(t){var e,n,r,i;for(r in e=void 0,n=function(e){var n,r,i;for(r=0,i=e.length;r<i;r++)if((n=e[r]).pid===t)return n},i=_.processes)if(e=n(i[r]))break;return e},kill:function(t){var e;if(t.name&&_.processes[t.name])return(e=_.processes[t.name].indexOf(t))>=0?(1===A.APP[t.name].type?P.undock(t):P.detachservice(t),V.unregister(t),delete _.processes[t.name][e],_.processes[t.name].splice(e,1)):void 0},killAll:function(t){var e,n,r,i,o,s,a,u;if(_.processes[t]){for(a=[],n=0,r=(o=_.processes[t]).length;n<r;n++)e=o[n],a.push(e);for(s=[],u=0,i=a.length;u<i;u++)e=a[u],s.push(e.quit());return s}}},cleanup:function(){return console.log("Clean up system"),$("#wrapper").empty(),P.clearTheme(),V.observable=riot.observable(),V.quota=0,A.APP={},A.setting={user:{},applications:{},desktop:{},appearance:{},VFS:{},system:{}},_.processes={},_.pidalloc=0},boot:function(){return console.log("Booting sytem"),x.handler.auth(function(t){return t.error?P.login():P.startAntOS(t.result)})}}),String.prototype.hash=function(){var t,e;for(t=5381,e=this.length;e;)t=33*t^this.charCodeAt(--e);return t>>>0},String.prototype.asBase64=function(){var t;return t=encodeURIComponent(this),btoa(t.replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}))},String.prototype.unescape=function(){return this.replace(/\\\\/g,"\\").replace(/\\"/g,'"').replace(/\\n/g,"\n").replace(/\\t/g,"\t").replace(/\\b/g,"\b").replace(/\\f/g,"\f").replace(/\\r/g,"\r")},Date.prototype.toString=function(){var t,e,n,r,i,o;return t=this.getDate(),r=this.getMonth()+1,o=this.getFullYear(),t<10&&(t="0"+t),r<10&&(r="0"+r),(e=this.getHours())<10&&(e="0"+e),(n=this.getMinutes())<10&&(n="0"+n),(i=this.getSeconds())<10&&(i="0"+i),t+"/"+r+"/"+o+" "+e+":"+n+":"+i},Date.prototype.timestamp=function(){return this.getTime()/1e3|0},D.OS.API={handler:{},shared:{},post:function(t,e,n,r){var i;return i=V.getMID(),x.loading(i,t),$.ajax({type:"POST",url:t,contentType:"application/json",data:JSON.stringify(e,{dataType:"json",success:null})}).done(function(e){return x.loaded(i,t,"OK"),n(e)}).fail(function(e,n){return x.loaded(i,t,"FAIL"),r(e,n)})},blob:function(t,e,n){var r,i;return r=V.getMID(),(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(i){return 200===this.status&&4===this.readyState?(e(this.response),x.loaded(r,t,"OK")):(n(i,this),x.loaded(r,t,"FAIL"))},x.loading(r,t),i.send()},upload:function(t,e,n,r){var i,o;return o=V.getMID(),(i=$("<input>").attr("type","file").css("display","none")).change(function(){var s;return x.loading(o,t),(s=new FormData).append("path",e),s.append("upload",i[0].files[0]),$.ajax({url:t,data:s,type:"POST",contentType:!1,processData:!1}).done(function(e){return x.loaded(o,t,"OK"),n(e),i.remove()}).fail(function(e,n){return x.loaded(o,t,"FAIL"),r(e,n),i.remove()})}),i.click()},saveblob:function(t,e){var n,r;return r=window.URL.createObjectURL(e),(n=$("<a>").attr("href",r).attr("download",t).css("display","none").appendTo("body"))[0].click(),window.URL.revokeObjectURL(r),n.remove()},systemConfig:function(){return x.request("config",function(t){return console.log(t)})},loading:function(t,e){return V.trigger("loading",{id:t,data:{m:""+e,s:!0},name:"OS"})},loaded:function(t,e,n){return V.trigger("loaded",{id:t,data:{m:n+": "+e,s:!1},name:"OS"})},get:function(t,e,n,r){var i,o;return i={type:"GET",url:t},r&&(i.dataType=r),o=V.getMID(),x.loading(o,t),$.ajax(i).done(function(n){return x.loaded(o,t,"OK"),e(n)}).fail(function(e,r){return x.loaded(o,t,"FAIL"),n(e,r)})},script:function(t,e,n){var r;return r=V.getMID(),x.loading(r,t),$.getScript(t).done(function(n){return x.loaded(r,t,"OK"),e(n)}).fail(function(e,i){return x.loaded(r,t,"FAIL"),n(e,i)})},resource:function(t,e,n){var r;return r="resources/"+t,x.get(r,e,n)},libready:function(t){return x.shared[t]||!1},require:function(t,e){var n,i;return x.shared[t]?(console.log(t,"Library exist, no need to load"),V.trigger("sharedlibraryloaded",t)):t.match(/^(https?:\/\/[^\s]+)/g)?x.script(t,function(){if(x.shared[t]=!0,V.trigger("sharedlibraryloaded",t),e)return e()},function(e,n){return V.oserror("Cannot load 3rd library at: "+t,e,r)}):(n=""+(i="os:///scripts/")+t+".js").asFileHandler().onready(function(r){var o;if(x.shared[t]=!0,$("<script>",{src:x.handler.get+"/"+n}).appendTo("head"),(o=""+i+t+".css").asFileHandler().onready(function(t){return $("<link>",{rel:"stylesheet",type:"text/css",href:x.handler.get+"/"+o}).appendTo("head")},function(){}),console.log("loaded",t),V.trigger("sharedlibraryloaded",t),e)return e()})},requires:function(t,e){return t.length>0?(V.observable.one("sharedlibraryloaded",function(n){return t.splice(0,1),x.requires(t,e)}),x.require(t[0],null)):e()},packages:{fetch:function(t){return x.handler.packages({command:"list",args:{paths:A.setting.system.pkgpaths}},t)},cache:function(t){return x.handler.packages({command:"cache",args:{paths:A.setting.system.pkgpaths}},t)}},throwe:function(t){var e;e=void 0;try{throw new Error(t)}catch(t){e=t}return e||""}},D.OS.systemSetting=function(t){if(t.desktop&&(A.setting.desktop=t.desktop),t.applications&&(A.setting.applications=t.applications),t.appearance&&(A.setting.appearance=t.appearance),A.setting.user=t.user,t.VFS&&(A.setting.VFS=t.VFS),A.setting.desktop.path||(A.setting.desktop.path="home:///.desktop"),A.setting.desktop.menu||(A.setting.desktop.menu={}),A.setting.VFS.mountpoints||(A.setting.VFS.mountpoints=[{text:"Applications",path:"app:///",iconclass:"fa  fa-adn",type:"app"},{text:"Home",path:"home:///",iconclass:"fa fa-home",type:"fs"},{text:"Desktop",path:A.setting.desktop.path,iconclass:"fa fa-desktop",type:"fs"},{text:"OS",path:"os:///",iconclass:"fa fa-inbox",type:"fs"},{text:"Google Drive",path:"gdv:///",iconclass:"fa fa-inbox",type:"fs"},{text:"Shared",path:"shared:///",iconclass:"fa fa-share-square",type:"fs"}]),t.system&&(A.setting.system=t.system),A.setting.system.startup||(A.setting.system.startup={services:["CoreServices/PushNotification","CoreServices/UserService","CoreServices/Calendar","CoreServices/Spotlight"],apps:[]}),A.setting.system.pkgpaths||(A.setting.system.pkgpaths=["home:///.packages","os:///packages"]),A.setting.system.menu||(A.setting.system.menu={}),A.setting.system.repositories||(A.setting.system.repositories=[]),A.setting.appearance.theme||(A.setting.appearance.theme="antos"),!A.setting.VFS.gdrive)return A.setting.VFS.gdrive={CLIENT_ID:"",API_KEY:"",apilink:"https://apis.google.com/js/api.js",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES:"https://www.googleapis.com/auth/drive"}},D.OS.API.HOST=D.location.hostname+(D.location.port?":"+D.location.port:""),D.OS.API.REST=D.location.protocol+"//"+D.OS.API.HOST+"/lua-api/os",I=D.OS.API.REST,D.OS.API.handler={get:I+"/fs/get",shared:I+"/fs/shared",scandir:function(t,e){var n;return n=I+"/fs/scandir",x.post(n,{path:t},e,function(e,n){return V.osfail("Fail to scan directory: "+t,e,n)})},mkdir:function(t,e){var n;return n=I+"/fs/mkdir",x.post(n,{path:t},e,function(e,n){return V.osfail("Fail to create directory: "+t,e,n)})},sharefile:function(t,e,n){var r;return r=I+"/fs/publish",x.post(r,{path:t,publish:e},n,function(e,n){return V.osfail("Fail to publish file: "+t,e,n)})},fileinfo:function(t,e){var n;return n=I+"/fs/fileinfo",x.post(n,{path:t},e,function(e,n){return V.osfail("Fail to get file metadata: "+t,e,n)})},readfile:function(t,e,n){var r;return r=I+"/fs/get/",x.get(r+t,e,function(e,n){return V.osfail("Fail to read file: "+t,e,n)},n)},move:function(t,e,n){var r;return r=I+"/fs/move",x.post(r,{src:t,dest:e},n,function(t,n){return V.osfail("Fail to move file: "+n+" -> "+e,t,n)})},delete:function(t,e){var n;return n=I+"/fs/delete",x.post(n,{path:t},e,function(e,n){return V.osfail("Fail to delete: "+t,e,n)})},fileblob:function(t,e){var n;return n=I+"/fs/get/",x.blob(n+t,e,function(e,n){return V.osfail("Fail to read file: "+t,e,n)})},packages:function(t,e){var n;return n=I+"/system/packages",x.post(n,t,e,function(e,n){return V.osfail("Fail to "+t.command+" package",e,n)})},upload:function(t,e){var n;return n=I+"/fs/upload",x.upload(n,t,e,function(e,n){return V.osfail("Fail to upload file to: "+t,e,n)})},write:function(t,e,n){var r;return r=I+"/fs/write",x.post(r,{path:t,data:e},n,function(e,n){return V.osfail("Fail to write to file: "+t,e,n)})},scanapp:function(t,e){return I+"/system/application"},auth:function(t){var e;return e=I+"/system/auth",x.post(e,{},t,function(){return alert("Resource not found: "+e)})},login:function(t,e){var n;return n=I+"/system/login",x.post(n,t,e,function(){return alert("Resource not found: "+n)})},logout:function(){return x.handler.setting(function(){var t;return t=I+"/system/logout",x.post(t,{},function(t){return A.boot()},function(){return alert("Resource not found "+t)})})},setting:function(t){var e;return e=I+"/system/settings",x.post(e,A.setting,function(e){if(e.error&&V.oserror("Cannot save system setting",e.error),t)return t()},function(n,r){if(V.osfail("Fail to make request: "+e,n,r),t)return t()})},dbquery:function(t,e,n){var r;return r=I+"/db/"+t,x.post(r,e,n,function(t,e){return V.osfail("Fail to query data from database: "+r,t,e)})}},String.prototype.asFileHandler=function(){var t,e;return e=this.split(":///"),(t=x.VFS.findHandlers(e[0]))&&0!==t.length?new t[0](this):(V.osfail("VFS unknown handler: "+this,x.throwe("OS.VFS"),this),null)},this.OS.API.VFS={handlers:{},register:function(t,e){return D.OS.API.VFS.handlers[t]=e},findHandlers:function(t){var e,n;return function(){var r,i;for(e in i=[],r=x.VFS.handlers)n=r[e],t.trim().match(new RegExp(e,"g"))&&i.push(n);return i}()}},s=function(){function t(t){this.dirty=!1,this.cache=void 0,this.setPath(t)}return t.prototype.setPath=function(t){var e,n;if(this.ready=!1,t&&(this.path=t.toString(),e=this.path.split(":///"),this.protocol=e[0],e.length>1&&""!==(n=e[1].replace(/^\/+|\/+$/g,""))))return this.genealogy=n.split("/"),this.isRoot()||(this.basename=this.genealogy[this.genealogy.length-1]),0!==this.basename.lastIndexOf(".")&&-1!==this.basename.indexOf(".")?this.ext=this.basename.split(".").pop():void 0},t.prototype.isRoot=function(){return!this.genealogy||0===this.genealogy.size},t.prototype.child=function(t){return this.isRoot()?this.path+t:this.path+"/"+t},t.prototype.isHidden=function(){return!!this.basename&&"."===this.basename[0]},t.prototype.hash=function(){return this.path?this.path.hash():-1},t.prototype.sendB64=function(t,e){var n,r,i;if(r=this,this.cache)return"string"==typeof this.cache?(n=this.cache.asBase64(),e(n="data:"+t+";base64,"+n)):((i=new FileReader).readAsDataURL(this.cache),i.onload=function(){return e(i.result)},i.onerror=function(t){return V.osfail("Cannot ecode file: "+r.path,x.throwe("OS.VFS"),t)})},t.prototype.parent=function(){return this.isRoot()?this:this.protocol+":///"+this.genealogy.slice(0,this.genealogy.length-1).join("/")},t.prototype.onready=function(t,e){var n;return this.ready?t():(n=this).meta(function(r){return r.error?e?e(r):V.osfail(n.path+": "+r.error,x.throwe("OS.VFS"),r.error):(n.info=r.result,n.ready=!0,t())})},t.prototype.read=function(t,e){var n;return n=this,this.onready(function(){return n.action("read",e,t)})},t.prototype.write=function(t,e){var n;return n=this,this.action("write",t,function(t){return t.result&&V.ostrigger("VFS",{m:"write",file:n}),e(t)})},t.prototype.mk=function(t,e){var n;return n=this,this.onready(function(){return n.action("mk",t,function(t){return t.result&&V.ostrigger("VFS",{m:"mk",file:n}),e(t)})})},t.prototype.remove=function(t){var e;return e=this,this.onready(function(){return e.action("remove",null,function(n){return n.result&&V.ostrigger("VFS",{m:"remove",file:e}),t(n)})})},t.prototype.upload=function(t){var e;return e=this,this.onready(function(){return e.action("upload",null,function(n){return n.result&&V.ostrigger("VFS",{m:"upload",file:e}),t(n)})})},t.prototype.publish=function(t){var e;return e=this,this.onready(function(){return e.action("publish",null,function(n){return n.result&&V.ostrigger("VFS",{m:"publish",file:e}),t(n)})})},t.prototype.download=function(t){var e;return e=this,this.onready(function(){return e.action("download",null,t)})},t.prototype.move=function(t,e){var n;return n=this,this.onready(function(){return n.action("move",t,function(n){return n.result&&V.ostrigger("VFS",{m:"move",file:t.asFileHandler()}),e(n)})})},t.prototype.execute=function(t){var e;return e=this,this.onready(function(){return e.action("execute",null,t)})},t.prototype.meta=function(t){},t.prototype.action=function(t,e,n){return V.osfail("VFS unknown action: "+t,x.throwe("OS.VFS"),t)},t}(),D.OS.API.VFS.BaseFileHandler=s,S=function(t){function e(t){e.__super__.constructor.call(this,t)}return T(e,t),e.prototype.meta=function(t){return x.handler.fileinfo(this.path,t)},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return"dir"===this.info.type?x.handler.scandir(this.path,n):x.handler.readfile(this.path,n,e||"text");case"mk":return"file"===this.info.type?n({error:this.path+" is not a directory"}):x.handler.mkdir(this.path+"/"+e,n);case"write":return this.sendB64(e,function(t){return x.handler.write(r.path,t,n)});case"upload":if("file"===this.info.type)return;return x.handler.upload(this.path,n);case"remove":return x.handler.delete(this.path,n);case"publish":return x.handler.sharefile(this.path,!0,n);case"download":if("dir"===this.info.type)return;return x.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),x.saveblob(r.basename,e)});case"move":return x.handler.move(this.path,e,n);default:return V.osfail("VFS unknown action: "+t,x.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^(home|desktop|os|Untitled)$",S),e=function(t){function e(t){e.__super__.constructor.call(this,t),this.basename&&(this.info=A.setting.system.packages[this.basename]),this.ready=!0}return T(e,t),e.prototype.meta=function(t){return t()},e.prototype.action=function(t,e,n){var r,i;switch(this,t){case"read":if(this.info)return n({result:this.info});if(!this.isRoot())return;return n({result:function(){var t,e;for(r in e=[],t=A.setting.system.packages)i=t[r],e.push(i);return e}()});case"mk":case"write":case"upload":case"remove":case"publish":case"download":case"move":break;default:return V.osfail("VFS unknown action: "+t,x.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^app$",e),l=function(t){function e(t,n,r){e.__super__.constructor.call(this,t),r&&(this.cache=r),this.info={mime:n,path:t,size:r?r.length:0,name:this.basename,type:"file"}}return T(e,t),e.prototype.meta=function(t){return t()},e.prototype.onchange=function(t){return this.onchange=t},e.prototype.action=function(t,e,n){var r;switch(this,t){case"read":return n({result:this.cache});case"mk":break;case"write":return this.cache=e,this.onchange&&this.onchange(this),n({result:!0});case"upload":case"remove":case"publish":break;case"download":return r=new Blob([this.cache],{type:"octet/stream"}),x.saveblob(this.basename,r);case"move":break;default:return V.osfail("VFS unknown action: "+t,x.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^blob$",l),k=function(t){function e(t){e.__super__.constructor.call(this,t),this.isRoot()&&(this.ready=!0)}return T(e,t),e.prototype.meta=function(t){return x.handler.fileinfo(this.path,t)},e.prototype.action=function(t,e,n){var r;switch(r=this,t){case"read":return this.isRoot()?x.get(x.handler.shared+"/all",n,function(t,e){}):x.handler.readfile(this.path,n,e||"text");case"mk":break;case"write":return x.handler.write(this.path,e,n);case"remove":return x.handler.sharefile(this.basename,!1,n);case"upload":break;case"publish":return n({result:this.basename});case"download":if("dir"===this.info.type)return;return x.handler.fileblob(this.path,function(t){var e;return e=new Blob([t],{type:"octet/stream"}),x.saveblob(r.basename,e)});case"move":break;default:return V.osfail("VFS unknown action: "+t,x.throwe("OS.VFS"),t)}},e}(D.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^shared$",k),m={"gdv:///":"root"},y=function(t){function e(t){if(e.__super__.constructor.call(this,t),this,this.setting=A.setting.VFS.gdrive,!this.setting)return V.oserror("Unknown API setting for google drive VFS",x.throwe("OS.VFS"),null);this.isRoot()&&(this.gid="root"),this.cache=""}return T(e,t),e.prototype.oninit=function(t){var e;if(e=this,this.setting)return x.libready(this.setting.apilink)?t():x.require(this.setting.apilink,function(){return gapi.load("client:auth2",function(){return gapi.client.init({apiKey:e.setting.API_KEY,clientId:e.setting.CLIENT_ID,discoveryDocs:e.setting.DISCOVERY_DOCS,scope:e.setting.SCOPES}).then(function(){var e;return e=function(e){return e?t():(m={"gdv:///":"root"},gapi.auth2.getAuthInstance().signIn())},gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){return e(t)}),e(gapi.auth2.getAuthInstance().isSignedIn.get())})})})},e.prototype.meta=function(t){var e;return e=this,this.oninit(function(){var n;return m[e.path]&&(e.gid=m[e.path]),e.gid?gapi.client.drive.files.get({fileId:e.gid,fields:e.fields()}).then(function(e){if(e.result)return t(e)}):(n=e.parent().asFileHandler()).meta(function(r){var i;return i=r.result,m[n.path]=i.id,gapi.client.drive.files.list({q:"name = '"+e.basename+"' and '"+i.id+"' in parents and trashed = false",fields:"files("+e.fields()+")"}).then(function(n){if(n.result.files&&n.result.files.length>0)return m[e.path]=n.result.files[0].id,t({result:n.result.files[0]})})})})},e.prototype.fields=function(){return"webContentLink, id, name,mimeType,description, kind, parents, properties, iconLink, createdTime, modifiedTime, owners, permissions, fullFileExtension, fileExtension, size"},e.prototype.isFolder=function(){return"application/vnd.google-apps.folder"===this.info.mimeType},e.prototype.save=function(t,e,n){var r,i,o,s,a;return i=this,o=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,s="https://www.googleapis.com/upload/drive/v3/files/"+t+"?uploadType=media",(a=new XMLHttpRequest).open("PATCH",s),a.setRequestHeader("Authorization","Bearer "+o),a.setRequestHeader("Content-Type",e),a.setRequestHeader("Content-Encoding","base64"),a.setRequestHeader("Content-Transfer-Encoding","base64"),r=function(t,e){return V.oserror("VFS cannot save : "+i.path,t,e)},a.onreadystatechange=function(){if(4===a.readyState)return 200===a.status?n({result:JSON.parse(a.responseText)}):r(a,a.status)},a.onerror=function(){return r(a,a.status)},this.sendB64(e,function(t){return a.send(t.replace(/^data:[^;]+;base64,/g,""))})},e.prototype.action=function(t,e,n){var r,i,o,s,a,u;switch(s=this,t){case"read":if(!this.info.id)return;return this.isFolder()?gapi.client.drive.files.list({q:"'"+s.info.id+"' in parents and trashed = false",fields:"files("+s.fields()+")"}).then(function(t){var e,r,i,o;if(t.result.files){for(r=0,i=(o=t.result.files).length;r<i;r++)(e=o[r]).path=s.child(e.name),e.mime=e.mimeType,e.filename=e.name,e.type="file",e.gid=e.id,"application/vnd.google-apps.folder"===e.mimeType&&(e.mime="dir",e.type="dir",e.size=0);return n({result:t.result.files})}}):gapi.client.drive.files.get({fileId:s.info.id,alt:"media"}).then(function(t){return n(t.body)});case"mk":if(!this.isFolder())return n({error:this.path+" is not a directory"});a={name:e,parents:[this.info.id],mimeType:"application/vnd.google-apps.folder"},gapi.client.drive.files.create({resource:a,fields:"id"}).execute(function(t){return t&&t.result?(m[s.child(e)]=t.result.id,n(t)):V.oserror("VFS cannot create : "+e,x.throwe("OS.VFS"),t)});break;case"write":return(o=m[s.path])?this.save(o,e,n):(console.log("New file"),(i=this.parent().asFileHandler()).onready(function(){return a={name:s.basename,mimeType:e,parents:[i.info.id]},gapi.client.drive.files.create({resource:a,fields:"id"}).execute(function(t){return t&&t.result?(m[s.path]=t.result.id,s.save(t.result.id,e,n)):V.oserror("VFS cannot write : "+s.path,x.throwe("OS.VFS"),t)})}));case"upload":if(!this.isFolder())return;return V.getMID(),(u=$("<input>").attr("type","file").css("display","none")).change(function(){var t,e;return e=u[0].files[0],(t=s.child(e.name).asFileHandler()).cache=e,t.write(e.type,n),u.remove()}),u.click();case"remove":if(!this.info.id)return;return gapi.client.drive.files.delete({fileId:s.info.id}).execute(function(t){return t?(m[s.path]=null,n({result:!0})):V.oserror("VFS cannot delete : "+s.path,x.throwe("OS.VFS"),t)});case"publish":break;case"download":return gapi.client.drive.files.get({fileId:s.info.id,alt:"media"}).then(function(t){var e;return t.body?(e=new Blob([t.body],{type:"octet/stream"}),x.saveblob(s.basename,e)):V.oserror("VFS cannot get file : "+s.path,x.throwe("OS.VFS"),t)});case"move":return(r=e.asFileHandler().parent().asFileHandler()).onready(function(){var t;return t=s.info.parents.join(","),gapi.client.drive.files.update({fileId:s.info.id,addParents:r.info.id,removeParents:t,fields:"id"}).execute(function(t){return t?n(t):V.oserror("VFS cannot move : "+s.path,x.throwe("OS.VFS"),t)})});default:return V.osfail("VFS unknown action: "+t,x.throwe("OS.VFS"),t)}},e}(this.OS.API.VFS.BaseFileHandler),D.OS.API.VFS.register("^gdv$",y),f=function(){function t(t){this.table=t}return t.prototype.save=function(t,e){return x.handler.dbquery("save",{table:this.table,data:t},e)},t.prototype.delete=function(t,e){var n;return n={table:this.table},t&&""!==t?(isNaN(t)?n.cond=t:n.id=t,x.handler.dbquery("delete",n,e)):V.oserror("Unknown condition for delete command",x.throwe("OS.DB"),t)},t.prototype.get=function(t,e){return x.handler.dbquery("get",{table:this.table,id:t},e)},t.prototype.find=function(t,e){return x.handler.dbquery("select",{table:this.table,cond:t},e)},t}(),D.OS.API.DB=f,D.OS.GUI={subwindows:new Object,dialog:void 0,htmlToScheme:function(t,e,n){var r;return r=$.parseHTML(t),$(n).append(r),riot.mount($(r),{observable:e.observable}),e.scheme=r[0],e.main(),e.show()},loadScheme:function(t,e,n){return t.asFileHandler().read(function(t){return t?P.htmlToScheme(t,e,n):null})},clearTheme:function(){return $("head link#ostheme").attr("href","")},loadTheme:function(t,e){var n;return e&&P.clearTheme(),n="resources/themes/"+t+"/"+t+".css",$("head link#ostheme").attr("href",n)},pushServices:function(t){if(t.length>0)return V.observable.one("srvroutineready",function(){return t.splice(0,1),P.pushServices(t)}),P.pushService(t[0])},openDialog:function(t,e,n,r){var i;if(!P.dialog)return P.subwindows[t]?(P.dialog=new P.subwindows[t],P.dialog.parent=P,P.dialog.handler=e,P.dialog.pid=-1,P.dialog.data=r,P.dialog.title=n,P.dialog.init()):(i=x.throwe("Dialog"),V.oserror("Dialog "+t+" not found",i,null));P.dialog.show()},pushService:function(t){var e,n,r;return n=t.split("/"),r=n[1],e=n[0],A.APP[r]?_.createProcess(r,A.APP[r]):P.loadApp(e,function(t){if(A.APP[r])return _.createProcess(r,A.APP[r])},function(t,e){return V.trigger("srvroutineready",r),V.osfail("Cannot read service script: "+r+" ",t,e)})},appsByMime:function(t){var e,n,r,i,o,s,a,u,c,l;for(u=function(){var t,e;for(o in e=[],t=A.setting.system.packages)(l=t[o]).app&&e.push(l);return e}(),c=function(){var t,e,n;for(n=[],t=0,e=u.length;t<e;t++)(a=u[t])&&n.push(a.mimes);return n}(),e=[],n=function(n,r){var i;try{return n.filter(function(n,i){return!!t.match(new RegExp(n,"g"))&&(e.push(u[r]),!1)})}catch(e){return i=e,V.osfail("Find app by mimes "+t,i,t)}},r=i=0,s=c.length;i<s;r=++i)(a=c[r])&&n(a,r);return e},appsWithServices:function(){var t,e,n,r;for(t in e={},n=A.setting.system.packages)(r=n[t]).services&&r.services.length>0&&(e[t]=r);return e},openWith:function(t){var e,n,r;if(t)return"app"===t.type&&t.app?P.launch(t.app):"app"===t.type?V.osinfo("Application"+t.text+" is not executable"):0===(e=P.appsByMime("dir"===t.type?"dir":t.mime)).length?V.osinfo("No application available to open "+t.filename):1===e.length?P.launch(e[0].app,[t.path]):(r=function(){var t,r,i;for(i=[],t=0,r=e.length;t<r;t++)n=e[t],i.push({text:n.app,icon:n.icon,iconclass:n.iconclass});return i}(),P.openDialog("SelectionDialog",function(e){return P.launch(e.text,[t.path])},"Open width",r))},forceLaunch:function(t,e){return console.log("This method is used for developing only, please use the launch method instead"),_.killAll(t),A.APP[t]&&A.APP[t].style&&$(A.APP[t].style).remove(),A.APP[t]=void 0,P.launch(t,e)},loadApp:function(t,e,n){var r;return r="os:///packages/"+t,A.setting.system.packages[t].path&&(r=A.setting.system.packages[t].path),(r+"/main.js").asFileHandler().read(function(n){return(r+"/package.json").asFileHandler().read(function(n){var i,o,s,a,u;if(n.path=r,A.APP[t]&&(A.APP[t].meta=n),n.services)for(o=0,s=(a=n.services).length;o<s;o++)u=a[o],A.APP[u].meta=n;return(i=r+"/main.css").asFileHandler().onready(function(n){var r;return r=$("<link>",{rel:"stylesheet",type:"text/css",href:x.handler.get+"/"+i}).appendTo("head"),A.APP[t]&&(A.APP[t].style=r[0]),e(t)},function(){return e(t)})},"json")},"script")},launch:function(t,e){return A.APP[t]?A.APP[t]?_.createProcess(t,A.APP[t],e):void 0:P.loadApp(t,function(t){return _.createProcess(t,A.APP[t],e)},function(t,e){})},dock:function(t,e){var n,r;return n={icon:null,iconclass:e.iconclass||"",app:t,onbtclick:function(){return t.toggle()}},e.icon&&(n.icon=x.handler.get+"/"+e.path+"/"+e.icon),e.icon||e.iconclass||(n.iconclass="fa fa-cogs"),r=$("#sysdock"),t.one("rendered",function(){return r.get(0).newapp(n),t.sysdock=r.get(0),t.appmenu=$("[data-id = 'appmenu']","#syspanel")[0]}),t.init()},enterFullscreen:function(){var t;return(t=$("body")[0]).requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():void 0},undock:function(t){return $("#sysdock").get(0).removeapp(t)},attachservice:function(t){return $("#syspanel")[0].attachservice(t),t.init()},detachservice:function(t){return $("#syspanel")[0].detachservice(t)},bindContextMenu:function(t){var e;return(e=function(n){var r;return n.contextmenuHandler?n.contextmenuHandler(t,$("#contextmenu")[0]):(r=$(n).parent().get(0))!==$("#workspace").get(0)?e(r):void 0})(t.target),t.preventDefault()},initDM:function(){return x.resource("schemes/dm.html",function(t){var e,n,r;return t?(r=$.parseHTML(t),$("#wrapper").append(r),V.observable.one("sysdockloaded",function(){return $(window).bind("keydown",function(t){var e,n,r,i;if(r=$("#sysdock")[0]){if(!(e=r.get("selectedApp")))return!0;if(n=String.fromCharCode(t.which).toUpperCase(),i=void 0,t.ctrlKey?i="CTRL":t.metaKey?i="META":t.shiftKey?i="SHIFT":t.altKey&&(i="ALT"),i)return e.shortcut(i,n)?void 0:t.preventDefault()}})}),riot.mount($("#syspanel",$("#wrapper"))),riot.mount($("#sysdock",$("#wrapper")),{items:[]}),riot.mount($("#contextmenu")),$("#workspace").contextmenu(function(t){return P.bindContextMenu(t)}),e=$("#desktop"),n=A.setting.desktop.path.asFileHandler(),e[0].fetch=function(){var t;return t=function(){return n.read(function(t){var n;return t.error?V.osfail(t.error,x.throwe("OS.VFS"),t.error):(n=[],$.each(t.result,function(t,e){if("."!==e.filename[0]||A.setting.desktop.showhidden)return e.text=e.filename,e.iconclass=e.type,n.push(e)}),e[0].set("items",n),e[0].refresh())})},n.onready(function(){return t()},function(e){var r;return console.log(n.path+" not found"),r=n.basename,n.parent().asFileHandler().mk(r,function(e){var n;return n=x.throwe("OS.VFS"),e.error?V.osfail(d.error,n,d.error):t()})})},e[0].ready=function(t){return t.observable=V,window.onresize=function(){return V.trigger("desktopresize"),t.refresh()},e[0].set("onlistselect",function(t){return $("#sysdock").get(0).set("selectedApp",null)}),e[0].set("onlistdbclick",function(t){var n;return $("#sysdock").get(0).set("selectedApp",null),n=e[0].get("selected"),P.openWith(n)}),e.on("click",function(t){if(t.target===e[0])return e[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null)}),e[0].contextmenuHandler=function(t,n){var r,i,o;return t.target===e[0]&&e[0].set("selected",-1),$("#sysdock").get(0).set("selectedApp",null),i=(i=[{text:"Open",dataid:"desktop-open"},{text:"Refresh",dataid:"desktop-refresh"}]).concat(function(){var t,e;for(r in e=[],t=A.setting.desktop.menu)o=t[r],e.push(o);return e}()),n.set("items",i),n.set("onmenuselect",function(t){var n;switch(t.item.data.dataid){case"desktop-open":return(n=e[0].get("selected"))?P.openWith(n):((n=A.setting.desktop.path.asFileHandler()).mime="dir",P.openWith(n));case"desktop-refresh":return e[0].fetch();default:if(t.item.data.app)return P.launch(t.item.data.app,t.item.data.args)}}),n.show(t)},e[0].fetch(),V.observable.on("VFS",function(t){if(t.data.file.hash()===n.hash()||t.data.file.parent().hash()===n.hash())return e[0].fetch()}),V.ostrigger("desktoploaded")},riot.mount(e)):null},function(t,e){return alert("System fall: Cannot init desktop manager"),console.log(e,t)})},buildSystemMenu:function(){var t,e,n;return(e={text:"",iconclass:"fa fa-eercast",dataid:"sys-menu-root",child:[{text:"Application",child:function(){var e,r;for(t in r=[],e=A.setting.system.packages)(n=e[t]).app&&r.push(n);return r}(),dataid:"sys-apps",iconclass:"fa fa-adn",onmenuselect:function(t){return P.launch(t.item.data.app)}}]}).child=e.child.concat(function(){var e,r;for(t in r=[],e=A.setting.system.menu)n=e[t],r.push(n);return r}()),e.child.push({text:"Full screen",dataid:"os-fullsize",iconclass:"fa fa-tv"}),e.child.push({text:"Log out",dataid:"sys-logout",iconclass:"fa fa-user-times"}),e.onmenuselect=function(t){return"sys-logout"===t.item.data.dataid?x.handler.logout():"os-fullsize"===t.item.data.dataid?P.enterFullscreen():t.item.data.dataid?void 0:P.launch(t.item.data.app)},$("[data-id = 'os_menu']","#syspanel")[0].set("items",[e])},login:function(){return A.cleanup(),x.resource("schemes/login.html",function(t){var e;return t?(e=$.parseHTML(t),$("#wrapper").append(e),$("#btlogin").click(function(){var t;return t={username:$("#txtuser").val(),password:$("#txtpass").val()},x.handler.login(t,function(t){return t.error?$("#login_error").html(t.error):P.startAntOS(t.result)})}),$("#txtpass").keyup(function(t){if(13===t.which)return $("#btlogin").click()})):null},function(t,e){return alert("System fall: Cannot init login screen")})},startAntOS:function(t){return A.cleanup(),A.systemSetting(t),P.loadTheme(A.setting.appearance.theme),P.initDM(),V.observable.one("syspanelloaded",function(){return x.packages.cache(function(t){if(t.result)return x.packages.fetch(function(t){var e,n,r,i,o,s,a,u;if(t.result)for(r in o=t.result)(u=o[r]).text=u.name,u.filename=r,u.type="app",u.mime="antos/app",u.iconclass||u.icon||(u.iconclass="fa fa-adn");for(A.setting.system.packages=t.result?t.result:void 0,P.buildSystemMenu(),P.pushServices(function(){var t,e,n,r;for(r=[],t=0,e=(n=A.setting.system.startup.services).length;t<e;t++)u=n[t],r.push(u);return r}()),a=[],n=0,i=(s=A.setting.system.startup.apps).length;n<i;n++)e=s[n],a.push(P.launch(e));return a})})})}},a=function(){function t(t,e){var n;this.name=t,this.args=e,this.observable=riot.observable(),this._api=D.OS.API,this._gui=D.OS.GUI,this.systemsetting=D.OS.setting,n=this,this.on("exit",function(){return n.quit()}),this.host="#desktop",this.dialog=void 0}return t.prototype.render=function(t){return P.loadScheme(t,this,this.host)},t.prototype.quit=function(){var t;if(t=new P.BaseEvent("exit"),this.onexit(t),!t.prevent)return delete this.observable,this.dialog&&this.dialog.quit(),_.kill(this)},t.prototype.path=function(){var t;return(t=this.meta())&&t.path?t.path:null},t.prototype.init=function(){},t.prototype.onexit=function(t){},t.prototype.one=function(t,e){return this.observable.one(t,e)},t.prototype.on=function(t,e){return this.observable.on(t,e)},t.prototype.trigger=function(t,e){return this.observable.trigger(t,e)},t.prototype.subscribe=function(t,e){return V.on(t,e,this)},t.prototype.openDialog=function(t,e,n,r){if(this.dialog)this.dialog.show();else{if(P.subwindows[t])return this.dialog=new P.subwindows[t],this.dialog.parent=this,this.dialog.handler=e,this.dialog.pid=this.pid,this.dialog.data=r,this.dialog.title=n,this.dialog.init();this.error("Dialog "+t+" not found")}},t.prototype.publish=function(t,e){var n;return n=this.meta(),V.trigger(t,{id:this.pid,name:this.name,data:{m:e,icon:n.icon,iconclass:n.iconclass}})},t.prototype.notify=function(t){return this.publish("notification",t)},t.prototype.warn=function(t){return this.publish("warning",t)},t.prototype.error=function(t){return this.publish("error",t+this._api.throwe(this.name))},t.prototype.fail=function(t){return this.publish("fail",t)},t.prototype.throwe=function(){return this._api.throwe(this.name)},t.prototype.find=function(t){if(this.scheme)return $("[data-id='"+t+"']",this.scheme)[0]},t.prototype.select=function(t){if(this.scheme)return $(t,this.scheme)},t}(),this.OS.GUI.BaseModel=a,(n=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),A.setting.applications[this.name]||(A.setting.applications[this.name]={}),this.setting=A.setting.applications[this.name],this.keycomb={ALT:{},CTRL:{},SHIFT:{},META:{}}}return T(e,t),e.prototype.init=function(){var t,e;return t=this,this.subscribe("appregistry",function(e){if(e.name===t.name)return t.applySetting(e.data.m)}),this.on("focus",function(){if(t.sysdock.set("selectedApp",t),t.appmenu.pid=t.pid,t.appmenu.set("items",t.baseMenu()||[]),t.appmenu.set("onmenuselect",function(e){return t.trigger("menuselect",e)}),t.dialog)return t.dialog.show()}),this.on("hide",function(){if(t.sysdock.set("selectedApp",null),t.appmenu.set("items",[]),t.dialog)return t.dialog.hide()}),this.on("menuselect",function(e){switch(e.e.item.data.dataid){case t.name+"-about":return t.openDialog("AboutDialog",function(){});case t.name+"-exit":return t.trigger("exit")}}),e=this.meta().path+"/scheme.html",this.render(e)},e.prototype.bindKey=function(t,e){var n,r,i;if(2===(n=t.split("-")).length&&(i=n[0].toUpperCase(),r=n[1].toUpperCase(),this.keycomb[i]))return this.keycomb[i][r]=e},e.prototype.shortcut=function(t,e){return!this.keycomb[t]||(!this.keycomb[t][e]||(this.keycomb[t][e](),!1))},e.prototype.applySetting=function(t){},e.prototype.registry=function(t,e){return this.setting[t]=e,this.publish("appregistry",t)},e.prototype.show=function(){return this.trigger("focus")},e.prototype.blur=function(){return this.appmenu&&this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),this.trigger("blur")},e.prototype.hide=function(){return this.trigger("hide")},e.prototype.toggle=function(){return this.trigger("toggle")},e.prototype.onexit=function(t){if(this.cleanup(t),!t.prevent)return this.pid===this.appmenu.pid&&this.appmenu.set("items",[]),$(this.scheme).remove()},e.prototype.meta=function(){return A.APP[this.name].meta},e.prototype.baseMenu=function(){return[{text:A.APP[this.name].meta.name,child:[{text:"About",dataid:this.name+"-about"},{text:"Exit",dataid:this.name+"-exit"}]}].concat(this.menu()||[])},e.prototype.main=function(){},e.prototype.menu=function(){return[]},e.prototype.open=function(){},e.prototype.data=function(){},e.prototype.update=function(){},e.prototype.cleanup=function(t){},e}(this.OS.GUI.BaseModel)).type=1,this.OS.GUI.BaseApplication=n,(u=function(t){function e(t,n){e.__super__.constructor.call(this,t,n),this.icon=void 0,this.iconclass="fa-paper-plane-o",this.text="",this.timer=void 0,this.holder=void 0}return T(e,t),e.prototype.init=function(){},e.prototype.meta=function(){return A.APP[this.name].meta},e.prototype.attach=function(t){return this.holder=t},e.prototype.update=function(){if(this.holder)return this.holder.update()},e.prototype.watch=function(t,e){var n,r;return r=this,(n=function(){return e(),r.timer=setTimeout(function(){return n()},t)})()},e.prototype.onexit=function(t){if(this.timer&&console.log("clean timer"),this.timer&&clearTimeout(this.timer),this.cleanup(t),this.scheme)return $(this.scheme).remove()},e.prototype.main=function(){},e.prototype.show=function(){},e.prototype.awake=function(t){},e.prototype.cleanup=function(t){},e}(this.OS.GUI.BaseModel)).type=2,u.singleton=!0,this.OS.GUI.BaseService=u,o=function(){function t(t){this.name=t,this.prevent=!1}return t.prototype.preventDefault=function(){return this.prevent=!0},t}(),this.OS.GUI.BaseEvent=o,(F=function(t){function e(t){e.__super__.constructor.call(this,t,null),this.parent=void 0,this.modal=!1}return T(e,t),e.prototype.quit=function(){var t;if(t=new P.BaseEvent("exit"),this.onexit(t),!t.prevent&&(delete this.observable,this.scheme&&$(this.scheme).remove(),this.dialog))return this.dialog.quit()},e.prototype.init=function(){},e.prototype.main=function(){},e.prototype.meta=function(){return this.parent.meta()},e.prototype.show=function(){return this.trigger("focus"),$(this.scheme).css("z-index",window._zindex+2)},e.prototype.hide=function(){return this.trigger("hide")},e}(this.OS.GUI.BaseModel)).type=3,this.OS.GUI.SubWindow=F,i=function(t){function e(t){e.__super__.constructor.call(this,t),this.handler=void 0}return T(e,F),e.prototype.onexit=function(t){if(this.parent)return this.parent.dialog=void 0},e}(),this.OS.GUI.BaseDialog=i,c=function(t){function e(t,n,r){this.conf=n,this.title=r,e.__super__.constructor.call(this,t)}return T(e,i),e.prototype.init=function(){var t,e,n,r,i;for(e in this.title||(this.title=this.name),t="<afx-app-window  data-id = 'dia-window' apptitle='"+this.title+"' width='"+this.conf.width+"' height='"+this.conf.height+"'> <afx-vbox>",n=this.conf.tags)t+="<"+(i=n[e]).tag+" "+i.att+" style = 'margin-left:5px; margin-right:5px;' data-id = 'content"+e+"'></"+i.tag+">";for(e in t+="<div data-height = '35' style=' text-align:right;padding-top:3px;'>",r=this.conf.buttons)t+="<afx-button data-id = 'bt"+e+"' text = '"+(i=r[e]).label+"' style='margin-right:5px;'></afx-button>";return t+="</div></afx-vbox></afx-app-window>",P.htmlToScheme(t,this,this.host)},e.prototype.main=function(){var t,e,n,r,i;for(e in this.scheme.set("minimizable",!1),void 0!==this.conf.resizable&&this.scheme.set("resizable",this.conf.resizable),n=this,t=function(t){return function(){return t.onclick(n)}},r=this.conf.buttons)i=r[e],n.find("bt"+e).set("onbtclick",t(i));if(this.conf.filldata&&this.conf.filldata(this),this.conf.xtra)return this.conf.xtra(this)},e}(),this.OS.GUI.BasicDialog=c,b=function(t){function e(){e.__super__.constructor.call(this,"PromptDialog",{tags:[{tag:"afx-label",att:"data-height = '20'"},{tag:"input",att:"type = 'text'"}],width:200,height:100,resizable:!1,buttons:[{label:"0k",onclick:function(t){var e;return""===(e=t.find("content1").value)?t.quit():(t.handler&&t.handler(e),t.quit())}},{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("text",t.data.label),t.data.value?t.find("content1").value=t.data.value:void 0},xtra:function(t){return $(t.find("content1")).keyup(function(e){if(13===e.which)return t.find("bt0").trigger()})}})}return T(e,c),e}(),this.OS.register("PromptDialog",b),p=function(t){function e(){e.__super__.constructor.call(this,"CalendarDialog",{tags:[{tag:"afx-calendar-view"}],width:300,height:220,resizable:!1,buttons:[{label:"Ok",onclick:function(t){var e;return(e=t.find("content0").get("selectedDate"))?(t.handler&&t.handler(e),t.quit()):t.notify("Please select a date")}},{label:"Cancel",onclick:function(t){return t.quit()}}]})}return T(e,c),e}(),this.OS.register("CalendarDialog",p),h=function(t){function e(){e.__super__.constructor.call(this,"ColorPickerDialog",{tags:[{tag:"afx-color-picker"}],width:313,height:220,resizable:!1,buttons:[{label:"Ok",onclick:function(t){var e;return(e=t.find("content0").get("selectedColor"))?(t.handler&&t.handler(e),t.quit()):t.notify("Please select a color")}},{label:"Cancel",onclick:function(t){return t.quit()}}]})}return T(e,c),e}(),this.OS.register("ColorPickerDialog",h),v=function(t){function e(){e.__super__.constructor.call(this,"InfoDialog",{tags:[{tag:"afx-grid-view"}],width:250,height:300,resizable:!0,buttons:[{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){var e,n,r,i;if(t.data){for(e in r=[],n=t.data)i=n[e],r.push([{value:e},{value:i}]);return t.find("content0").set("rows",r)}}})}return T(e,c),e}(),this.OS.register("InfoDialog",v),O=function(t){function e(){e.__super__.constructor.call(this,"YesNoDialog",{tags:[{tag:"afx-label",att:"style = 'padding-left:10px;'"}],width:300,height:100,resizable:!0,buttons:[{label:"Yes",onclick:function(t){return t.handler&&t.handler(!0),t.quit()}},{label:"No",onclick:function(t){return t.handler&&t.handler(!1),t.quit()}}],filldata:function(t){var e,n,r,i,o;if(t.data){for(e in n=t.find("content0"),i=[],r=t.data)o=r[e],i.push(n.set(e,o));return i}}})}return T(e,c),e}(),this.OS.register("YesNoDialog",O),w=function(t){function e(){e.__super__.constructor.call(this,"SelectionDialog",{tags:[{tag:"afx-list-view"}],width:250,height:300,resizable:!1,buttons:[{label:"Ok",onclick:function(t){var e;if(e=t.find("content0").get("selected"))return t.handler&&t.handler(e),t.quit()}},{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){if(t.data)return t.find("content0").set("items",t.data)},xtra:function(t){return t.find("content0").set("onlistdbclick",function(e){return t.find("bt0").trigger()})}})}return T(e,c),e}(),this.OS.register("SelectionDialog",w),t=function(t){function e(){e.__super__.constructor.call(this,"AboutDialog")}return T(e,i),e.prototype.init=function(){return this.render("os:///resources/schemes/about.html")},e.prototype.main=function(){var t,e,n,r,i;if(e=this.meta(),this.scheme.set("apptitle","About: "+e.name),this.find("mylabel").set("*",{icon:e.icon,iconclass:e.iconclass,text:e.name+"(v"+e.version+")"}),$(this.find("mydesc")).html(e.description),e.info){for(t in r=[],n=e.info)i=n[t],r.push([{value:t},{value:i}]);return this.find("mygrid").set("rows",r)}},e}(),this.OS.register("AboutDialog",t),g=function(t){function e(){e.__super__.constructor.call(this,"FileDiaLog")}return T(e,i),e.prototype.init=function(){return this.render("os:///resources/schemes/filedialog.html")},e.prototype.main=function(){var t,e,n,r,i;if(e=this.find("fileview"),r=this.find("location"),t=this.find("filename"),i=this,this.scheme.set("apptitle",""+this.title),e.set("fetch",function(t,e){if(t.child)return t.child.path.asFileHandler().read(function(n){return n.error?i.error("Resource not found "+t.child.path):e(n.result)})}),r.set("onlistselect",function(t){if(t&&t.data.path)return t.data.path.asFileHandler().read(function(n){return n.error?i.error("Resource not found "+t.data.path):(e.set("path",t.data.path),e.set("data",n.result))})}),r.set("items",function(){var t,e,r,i;for(i=[],t=0,e=(r=this.systemsetting.VFS.mountpoints).length;t<e;t++)"app"!==(n=r[t]).type&&i.push(n);return i}.call(this)),r.get("selected")||r.set("selected",0),e.set("onfileselect",function(e){if("file"===e.type)return $(t).val(e.filename)}),this.find("bt-ok").set("onbtclick",function(n){var r,o,s,a,u,c,l;if(!(o=e.get("selectedFile")))return i.notify("Please select a file");if(i.data&&i.data.mimes){for(u=!1,s=0,a=(c=i.data.mimes).length;s<a;s++)if(l=c[s],o.mime.match(new RegExp(l,"g"))){u=!0;break}if(!u)return i.notify("Only "+i.data.mimes.join(",")+" could be selected")}return r=o.path,"file"===o.type&&(r=o.path.asFileHandler().parent()),i.handler&&i.handler(r,$(t).val(),o.path),i.quit()}),this.find("bt-cancel").set("onbtclick",function(t){return i.quit()}),this.data&&this.data.file)return $(t).css("display","block").val(this.data.file.basename||"Untitled"),this.trigger("resize")},e}(),this.OS.register("FileDiaLog",g),P=D.OS.GUI,x=D.OS.API,_=D.OS.PM,A=D.OS,V=D.OS.courrier,this.onload=function(){return D.OS.boot()}}).call(this);