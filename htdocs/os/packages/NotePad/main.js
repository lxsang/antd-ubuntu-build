(function(){var t,e,i,r=function(t,e){for(var i in e)n.call(e,i)&&(t[i]=e[i]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},n={}.hasOwnProperty;t=function(t){function e(t){e.__super__.constructor.call(this,t)}return r(e,t),e}(this.OS.GUI.BaseDialog),(i=function(e){function i(){i.__super__.constructor.call(this,"RemoteRunExtension")}return r(i,t),i.prototype.init=function(){return this._gui.htmlToScheme(i.scheme,this,this.host)},i.prototype.main=function(){var t;return t=this,this.output=this.find("output"),this.find("log-clear").set("onbtclick",function(e){return t.log("clean")}),this.find("restart").set("onbtclick",function(e){return t.run()}),this.socket=null,this.run()},i.prototype.log=function(t,e){var i;return"clean"===t?$(this.output).empty():(i=$("<p>").attr("class",t.toLowerCase())[0],$(i).html(t+": "+e.__()),$(this.output).append(i),$(this.output).scrollTop(this.output.scrollHeight))},i.prototype.run=function(){var t,e;return t=this,this.data?(this.gateway=this.gw(),this.gateway?($(this.find("stat")).html(this.data.path),this.socket&&this.socket.close(),e="https:"===window.location.protocol?"wss://":"ws://",this.socket=new WebSocket(e+this._api.HOST+this.gateway),this.socket.onopen=function(){return t.socket.send(JSON.stringify({path:t.data.path}))},this.socket.onmessage=function(e){if(e.data)return t.log("INFO",e.data)},this.socket.onclose=function(){return t.socket=null,console.log("socket closed")}):this.log("ERROR",__("No backend found for file: {0}",this.data.path))):this.log("ERROR",__("No target file found"))},i.prototype.gw=function(){var t,e,r;if(this.data){for(t in e=i.backends)if(r=e[t],this.data.info.mime.match(new RegExp(t,"g")))return r;return null}},i.prototype.cleanup=function(t){if(this.socket)return this.socket.close()},i}()).backends={"text/lua":"/system/apigateway?ws=1"},i.scheme='<afx-app-window apptitle="RemoteRun Ouput" width="300" height="450" data-id="win-remote-run">\n    <afx-vbox >\n        <afx-hbox data-height="20" data-id="bottom-vbox">\n            <afx-button data-id = "restart" data-width="25" iconclass="fa fa-repeat"></afx-button>\n            <afx-button data-id = "log-clear" data-width="25" iconclass="fa fa-trash"></afx-button>\n            <div data-id="stat"></div>\n        </afx-hbox>\n        <div data-id="output"></div>\n    </afx-vbox>\n</afx-app-window>',(e=function(t){function e(t){e.__super__.constructor.call(this,"NotePad",t)}return r(e,t),e.prototype.main=function(){var t,e,i,r,n,o,a,s,c,u,l,h,d,f,p;for(c=this,this.scheme.set("apptitle","NotePad"),this.sidebar=this.find("sidebar"),this.location=this.find("location"),this.fileview=this.find("fileview"),t=this.find("datarea"),ace.require("ace/ext/language_tools"),this.currfile=this.args&&this.args.length>0?this.args[0].asFileHandler():"Untitled".asFileHandler(),this.editor=ace.edit(t),this.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,fontSize:"9pt"}),this.editor.completers.push({getCompletions:function(t,e,i,r,n){}}),this.editor.getSession().setUseWrapMode(!0),this.fileview.contextmenuHandler=function(t,e){return e.set("items",c.contextMenu()),e.set("onmenuselect",function(t){return c.contextAction(t)}),e.show(t)},this.mlist=this.find("modelist"),this.modes=ace.require("ace/ext/modelist"),o=[],e=function(t,e){return o.push({text:t.name,mode:t.mode,selected:"ace/mode/text"===t.mode}),t.idx=e},u=this.modes.modes,i=r=0,a=u.length;r<a;i=++r)e(s=u[i],i);for(n in this.mlist.set("items",o),this.mlist.set("onlistselect",function(t){return c.editor.session.setMode(t.data.mode)}),f=this.find("themelist"),p=ace.require("ace/ext/themelist"),o=[],l=p.themesByName)s=l[n],o.push({text:s.caption,mode:s.theme,selected:"ace/theme/monokai"===s.theme});return f.set("onlistselect",function(t){return c.editor.setTheme(t.data.mode)}),f.set("items",o),h=this.find("editorstat"),(d=function(t){var e,i;return e=c.editor.session.selection.getCursor(),i=c.editor.session.getLength(),h.set("text",__("Row {0}, col {1}, lines: {2}",e.row,e.column,i))})(),this.editor.getSession().selection.on("changeCursor",function(t){return d()}),this.editormux=!1,this.editor.on("input",function(){return c.editormux?(c.editormux=!1,!1):c.currfile.dirty?void 0:(c.currfile.dirty=!0,c.currfile.text+="*",c.tabarea.update())}),this.on("resize",function(){return c.editor.resize()}),this.on("focus",function(){return c.editor.focus()}),this.fileview.set("chdir",function(t){return c.chdir(t)}),this.fileview.set("fetch",function(t,e){if(t.child&&"[..]"!==t.child.filename)return t.child.path.asFileHandler().read(function(i){return i.error?c.error(__("Resource not found {0}",t.child.path)):e(i.result)})}),this.fileview.set("onfileopen",function(t){if("dir"!==t.type)return c.open(t.path.asFileHandler())}),this.subscribe("VFS",function(t){var e;if(e=c.fileview.get("path").asFileHandler(),t.data.file.hash()===e.hash()||t.data.file.parent().hash()===e.hash())return c.chdir(e.path)}),this.location.set("onlistselect",function(t){return c.chdir(t.data.path)}),this.location.set("items",function(){var t,e,r,n;for(n=[],e=0,t=(r=this.systemsetting.VFS.mountpoints).length;e<t;e++)"app"!==(i=r[e]).type&&n.push(i);return n}.call(this)),this.location.get("selected")||this.location.set("selected",0),this.tabarea=this.find("tabarea"),this.tabarea.set("ontabselect",function(t){return c.selecteTab(t.idx)}),this.tabarea.set("onitemclose",function(t){var e;return!!(e=t.item.item)&&(e.dirty?(c.openDialog("YesNoDialog",function(t){return t?c.closeTab(e):c.editor.focus()},__("Close tab"),{text:__("Close without saving ?")}),!1):c.closeTab(e))}),this.bindKey("ALT-N",function(){return c.actionFile(c.name+"-New")}),this.bindKey("ALT-O",function(){return c.actionFile(c.name+"-Open")}),this.bindKey("CTRL-S",function(){return c.actionFile(c.name+"-Save")}),this.bindKey("ALT-W",function(){return c.actionFile(c.name+"-Saveas")}),this.bindKey("ALT-R",function(){return c.actionFile(c.name+"-Run")}),this.open(this.currfile)},e.prototype.open=function(t){var e,i;return-1!==(e=this.findTabByFile(t))?this.tabarea.set("selected",e):"Untitled"===t.path.toString()?this.newtab(t):(i=this,t.read(function(e){return t.cache=e||"",i.newtab(t)}))},e.prototype.contextMenu=function(){return[{text:__("New file"),dataid:this.name+"-mkf"},{text:__("New folder"),dataid:this.name+"-mkd"},{text:__("Delete"),dataid:this.name+"-rm"},{text:__("Refresh"),dataid:this.name+"-refresh"}]},e.prototype.contextAction=function(t){var e,i,r;switch(r=this,i=this.fileview.get("selectedFile"),e=i?i.path.asFileHandler():this.fileview.get("path").asFileHandler(),console.log(e),i&&"dir"!==i.type&&(e=e.parent().asFileHandler()),t.item.data.dataid){case this.name+"-mkd":return this.openDialog("PromptDialog",function(t){return e.mk(t,function(e){if(e.error)return r.error(__("Fail to create {0}: {1}",t,e.error))})},"__(New folder)");case this.name+"-mkf":return this.openDialog("PromptDialog",function(t){return(e.path+"/"+t).asFileHandler().write("",function(e){if(e.error)return r.error(__("Fail to create {0}: {1}",t,e.error))})},"__(New file)");case this.name+"-rm":if(!i)return;return this.openDialog("YesNoDialog",function(t){if(t)return i.path.asFileHandler().remove(function(t){if(t.error)return r.error(__("Fail to delete {0}: {1}",i.filename,t.error))})},"__(Delete)",{iconclass:"fa fa-question-circle",text:__("Do you really want to delete: {0}?",i.filename)});case this.name+"-refresh":return this.chdir(this.fileview.get("path"))}},e.prototype.save=function(t){var e;return e=this,t.write("text/plain",function(i){return i.error?e.error(__("Error saving file {0}",t.basename)):(t.dirty=!1,t.text=t.basename,e.tabarea.update())})},e.prototype.findTabByFile=function(t){var e,i,r;return r=this.tabarea.get("items"),0===(i=function(){var i,n,o;for(o=[],e=i=0,n=r.length;i<n;e=++i)r[e].hash()===t.hash()&&o.push(e);return o}()).length?-1:i[0]},e.prototype.closeTab=function(t){var e;return this.tabarea.remove(t,!1),0===(e=this.tabarea.get("count"))?(this.open("Untitled".asFileHandler()),!1):(this.tabarea.set("selected",e-1),!1)},e.prototype.newtab=function(t){return t.text=t.basename?t.basename:t.path,t.cache||(t.cache=""),t.um=new ace.UndoManager,this.currfile.selected=!1,t.selected=!0,this.tabarea.push(t,!0)},e.prototype.selecteTab=function(t){var e,i;if(e=this.tabarea.get("items")[t])return this.fileview.set("preventUpdate",!0),this.scheme.set("apptitle",e.text.toString()),this.currfile!==e&&(this.currfile.cache=this.editor.getValue(),this.currfile.cursor=this.editor.selection.getCursor(),this.currfile=e),i="ace/mode/text","Untitled"!==e.path.toString()&&(i=this.modes.getModeForPath(e.path)),this.mlist.set("selected",i.idx),this.editormux=!0,this.editor.setValue(e.cache,-1),this.editor.session.setMode(i.mode),this.editor.session.setUndoManager(e.um),e.cursor&&(this.editor.renderer.scrollCursorIntoView({row:e.cursor.row,column:e.cursor.column},.5),this.editor.selection.moveTo(e.cursor.row,e.cursor.column)),this.editor.focus()},e.prototype.chdir=function(t){var e,i;if(t)return i=this,(e=t.asFileHandler()).read(function(r){var n;return r.error?i.error(__("Resource not found {0}",n)):(e.isRoot()||((n=e.parent().asFileHandler()).filename="[..]",n.type="dir",r.result.unshift(n)),$(i.navinput).val(e.path),i.fileview.set("path",t),i.fileview.set("data",r.result))})},e.prototype.menu=function(){var t;return t=this,[{text:"__(File)",child:[{text:"__(New)",dataid:this.name+"-New",shortcut:"A-N"},{text:"__(Open)",dataid:this.name+"-Open",shortcut:"A-O"},{text:"__(Save)",dataid:this.name+"-Save",shortcut:"C-S"},{text:"__(Save as)",dataid:this.name+"-Saveas",shortcut:"A-W"},{text:"__(Run)",dataid:this.name+"-Run",shortcut:"A-R"}],onmenuselect:function(e){return t.actionFile(e.item.data.dataid)}}]},e.prototype.actionFile=function(t){var e,r;switch(e=this,r=function(){return e.openDialog("FileDiaLog",function(t,i){var r;return(r=(t+"/"+i).asFileHandler()).cache=e.currfile.cache,r.dirty=e.currfile.dirty,r.um=e.currfile.um,r.cursor=e.currfile.cursor,r.selected=e.currfile.selected,r.text=e.currfile.text,e.tabarea.replaceItem(e.currfile,r,!1),e.currfile=r,e.save(e.currfile)},"__(Save as)",{file:e.currfile})},t){case this.name+"-Open":return this.openDialog("FileDiaLog",function(t,i){return e.open((t+"/"+i).asFileHandler())},"__(Open file)");case this.name+"-Save":return this.currfile.cache=this.editor.getValue(),this.currfile.basename?this.save(this.currfile):r();case this.name+"-Saveas":return this.currfile.cache=this.editor.getValue(),r();case this.name+"-New":return this.open("Untitled".asFileHandler());case this.name+"-Run":return this.currfile.dirty?this.notify(__("Please save the file before running it")):(this.dialog&&this.dialog.quit(),this.openDialog(new i,null,null,this.currfile))}},e.prototype.cleanup=function(t){var e,i,r;if(0!==(e=function(){var t,e,i,n;for(n=[],t=0,e=(i=this.tabarea.get("items")).length;t<e;t++)(r=i[t]).dirty&&n.push(r);return n}.call(this)).length)return i=this,t.preventDefault(),this.openDialog("YesNoDialog",function(t){var n,o;if(t){for(n=0,o=e.length;n<o;n++)(r=e[n]).dirty=!1;return i.quit()}},"__(Quit)",{text:__("Ignore all {0} unsaved files ?",e.length)})},e}(this.OS.GUI.BaseApplication)).singleton=!1,e.dependencies=["ace/ace","ace/ext-language_tools","ace/ext-modelist","ace/ext-themelist"],e.extensions={},this.OS.register("NotePad",e)}).call(this);