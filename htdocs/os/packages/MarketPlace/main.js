(function(){var t,s,i=function(t,e){for(var i in e)n.call(e,i)&&(t[i]=e[i]);function s(){this.constructor=t}return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},n={}.hasOwnProperty;(s=function(t){function e(){e.__super__.constructor.call(this,"RepositoryDialog")}return i(e,t),e.prototype.init=function(){return this._gui.htmlToScheme(e.scheme,this,this.host)},e.prototype.main=function(){var s;return(s=this).list=this.find("repo-list"),this.list.set("onlistdbclick",function(t){var i,e;if(0<=(e=s.list.get("selidx")))return i=s.systemsetting.system.repositories[e],s.openDialog("PromptDialog",function(t){var e;return(e=t.match(/\[([^\]]*)\]\s*(.*)/))&&3===e.length?(i.name=e[1],i.text=i.name,i.url=e[2],s.refreshList()):s.error("Wrong format: it should be [name] url")},__("Edit repository"),{label:__("Format : [name] url"),value:"["+t.data.text+"] "+t.data.url})}),this.list.set("buttons",[{text:"+",onbtclick:function(){return s.openDialog("PromptDialog",function(t){var e;return(e=t.match(/\[([^\]]*)\]\s*(.*)/))&&3===e.length?(s.systemsetting.system.repositories.push({name:e[1],url:e[2],text:e[1],i:s.systemsetting.system.repositories.length}),s.refreshList()):s.error(__("Wrong format: it should be [name] url"))},__("Add repository"),{label:__("Format : [name] url")})}},{text:"-",onbtclick:function(){var t;if(0<=(t=s.list.get("selidx")))return s.systemsetting.system.repositories.splice(t,t),s.refreshList()}}]),this.find("btquit").set("onbtclick",function(t){return s.quit()}),this.refreshList()},e.prototype.refreshList=function(){var t,n;return t=function(){var t,e,i,s;for(s=[],t=0,e=(i=this.systemsetting.system.repositories).length;t<e;t++)n=i[t],s.push({text:n.name,iconclass:"fa fa-link",url:n.url,complex:!0,detail:[{text:n.url}]});return s}.call(this),this.list.set("items",t)},e.prototype.onexit=function(t){if(this.parent.repo.set("items",this.systemsetting.system.repositories),this.parent)return this.parent.dialog=void 0},e}(this.OS.GUI.BaseDialog)).scheme='<afx-app-window data-id = "repository-dialog-win" apptitle="__(Repositories)" width="250" height="250">\n        <afx-vbox >\n            <afx-list-view data-id="repo-list"></afx-list-view>\n            <div style = "text-align:right; padding:5px" data-height="30" >\n                <afx-button data-id = "btquit" text = "__(Cancel)"></afx-button>\n            </div>\n        </afx-vbox>\n    </afx-app-window>',(t=function(t){function e(t){e.__super__.constructor.call(this,"MarketPlace",t)}return i(e,t),e.prototype.main=function(){var i;return(i=this).installdir=this.systemsetting.system.pkgpaths.user,this.repo=this.find("repo"),this.repo.set("onlistselect",function(t){if(t.data)return i.fetchApps(t.data.url)}),this.repo.set("items",this.systemsetting.system.repositories),this.applist=this.find("applist"),this.applist.set("onlistselect",function(t){if(t.data)return i.appDetail(t.data)}),this.container=this.find("container"),this.appname=this.find("appname"),this.appdesc=this.find("app-desc"),this.appdetail=this.find("app-detail"),this.btinstall=this.find("bt-install"),this.btremove=this.find("bt-remove"),this.btexec=this.find("bt-exec"),$(this.container).css("visibility","hidden"),this.btexec.set("onbtclick",function(t){var e;if(e=i.applist.get("selected"))return e.className?i._gui.launch(e.className):void 0}),this.btinstall.set("onbtclick",function(t){return i.btinstall.get("dirty")?i.update():i.install()}),this.btremove.set("onbtclick",function(t){return i.uninstall()}),this.bindKey("CTRL-R",function(){return i.openDialog(new s)})},e.prototype.fetchApps=function(i){var n;return(n=this)._api.get(i,function(t){var e,i,s;for(e=0,i=t.length;e<i;e++)(s=t[e]).text=s.name,s.iconclass="fa fa-adn";return n.applist.set("items",t)},function(t,e){return n.error(__("Fail to fetch packages list from: {0}",i))})},e.prototype.appDetail=function(t){var e,i,s,n,r,a,o;for(e in i=this,$(this.container).css("visibility","visible"),$(this.appname).html(t.name),this.find("vstat").set("text",""),t.description?t.description.asFileHandler().read(function(t){var e;return e=new showdown.Converter,$(i.appdesc).html(e.makeHtml(t))}):$(i.appdesc).empty(),n=this.systemsetting.system.packages,this.btinstall.set("text","__(Install)"),this.btinstall.set("dirty",!1),n[t.className]?(o=n[t.className].version,s=t.version,$(this.btinstall).hide(),o&&s&&(o=o.__v(),(s=s.__v()).nt(o)&&(this.btinstall.set("dirty",!0),this.btinstall.set("text","__(Update)"),$(this.btinstall).show(),this.find("vstat").set("text",__("Your application version is older ({0} < {1})",o,s)))),$(this.btremove).show(),$(this.btexec).show()):($(this.btinstall).show(),$(this.btremove).hide(),$(this.btexec).hide()),$(this.appdetail).empty(),r=[],t)a=t[e],"name"!==e&&"description"!==e&&r.push($(this.appdetail).append($("<li>").append($("<span class= 'info-header'>").html(e)).append($("<span>").html(a))));return r},e.prototype.menu=function(){var e;return e=this,[{text:"__(Options)",child:[{text:"__(Repositories)",shortcut:"C-R"}],onmenuselect:function(t){return e.openDialog(new s)}}]},e.prototype.install=function(t){var a,o;if(a=(o=this).applist.get("selected"))return this._api.blob(a.download,function(t){return JSZip.loadAsync(t).then(function(t){var e,i,s,n,r;for(s in e=[n=o.installdir+"/"+a.className],i=[],r=t.files)r[s].dir?e.push(n+"/"+s):i.push(s);return i.indexOf("package.json")<0?o.error(__("Invalid package: Meta data file not found")):o.mkdirs(a.className,e,function(){return o.installFile(a.className,t,i,function(){return t.file("package.json").async("string").then(function(t){var e;return(e=JSON.parse(t)).text=e.name,e.filename=a.className,e.type="app",e.mime="antos/app",e.iconclass||e.icon||(e.iconclass="fa fa-adn"),e.path=n,o.systemsetting.system.packages[a.className]=e,o.notify(__("Application installed")),o._gui.refreshSystemMenu(),o.appDetail(a)}).catch(function(t){return o.error(__("Error reading package meta data: {0}",t))})})})})},function(t,e){if(t)return o.error(__("Cannot down load the app {0}",t))})},e.prototype.uninstall=function(e){var i,s,n,r;if(r=(s=this).applist.get("selected"),n=r.className,r&&(i=this.systemsetting.system.packages[r.className]))return this.openDialog("YesNoDialog",function(t){if(t)return i.path.asFileHandler().remove(function(t){return t.error?s.error(__("Cannot uninstall package: {0}",t.error)):(s.notify(__("Package uninstalled")),delete s.systemsetting.system.packages[n],s._gui.unloadApp(n),s._gui.refreshSystemMenu(),s.appDetail(r),e?e():void 0)})},__("Uninstall"),{text:__("Uninstall: {0}?",i.name)})},e.prototype.update=function(){var i;return i=this,new Promise(function(t,e){return i.uninstall(function(){return t()})}).then(function(){return i.install()})},e.prototype.mkdirs=function(e,i,s){var n,t,r,a;if(r=this,0!==i.length)return n=i.splice(0,1)[0].asFileHandler(),a=n.parent(),t=n.basename,a.asFileHandler().mk(t,function(t){return t.result?r.mkdirs(e,i,s):r.error(__("Cannot create {0}",a+"/"+n))});s&&s()},e.prototype.installFile=function(i,s,n,r){var t,a,o;if(a=this,0!==n.length)return t=n.splice(0,1)[0],o=a.installdir+"/"+i+"/"+t,s.file(t).async("uint8array").then(function(t){var e;return(e=o.asFileHandler()).cache=new Blob([t],{type:"octet/stream"}),e.write("text/plain",function(t){return t.result?a.installFile(i,s,n,r):a.error(__("Cannot install {0}",o))})});r&&r()},e}(this.OS.GUI.BaseApplication)).dependencies=["jszip.min","showdown.min"],t.singleton=!0,this.OS.register("MarketPlace",t)}).call(this);