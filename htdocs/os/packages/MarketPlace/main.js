(function(){var t,e={}.hasOwnProperty;(t=function(t){function i(){i.__super__.constructor.call(this,"RepositoryDialog")}return function(t,i){for(var s in i)e.call(i,s)&&(t[s]=i[s]);function n(){this.constructor=t}n.prototype=i.prototype,t.prototype=new n,t.__super__=i.prototype}(i,t),i.prototype.init=function(){return this._gui.htmlToScheme(i.scheme,this,this.host)},i.prototype.main=function(){var t;return t=this,this.list=this.find("repo-list"),this.list.set("onlistdbclick",function(e){var i,s;if((s=t.list.get("selidx"))>=0)return i=t.systemsetting.system.repositories[s],t.openDialog("PromptDialog",function(e){var s;return(s=e.match(/\[([^\]]*)\]\s*(.*)/))&&3===s.length?(i.name=s[1],i.text=i.name,i.url=s[2],t.refreshList()):t.error("Wrong format: it should be [name] url")},"Edit repository",{label:"Format : [name]url",value:"["+e.data.text+"] "+e.data.url})}),this.find("btadd").set("onbtclick",function(e){return t.openDialog("PromptDialog",function(e){var i;return(i=e.match(/\[([^\]]*)\]\s*(.*)/))&&3===i.length?(t.systemsetting.system.repositories.push({name:i[1],url:i[2],text:i[1],i:t.systemsetting.system.repositories.length}),t.refreshList()):t.error("Wrong format: it should be [name] url")},"Add repository",{label:"Format : [name]url"})}),this.find("btdel").set("onbtclick",function(e){var i;if((i=t.list.get("selidx"))>=0)return t.systemsetting.system.repositories.splice(i,i),t.refreshList()}),this.find("btquit").set("onbtclick",function(e){return t.quit()}),this.refreshList()},i.prototype.refreshList=function(){var t,e;return t=function(){var t,i,s,n;for(n=[],t=0,i=(s=this.systemsetting.system.repositories).length;t<i;t++)e=s[t],n.push({text:e.name,iconclass:"fa fa-link",url:e.url,complex:!0,detail:[{text:e.url}]});return n}.call(this),this.list.set("items",t)},i.prototype.onexit=function(t){if(this.parent.repo.set("items",this.systemsetting.system.repositories),this.parent)return this.parent.dialog=void 0},i}(this.OS.GUI.BaseDialog)).scheme='<afx-app-window data-id = "repository-dialog-win" apptitle="Repositories" width="250" height="250">\n        <afx-vbox >\n            <afx-list-view data-id="repo-list"></afx-list-view>\n            <afx-hbox data-height = "30">\n                <afx-button data-id = "btadd" text = "[+]" data-width="30"></afx-button>\n                <afx-button data-id = "btdel" text = "[-]" data-width="30"></afx-button>\n                <div></div>\n                <afx-button data-id = "btquit" text = "Cancel" data-width="50"></afx-button>\n            </afx-hbox>\n        </afx-vbox>\n    </afx-app-window>',this.OS.register("RepositoryDialog",t)}).call(this),function(){var t,e={}.hasOwnProperty;(t=function(t){function i(t){i.__super__.constructor.call(this,"MarketPlace",t)}return function(t,i){for(var s in i)e.call(i,s)&&(t[s]=i[s]);function n(){this.constructor=t}n.prototype=i.prototype,t.prototype=new n,t.__super__=i.prototype}(i,t),i.prototype.main=function(){var t;return t=this,this.installdir=this.systemsetting.system.pkgpaths.user,this.repo=this.find("repo"),this.repo.set("onlistselect",function(e){if(e.data)return t.fetchApps(e.data.url)}),this.repo.set("items",this.systemsetting.system.repositories),this.applist=this.find("applist"),this.applist.set("onlistselect",function(e){if(e.data)return t.appDetail(e.data)}),this.container=this.find("container"),this.appname=this.find("appname"),this.appdesc=this.find("app-desc"),this.appdetail=this.find("app-detail"),this.btinstall=this.find("bt-install"),this.btremove=this.find("bt-remove"),this.btexec=this.find("bt-exec"),$(this.container).css("visibility","hidden"),this.btexec.set("onbtclick",function(e){var i;if(i=t.applist.get("selected"))return i.className?t._gui.launch(i.className):void 0}),this.btinstall.set("onbtclick",function(e){return t.install(e)}),this.btremove.set("onbtclick",function(e){return t.uninstall(e)}),this.bindKey("CTRL-R",function(){return t.openDialog("RepositoryDialog")})},i.prototype.fetchApps=function(t){var e;return e=this,this._api.get(t,function(t){var i,s,n;for(i=0,s=t.length;i<s;i++)(n=t[i]).text=n.name,n.iconclass="fa fa-adn";return e.applist.set("items",t)},function(i,s){return e.error("Fail to fetch packages list from: "+t)})},i.prototype.appDetail=function(t){var e,i,s;for(e in $(this.container).css("visibility","visible"),$(this.appname).html(t.name),t.description&&$(this.appdesc).html(t.description),this.systemsetting.system.packages[t.className]?($(this.btinstall).hide(),$(this.btremove).show(),$(this.btexec).show()):($(this.btinstall).show(),$(this.btremove).hide(),$(this.btexec).hide()),$(this.appdetail).empty(),i=[],t)s=t[e],"name"!==e&&"description"!==e&&i.push($(this.appdetail).append($("<li>").append($("<span class= 'info-header'>").html(e)).append($("<span>").html(s))));return i},i.prototype.menu=function(){var t;return t=this,[{text:"Options",child:[{text:"Repositories",shortcut:"C-R"}],onmenuselect:function(e){return t.openDialog("RepositoryDialog")}}]},i.prototype.install=function(t){var e,i;if(i=this,e=this.applist.get("selected"))return this._api.blob(e.download,function(t){return JSZip.loadAsync(t).then(function(t){var s,n,a,r,o;for(a in s=[r=i.installdir+"/"+e.className],n=[],o=t.files)o[a].dir?s.push(r+"/"+a):n.push(a);return n.indexOf("package.json")<0?i.error("Invalid package: Meta data file not found"):i.mkdirs(e.className,s,function(){return i.installFile(e.className,t,n,function(){return t.file("package.json").async("string").then(function(t){var s;return s=JSON.parse(t),console.log(s),s.text=s.name,s.filename=e.className,s.type="app",s.mime="antos/app",s.iconclass||s.icon||(s.iconclass="fa fa-adn"),s.path=r,i.systemsetting.system.packages[e.className]=s,i.notify("Application installed"),i._gui.refreshSystemMenu(),i.appDetail(e)}).catch(function(t){return i.error("Error reading package meta data: "+t)})})})})},function(t,e){if(t)return i.error("Cannot down load the app "+t)})},i.prototype.uninstall=function(t){var e,i,s;if(i=this,e=this.applist.get("selected"),s=e.className,e&&(e=this.systemsetting.system.packages[e.className]))return this.openDialog("YesNoDialog",function(t){if(t)return e.path.asFileHandler().remove(function(t){return t.error&&i.error("Cannot uninstall package: "+t.error),i.notify("Package uninstalled"),i.systemsetting.system.packages[s]=void 0,i._gui.refreshSystemMenu(),i.appDetail(e)})},"Uninstall",{text:"Uninstall : "+e.name+" ?"})},i.prototype.mkdirs=function(t,e,i){var s,n,a,r;if(a=this,0!==e.length)return s=e.splice(0,1)[0].asFileHandler(),r=s.parent(),n=s.basename,r.asFileHandler().mk(n,function(n){return n.result?a.mkdirs(t,e,i):a.error("Cannot create "+r+"/"+s)});i&&i()},i.prototype.installFile=function(t,e,i,s){var n,a,r;if(a=this,0!==i.length)return n=i.splice(0,1)[0],r=a.installdir+"/"+t+"/"+n,e.file(n).async("uint8array").then(function(n){var o;return(o=r.asFileHandler()).cache=new Blob([n],{type:"octet/stream"}),o.write("text/plain",function(n){return n.result?a.installFile(t,e,i,s):a.error("Cannot install "+r)})});s&&s()},i}(this.OS.GUI.BaseApplication)).dependencies=["jszip.min"],this.OS.register("MarketPlace",t)}.call(this);