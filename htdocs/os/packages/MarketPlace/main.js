(function(){var t,e,i=function(t,e){for(var i in e)s.call(e,i)&&(t[i]=e[i]);function n(){this.constructor=t}return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;(e=function(t){function e(){e.__super__.constructor.call(this,"RepositoryDialog")}return i(e,t),e.prototype.init=function(){return this._gui.htmlToScheme(e.scheme,this,this.host)},e.prototype.main=function(){var t;return t=this,this.list=this.find("repo-list"),this.list.set("onlistdbclick",function(e){var i,s;if((s=t.list.get("selidx"))>=0)return i=t.systemsetting.system.repositories[s],t.openDialog("PromptDialog",function(e){var s;return(s=e.match(/\[([^\]]*)\]\s*(.*)/))&&3===s.length?(i.name=s[1],i.text=i.name,i.url=s[2],t.refreshList()):t.error("Wrong format: it should be [name] url")},__("Edit repository"),{label:__("Format : [name] url"),value:"["+e.data.text+"] "+e.data.url})}),this.list.set("buttons",[{text:"+",onbtclick:function(){return t.openDialog("PromptDialog",function(e){var i;return(i=e.match(/\[([^\]]*)\]\s*(.*)/))&&3===i.length?(t.systemsetting.system.repositories.push({name:i[1],url:i[2],text:i[1],i:t.systemsetting.system.repositories.length}),t.refreshList()):t.error(__("Wrong format: it should be [name] url"))},__("Add repository"),{label:__("Format : [name] url")})}},{text:"-",onbtclick:function(){var e;if((e=t.list.get("selidx"))>=0)return t.systemsetting.system.repositories.splice(e,e),t.refreshList()}}]),this.find("btquit").set("onbtclick",function(e){return t.quit()}),this.refreshList()},e.prototype.refreshList=function(){var t,e;return t=function(){var t,i,s,n;for(n=[],t=0,i=(s=this.systemsetting.system.repositories).length;t<i;t++)e=s[t],n.push({text:e.name,iconclass:"fa fa-link",url:e.url,complex:!0,detail:[{text:e.url}]});return n}.call(this),this.list.set("items",t)},e.prototype.onexit=function(t){if(this.parent.repo.set("items",this.systemsetting.system.repositories),this.parent)return this.parent.dialog=void 0},e}(this.OS.GUI.BaseDialog)).scheme='<afx-app-window data-id = "repository-dialog-win" apptitle="__(Repositories)" width="250" height="250">\n        <afx-vbox >\n            <afx-list-view data-id="repo-list"></afx-list-view>\n            <div style = "text-align:right; padding:5px" data-height="30" >\n                <afx-button data-id = "btquit" text = "__(Cancel)"></afx-button>\n            </div>\n        </afx-vbox>\n    </afx-app-window>',(t=function(t){function s(t){s.__super__.constructor.call(this,"MarketPlace",t)}return i(s,t),s.prototype.main=function(){var t;return t=this,this.installdir=this.systemsetting.system.pkgpaths.user,this.repo=this.find("repo"),this.repo.set("onlistselect",function(e){if(e.data)return t.fetchApps(e.data.url)}),this.repo.set("items",this.systemsetting.system.repositories),this.applist=this.find("applist"),this.applist.set("onlistselect",function(e){if(e.data)return t.appDetail(e.data)}),this.container=this.find("container"),this.appname=this.find("appname"),this.appdesc=this.find("app-desc"),this.appdetail=this.find("app-detail"),this.btinstall=this.find("bt-install"),this.btremove=this.find("bt-remove"),this.btexec=this.find("bt-exec"),$(this.container).css("visibility","hidden"),this.btexec.set("onbtclick",function(e){var i;if(i=t.applist.get("selected"))return i.className?t._gui.launch(i.className):void 0}),this.btinstall.set("onbtclick",function(e){return t.btinstall.get("dirty")?t.update():t.install()}),this.btremove.set("onbtclick",function(e){return t.uninstall()}),this.bindKey("CTRL-R",function(){return t.openDialog(new e)})},s.prototype.fetchApps=function(t){var e;return e=this,this._api.get(t,function(t){var i,s,n;for(i=0,s=t.length;i<s;i++)(n=t[i]).text=n.name,n.iconclass="fa fa-adn";return e.applist.set("items",t)},function(i,s){return e.error(__("Fail to fetch packages list from: {0}",t))})},s.prototype.appDetail=function(t){var e,i,s,n,r,a,o;for(e in i=this,$(this.container).css("visibility","visible"),$(this.appname).html(t.name),this.find("vstat").set("text",""),t.description?t.description.asFileHandler().read(function(t){var e;return e=new showdown.Converter,$(i.appdesc).html(e.makeHtml(t))}):$(i.appdesc).empty(),n=this.systemsetting.system.packages,this.btinstall.set("text","__(Install)"),this.btinstall.set("dirty",!1),n[t.className]?(o=n[t.className].version,s=t.version,$(this.btinstall).hide(),o&&s&&(o=o.__v(),(s=s.__v()).nt(o)&&(this.btinstall.set("dirty",!0),this.btinstall.set("text","__(Update)"),$(this.btinstall).show(),this.find("vstat").set("text",__("Your application version is older ({0} < {1})",o,s)))),$(this.btremove).show(),$(this.btexec).show()):($(this.btinstall).show(),$(this.btremove).hide(),$(this.btexec).hide()),$(this.appdetail).empty(),r=[],t)a=t[e],"name"!==e&&"description"!==e&&r.push($(this.appdetail).append($("<li>").append($("<span class= 'info-header'>").html(e)).append($("<span>").html(a))));return r},s.prototype.menu=function(){var t;return t=this,[{text:"__(Options)",child:[{text:"__(Repositories)",shortcut:"C-R"}],onmenuselect:function(i){return t.openDialog(new e)}}]},s.prototype.install=function(t){var e,i;if(i=this,e=this.applist.get("selected"))return this._api.blob(e.download,function(t){return JSZip.loadAsync(t).then(function(t){var s,n,r,a,o;for(r in s=[a=i.installdir+"/"+e.className],n=[],o=t.files)o[r].dir?s.push(a+"/"+r):n.push(r);return n.indexOf("package.json")<0?i.error(__("Invalid package: Meta data file not found")):i.mkdirs(e.className,s,function(){return i.installFile(e.className,t,n,function(){return t.file("package.json").async("string").then(function(t){var s;return(s=JSON.parse(t)).text=s.name,s.filename=e.className,s.type="app",s.mime="antos/app",s.iconclass||s.icon||(s.iconclass="fa fa-adn"),s.path=a,i.systemsetting.system.packages[e.className]=s,i.notify(__("Application installed")),i._gui.refreshSystemMenu(),i.appDetail(e)}).catch(function(t){return i.error(__("Error reading package meta data: {0}",t))})})})})},function(t,e){if(t)return i.error(__("Cannot down load the app {0}",t))})},s.prototype.uninstall=function(t){var e,i,s,n;if(i=this,n=this.applist.get("selected"),s=n.className,n&&(e=this.systemsetting.system.packages[n.className]))return this.openDialog("YesNoDialog",function(r){if(r)return e.path.asFileHandler().remove(function(e){return e.error?i.error(__("Cannot uninstall package: {0}",e.error)):(i.notify(__("Package uninstalled")),delete i.systemsetting.system.packages[s],i._gui.unloadApp(s),i._gui.refreshSystemMenu(),i.appDetail(n),t?t():void 0)})},__("Uninstall"),{text:__("Uninstall: {0}?",e.name)})},s.prototype.update=function(){var t;return t=this,new Promise(function(e,i){return t.uninstall(function(){return e()})}).then(function(){return t.install()})},s.prototype.mkdirs=function(t,e,i){var s,n,r,a;if(r=this,0!==e.length)return s=e.splice(0,1)[0].asFileHandler(),a=s.parent(),n=s.basename,a.asFileHandler().mk(n,function(n){return n.result?r.mkdirs(t,e,i):r.error(__("Cannot create {0}",a+"/"+s))});i&&i()},s.prototype.installFile=function(t,e,i,s){var n,r,a;if(r=this,0!==i.length)return n=i.splice(0,1)[0],a=r.installdir+"/"+t+"/"+n,e.file(n).async("uint8array").then(function(n){var o;return(o=a.asFileHandler()).cache=new Blob([n],{type:"octet/stream"}),o.write("text/plain",function(n){return n.result?r.installFile(t,e,i,s):r.error(__("Cannot install {0}",a))})});s&&s()},s}(this.OS.GUI.BaseApplication)).dependencies=["jszip.min","showdown.min"],t.singleton=!0,this.OS.register("MarketPlace",t)}).call(this);