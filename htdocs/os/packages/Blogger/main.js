(function(){var t,e,n,r=function(t,e){for(var n in e)i.call(e,n)&&(t[n]=e[n]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},i={}.hasOwnProperty;n=function(t){function e(){e.__super__.constructor.call(this,"BloggerCategoryDialog",{tags:[{tag:"afx-label",att:"data-height = '20', text = 'Pick a parent'"},{tag:"afx-tree-view"},{tag:"afx-label",att:"data-height = '20', text = 'Category name'"},{tag:"input",att:"type = 'text' data-height = '20'"}],width:200,height:300,resizable:!0,buttons:[{label:"0k",onclick:function(t){var e,n;return(e=t.find("content1").get("selectedItem"))?""!==(n=t.find("content3").value)||t.data.selonly?t.data.cat&&t.data.cat.id===e.id?t.notify(__("Parent can not be the category itself")):(t.handler&&t.handler({p:e,value:n}),t.quit()):t.notify(__("Please enter category name")):t.notify(__("Please select a parent category"))}},{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){var e,n;if(t.data)return n=t.find("content1"),t.data.tree&&n.set("data",t.data.tree),t.data.cat?(e=n.find("id",t.data.cat.pid)[0],n.set("selectedItem",e),t.find("content3").value=t.data.cat.name):void 0},xtra:function(e){return $(e.find("content3")).keyup(function(t){if(13===t.which)return e.find("bt0").trigger()})}})}return r(e,t),e}(this.OS.GUI.BasicDialog),this.OS.register("BloggerCategoryDialog",n),e=function(t){function e(){e.__super__.constructor.call(this,"BloggerCVSectionDiaglog")}return r(e,t),e.prototype.init=function(){return this.render(this.path()+"/cvsection.html")},e.prototype.main=function(){var t,i,e,o,s;if((o=this).scheme.set("apptitle",this.title),this.editor=new SimpleMDE({element:this.find("contentarea"),status:!1,toolbar:!1}),$(this.select('[class = "CodeMirror-scroll"]')[0]).css("min-height","50px"),$(this.select('[class="CodeMirror cm-s-paper CodeMirror-wrap"]')[0]).css("min-height","50px"),this.on("vboxchange",function(){return o.resizeContent()}),i=o.select("[input-class='user-input']"),o.data)for(t=0,e=i.length;t<e;t++)s=i[t],$(s).val(o.data[s.name]);return o.data&&o.data.content&&this.editor.value(o.data.content),this.find("bt-cv-sec-save").set("onbtclick",function(t){var e,n,r;for(e={},console.log(i),n=0,r=i.length;n<r;n++)e[(s=i[n]).name]=$(s).val();return e.content=o.editor.value(),""===e.title&&""===e.content?o.notify(__("Title or content must not be blank")):(o.data&&o.data.id&&(e.id=o.data.id),o.handler&&o.handler(e),o.quit())}),o.resizeContent()},e.prototype.resizeContent=function(){var t,e,n;return n=this.find("editor-container"),e=$(n).children(),t=$(n).height()-30,$(e[1]).css("height",t+"px")},e}(this.OS.GUI.BaseDialog),this.OS.register("BloggerCVSectionDiaglog",e),(t=function(t){function e(t){e.__super__.constructor.call(this,"Blogger",t)}return r(e,t),e.prototype.main=function(){var o;return(o=this).tabbar=this.find("tabbar"),this.containers=[this.find("user-container"),this.find("cv-container"),this.find("blog-container")],this.user={},this.cvlist=this.find("cv-list"),this.cvlist.set("ontreeselect",function(t){return o.CVSectionByCID(Number(t.id))}),this.inputtags=this.find("input-tags"),this.bloglist=this.find("blog-list"),this.userdb=new this._api.DB("user"),this.cvcatdb=new this._api.DB("cv_cat"),this.cvsecdb=new this._api.DB("cv_sections"),this.blogdb=new this._api.DB("blogs"),this.tabbar.set("onlistselect",function(t){var e,n,r,i;for(n=0,r=(i=o.containers).length;n<r;n++)e=i[n],$(e).hide();return o.fetchData(t.idx),$(o.containers[t.idx]).show(),o.trigger("calibrate")}),this.tabbar.set("items",[{iconclass:"fa fa-user-circle",selected:!0},{iconclass:"fa fa-info-circle"},{iconclass:"fa fa-book"}]),this.find("bt-user-save").set("onbtclick",function(t){return o.saveUser()}),this.find("cv-cat-add").set("onbtclick",function(t){return o.openDialog("BloggerCategoryDialog",function(t){var e;return e={name:t.value,pid:t.p.id,publish:1},o.cvcatdb.save(e,function(t){return t.error&&o.error(__("Cannot add new category")),o.refreshCVCat()})},__("Add category"),{tree:o.cvlist.get("data")})}),this.find("cv-cat-edit").set("onbtclick",function(t){var n;if(n=o.cvlist.get("selectedItem"))return o.openDialog("BloggerCategoryDialog",function(t){var e;return e={id:n.id,publish:n.publish,pid:t.p.id,name:t.value},o.cvcatdb.save(e,function(t){return t.error?o.error(__("Cannot Edit category")):o.refreshCVCat()})},__("Edit category"),{tree:o.cvlist.get("data"),cat:n})}),this.find("cv-cat-del").set("onbtclick",function(t){var e;if(e=o.cvlist.get("selectedItem"))return o.openDialog("YesNoDialog",function(t){if(t)return o.deleteCVCat(e)},__("Delete category"),{iconclass:"fa fa-question-circle",text:__("Do you really want to delete: {0}?",e.name)})}),this.find("cv-sec-add").set("onbtclick",function(t){var e;return(e=o.cvlist.get("selectedItem"))&&0!==e.id?o.openDialog("BloggerCVSectionDiaglog",function(t){return t.cid=Number(e.id),t.start=Number(t.start),t.end=Number(t.end),t.publish=1,o.cvsecdb.save(t,function(t){return t.error?o.error(__("Cannot save section: {0}",t.error)):o.CVSectionByCID(Number(e.id))})},__("New section entry for {0}",e.name),null):o.notify(__("Please select a category"))}),this.find("cv-sec-move").set("onbtclick",function(t){var n;return(n=o.find("cv-sec-list").get("selected"))?o.openDialog("BloggerCategoryDialog",function(t){var e;return e={id:n.id,cid:t.p.id},o.cvsecdb.save(e,function(t){return t.error?o.error(__("Cannot move section")):(o.CVSectionByCID(n.cid),o.find("cv-sec-list").set("selected",-1))})},__("Move to"),{tree:o.cvlist.get("data"),selonly:!0}):o.notify(__("Please select a section to move"))}),this.find("cv-sec-edit").set("onbtclick",function(t){var e;return(e=o.find("cv-sec-list").get("selected"))?o.openDialog("BloggerCVSectionDiaglog",function(t){return t.cid=Number(e.cid),t.start=Number(t.start),t.end=Number(t.end),t.publish=Number(e.publish),o.cvsecdb.save(t,function(t){return t.error?o.error(__("Cannot save section: {0}",t.error)):o.CVSectionByCID(Number(e.cid))})},__("Modify section entry"),e):o.notify(__("Please select a section to edit"))}),this.editor=new SimpleMDE({element:o.find("markarea"),autofocus:!0,tabSize:4,indentWithTabs:!0,toolbar:[{name:__("New"),className:"fa fa-file",action:function(t){return o.bloglist.set("selected",-1),o.clearEditor()}},{name:__("Save"),className:"fa fa-save",action:function(t){return o.saveBlog()}},"|","bold","italic","heading","|","quote","code","unordered-list","ordered-list","|","link","image","table","horizontal-rule",{name:"image",className:"fa fa-file-image-o",action:function(t){return o.openDialog("FileDiaLog",function(t,e,n){return n.asFileHandler().publish(function(t){return t.error?o.error(__("Cannot export file for embedding to text")):o.editor.codemirror.getDoc().replaceSelection("![]("+o._api.handler.shared+"/"+t.result+")")})},__("Select image file"),{mimes:["image/.*"]})}},{name:"Youtube",className:"fa fa-youtube",action:function(t){return o.editor.codemirror.getDoc().replaceSelection("[[youtube:]]")}},"|",{name:__("Preview"),className:"fa fa-eye no-disable",action:function(t){return o.previewOn=!o.previewOn,SimpleMDE.togglePreview(t)}}]}),this.bloglist.set("onlistselect",function(t){var e;if(e=o.bloglist.get("selected"))return o.blogdb.get(Number(e.id),function(t){return t.error&&o.error(__("Cannot fetch the entry content")),o.editor.value(atob(t.result.content)),o.inputtags.value=t.result.tags,o.find("blog-publish").set("swon",!!Number(t.result.publish))})}),this.bloglist.set("onitemclose",function(e){return o.openDialog("YesNoDialog",function(t){if(t)return o.blogdb.delete(e.item.item.id,function(t){return t.error?o.error(__("Cannot delete: {0}",t.error)):(o.bloglist.remove(e.item.item,!0),o.bloglist.set("selected",-1),o.clearEditor())})},__("Delete a post"),{iconclass:"fa fa-question-circle",text:__("Do you really want to delete this post ?")}),!1}),this.bindKey("CTRL-S",function(){if(2===o.tabbar.get("selidx"))return o.saveBlog()}),this.on("vboxchange",function(){return o.resizeContent()})},e.prototype.fetchData=function(t){var s;switch(s=this,t){case 0:return this.userdb.get(null,function(t){var e,n,r,i,o;if(t.error)return s.error(__("Cannot fetch user data"));for(s.user=t.result[0],i=[],e=0,r=(n=s.select("[input-class='user-input']")).length;e<r;e++)o=n[e],i.push($(o).val(s.user[o.name]));return i});case 1:return this.refreshCVCat();default:return this.loadBlogs()}},e.prototype.saveUser=function(){var t,e,n,r,i;for(t=0,n=(e=(r=this).select("[input-class='user-input']")).length;t<n;t++)i=e[t],this.user[i.name]=$(i).val();return this.user.fullname&&""!==this.user.fullname?this.userdb.save(this.user,function(t){return t.error?r.error(__("Cannot save user data")):r.notify(__("User data updated"))}):this.notify(__("Full name must be entered"))},e.prototype.refreshCVCat=function(){var t,e,n;return e={name:"Porfolio",id:0,nodes:[]},t={order:{name:"ASC"}},(n=this).cvcatdb.find(t,function(t){return t.error?(n.cvlist.set("data",e),n.notify(__("Cannot fetch CV categories"))):(n.fetchCVCat(t.result,e,"0"),n.cvlist.set("data",e))})},e.prototype.fetchCVCat=function(r,t,i){var e,n,o,s,a;if(0===(o=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)(a=r[t]).pid===i&&n.push(a);return n}()).length)return t.nodes=null;for(s=[],e=0,n=o.length;e<n;e++)(a=o[e]).nodes=[],this.fetchCVCat(r,a,a.id),s.push(t.nodes.push(a));return s},e.prototype.deleteCVCat=function(e){var n,s,a,r,i;return r=this,a=[],(s=function(t){var e,n,r,i,o;if(a.push(t.id),t.nodes){for(i=[],e=0,n=(r=t.nodes).length;e<n;e++)o=r[e],i.push(s(o));return i}})(e),n=function(){var t,e,n;for(n=[],t=0,e=a.length;t<e;t++)i=a[t],n.push({"=":{cid:i}});return n}(),this.cvsecdb.delete({or:n},function(t){return t.error?r.error(__("Cannot delete all content of: {0} [{1}]",e.name,t.error)):(n=function(){var t,e,n;for(n=[],t=0,e=a.length;t<e;t++)i=a[t],n.push({"=":{id:i}});return n}(),r.cvcatdb.delete({or:n},function(t){return t.error?r.error(__("Cannot delete the category: {0} [{1}]",e.name,t.error)):r.refreshCVCat()}))})},e.prototype.CVSectionByCID=function(t){var e,u;return e={exp:{"=":{cid:t}},order:{start:"DESC"}},(u=this).cvsecdb.find(e,function(t){var n,e,r,i,o,s,a,c,l;if(t.error)return u.notify(__("Section list is empty, please add one"));for(e=0,o=(a=t.result).length;e<o;e++)(l=a[e]).text=l.title;for(r=[],$(u.find("cv-sec-status")).html(__("Found {0} sections",t.result.length)),i=0,s=(c=t.result).length;i<s;i++)(l=c[i]).text=l.title,l.complex=!0,l.start=Number(l.start),l.end=Number(l.end),l.detail=[],""!==l.subtitle&&l.detail.push({text:l.subtitle,class:"cv-subtitle"}),0!==l.start&&0!==l.end?l.detail.push({text:l.start+" - "+l.end,class:"cv-period"}):l.detail.push({text:"",class:"cv-period"}),""!==l.location&&l.detail.push({text:l.location,class:"cv-loc"}),l.closable=!0,l.detail.push({text:l.content,class:"cv-content"}),r.push(l);return(n=u.find("cv-sec-list")).set("onitemclose",function(e){return u.openDialog("YesNoDialog",function(t){if(t)return u.cvsecdb.delete(e.item.item.id,function(t){return t.error?u.error(__("Cannot delete the section: {0}",t.error)):n.remove(e.item.item,!0)})},__("Delete section"),{iconclass:"fa fa-question-circle",text:__("Do you really want to delete: {0}?",e.item.item.text)}),!1}),n.set("items",r)})},e.prototype.saveBlog=function(){var t,e,n,r,i,o,s;return i=(r=this).bloglist.get("selected"),o=this.inputtags.value,t=this.editor.value(),(s=new RegExp("^#+(.*)\n","g").exec(t))&&2===s.length?""===o?this.notify(__("Please enter tags")):(e=new Date,n={content:t.asBase64(),title:s[1].trim(),tags:o,ctime:i?i.ctime:e.timestamp(),ctimestr:i?i.ctimestr:e.toString(),utime:e.timestamp(),utimestr:e.toString(),rendered:r.process(r.editor.options.previewRender(t)),publish:this.find("blog-publish").get("swon")?1:0},i&&(n.id=i.id),this.blogdb.save(n,function(t){return t.error?r.error(__("Cannot save blog: {0}",t.error)):r.loadBlogs()})):this.notify(__("Please insert a title in the text: beginning with heading"))},e.prototype.process=function(t){var e,n,r,i,o,s,a,c,l;for(n=function(t){return'<iframe\n    class = "embeded-video"\n    width="560" height="315" \n    src="https://www.youtube.com/embed/'+t+'"\n    frameborder="0" allow="encrypted-media" allowfullscreen\n></iframe>'},a=/\[\[([^:]*):([^\]]*)\]\]/g,c=[];null!==(r=a.exec(t));)c.push(r);if(!(0<c.length))return t.asBase64();for(l="",i=e=0,s=c.length;i<s;i++)o=c[i],l+=t.substring(e,o.index),l+=n(o[2]),e=o.index+o[0].length;return(l+=t.substring(e,t.length)).asBase64()},e.prototype.clearEditor=function(){return this.editor.value(""),this.inputtags.value="",this.find("blog-publish").set("swon",!1)},e.prototype.loadBlogs=function(){var t,o,s;return s=(o=this).bloglist.get("selidx"),t={order:{ctime:"DESC"},fields:["id","title","ctimestr","ctime","utime","utimestr"]},this.blogdb.find(t,function(t){var e,n,r,i;if(t.error)return o.notify(__("No post found: {0}",t.error));for(e=0,n=(r=t.result).length;e<n;e++)(i=r[e]).text=i.title,i.complex=!0,i.closable=!0,i.detail=[{text:__("Created: {0}",i.ctimestr),class:"blog-dates"},{text:__("Updated: {0}",i.utimestr),class:"blog-dates"}];return o.bloglist.set("items",t.result),-1!==s?o.bloglist.set("selected",s):(o.clearEditor(),o.bloglist.set("selected",-1))})},e.prototype.resizeContent=function(){var t,e,n,r,i,o;return n=this.find("editor-container"),e=$(n).children(),i=$(this.scheme).find(".afx-window-top")[0],o=e[1],r=e[4],t=$(this.scheme).height()-$(i).height()-$(o).height()-$(r).height()-90,$(e[2]).css("height",t+"px")},e}(this.OS.GUI.BaseApplication)).singleton=!0,t.dependencies=["mde/simplemde.min"],this.OS.register("Blogger",t)}).call(this);