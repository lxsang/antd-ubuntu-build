(function(){var t,e,n=function(t,e){for(var n in e)r.call(e,n)&&(t[n]=e[n]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},r={}.hasOwnProperty;e=function(t){function e(){e.__super__.constructor.call(this,"BloggerCategoryDialog",{tags:[{tag:"afx-label",att:"data-height = '20', text = 'Pick a parent:'"},{tag:"afx-tree-view"},{tag:"afx-label",att:"data-height = '20', text = 'Category name:'"},{tag:"input",att:"type = 'text' data-height = '20'"}],width:200,height:300,resizable:!0,buttons:[{label:"0k",onclick:function(t){var e,n;return(e=t.find("content1").get("selectedItem"))?""!==(n=t.find("content3").value)||t.data.selonly?t.data.cat&&t.data.cat.id===e.id?t.notify("Parent can not be the category itself"):(t.handler&&t.handler({p:e,value:n}),t.quit()):t.notify("Please enter category name"):t.notify("Please select a parent category")}},{label:"Cancel",onclick:function(t){return t.quit()}}],filldata:function(t){var e,n;if(t.data)return n=t.find("content1"),t.data.tree&&n.set("data",t.data.tree),t.data.cat?(e=n.find("id",t.data.cat.pid)[0],n.set("selectedItem",e),t.find("content3").value=t.data.cat.name):void 0},xtra:function(t){return $(t.find("content3")).keyup(function(e){if(13===e.which)return t.find("bt0").trigger()})}})}return n(e,t),e}(this.OS.GUI.BasicDialog),this.OS.register("BloggerCategoryDialog",e),t=function(t){function e(){e.__super__.constructor.call(this,"BloggerCVSectionDiaglog")}return n(e,t),e.prototype.init=function(){return this.render(this.path()+"/cvsection.html")},e.prototype.main=function(){var t,e,n,r,i;if(r=this,this.scheme.set("apptitle",this.title),this.editor=new SimpleMDE({element:this.find("contentarea"),status:!1,toolbar:!1}),$(this.select('[class = "CodeMirror-scroll"]')[0]).css("min-height","50px"),$(this.select('[class="CodeMirror cm-s-paper CodeMirror-wrap"]')[0]).css("min-height","50px"),this.on("vboxchange",function(){return r.resizeContent(),console.log("resize content")}),e=r.select("[input-class='user-input']"),r.data)for(t=0,n=e.length;t<n;t++)i=e[t],$(i).val(r.data[i.name]);return r.data&&r.data.content&&this.editor.value(r.data.content),this.find("bt-cv-sec-save").set("onbtclick",function(t){var n,o,s;for(n={},console.log(e),o=0,s=e.length;o<s;o++)n[(i=e[o]).name]=$(i).val();return n.content=r.editor.value(),""===n.title&&""===n.content?r.notify("Title or content must not be blank"):(r.data&&r.data.id&&(n.id=r.data.id),r.handler&&r.handler(n),r.quit())}),r.resizeContent()},e.prototype.resizeContent=function(){var t,e,n;return n=this.find("editor-container"),e=$(n).children(),t=$(n).height()-30,$(e[1]).css("height",t+"px")},e}(this.OS.GUI.BaseDialog),this.OS.register("BloggerCVSectionDiaglog",t)}).call(this),function(){var t,e={}.hasOwnProperty;(t=function(t){function n(t){n.__super__.constructor.call(this,"Blogger",t)}return function(t,n){for(var r in n)e.call(n,r)&&(t[r]=n[r]);function i(){this.constructor=t}i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype}(n,t),n.prototype.main=function(){var t;return t=this,this.tabbar=this.find("tabbar"),this.containers=[this.find("user-container"),this.find("cv-container"),this.find("blog-container")],this.user={},this.cvlist=this.find("cv-list"),this.cvlist.set("ontreeselect",function(e){return t.CVSectionByCID(Number(e.id))}),this.inputtags=this.find("input-tags"),this.bloglist=this.find("blog-list"),this.userdb=new this._api.DB("user"),this.cvcatdb=new this._api.DB("cv_cat"),this.cvsecdb=new this._api.DB("cv_sections"),this.blogdb=new this._api.DB("blogs"),this.tabbar.set("onlistselect",function(e){var n,r,i,o;for(r=0,i=(o=t.containers).length;r<i;r++)n=o[r],$(n).hide();return t.fetchData(e.idx),$(t.containers[e.idx]).show(),t.trigger("calibrate")}),this.tabbar.set("items",[{iconclass:"fa fa-user-circle",selected:!0},{iconclass:"fa fa-info-circle"},{iconclass:"fa fa-book"}]),this.find("bt-user-save").set("onbtclick",function(e){return t.saveUser()}),this.find("cv-cat-add").set("onbtclick",function(e){return t.openDialog("BloggerCategoryDialog",function(e){var n;return n={name:e.value,pid:e.p.id,publish:1},t.cvcatdb.save(n,function(e){return e.error&&t.error("Cannot add new category"),t.refreshCVCat()})},"Add category",{tree:t.cvlist.get("data")})}),this.find("cv-cat-edit").set("onbtclick",function(e){var n;if(n=t.cvlist.get("selectedItem"))return t.openDialog("BloggerCategoryDialog",function(e){var r;return r={id:n.id,publish:n.publish,pid:e.p.id,name:e.value},t.cvcatdb.save(r,function(e){return e.error?t.error("Cannot Edit category"):t.refreshCVCat()})},"Edit category",{tree:t.cvlist.get("data"),cat:n})}),this.find("cv-cat-del").set("onbtclick",function(e){var n;if(n=t.cvlist.get("selectedItem"))return t.openDialog("YesNoDialog",function(e){if(e)return t.deleteCVCat(n)},"Delete cagegory",{iconclass:"fa fa-question-circle",text:"Do you really want to delete: "+n.name+" ?"})}),this.find("cv-sec-add").set("onbtclick",function(e){var n;return(n=t.cvlist.get("selectedItem"))&&0!==n.id?t.openDialog("BloggerCVSectionDiaglog",function(e){return e.cid=Number(n.id),e.start=Number(e.start),e.end=Number(e.end),e.publish=1,t.cvsecdb.save(e,function(e){return e.error?t.error("Cannot save section: "+e.error):t.CVSectionByCID(Number(n.id))})},"New section entry for "+n.name,null):t.notify("Please select a category")}),this.find("cv-sec-move").set("onbtclick",function(e){var n;return(n=t.find("cv-sec-list").get("selected"))?t.openDialog("BloggerCategoryDialog",function(e){var r;return r={id:n.id,cid:e.p.id},t.cvsecdb.save(r,function(e){return e.error?t.error("Cannot move section"):(t.CVSectionByCID(n.cid),t.find("cv-sec-list").set("selected",-1))})},"Move to",{tree:t.cvlist.get("data"),selonly:!0}):t.notify("Please select a section to move")}),this.find("cv-sec-edit").set("onbtclick",function(e){var n;return(n=t.find("cv-sec-list").get("selected"))?t.openDialog("BloggerCVSectionDiaglog",function(e){return e.cid=Number(n.cid),e.start=Number(e.start),e.end=Number(e.end),e.publish=Number(n.publish),t.cvsecdb.save(e,function(e){return e.error?t.error("Cannot save section: "+e.error):t.CVSectionByCID(Number(n.cid))})},"Modify section entry",n):t.notify("Please select a section to edit")}),this.editor=new SimpleMDE({element:t.find("markarea"),autofocus:!0,tabSize:4,indentWithTabs:!0,toolbar:[{name:"new",className:"fa fa-file",action:function(e){return t.bloglist.set("selected",-1),t.clearEditor()}},{name:"save",className:"fa fa-save",action:function(e){return t.saveBlog()}},"|","bold","italic","heading","|","quote","code","unordered-list","ordered-list","|","link","image","table","horizontal-rule",{name:"image",className:"fa fa-file-image-o",action:function(e){return t.openDialog("FileDiaLog",function(e,n,r){return r.asFileHandler().publish(function(e){return e.error?t.error("Cannot export file for embeding to text"):t.editor.codemirror.getDoc().replaceSelection("![]("+t._api.handler.shared+"/"+e.result+")")})},"Select image file",{mimes:["image/.*"]})}},{name:"Youtube",className:"fa fa-youtube",action:function(e){return t.editor.codemirror.getDoc().replaceSelection("[[youtube:]]")}},"|",{name:"preview",className:"fa fa-eye no-disable",action:function(e){return t.previewOn=!t.previewOn,SimpleMDE.togglePreview(e)}}]}),this.bloglist.set("onlistselect",function(e){var n;if(n=t.bloglist.get("selected"))return t.blogdb.get(Number(n.id),function(e){return e.error&&t.error("Cannot fetch the entry content"),t.editor.value(atob(e.result.content)),t.inputtags.value=e.result.tags,t.find("blog-publish").set("swon",!!Number(e.result.publish))})}),this.bloglist.set("onitemclose",function(e){return t.openDialog("YesNoDialog",function(n){if(n)return t.blogdb.delete(e.item.item.id,function(n){return n.error?t.error("Cannot delete: "+n.error):(t.bloglist.remove(e.item.item,!0),t.bloglist.set("selected",-1),t.clearEditor())})},"Delete a post",{iconclass:"fa fa-question-circle",text:"Do you really want to delete this post ?"}),!1}),this.bindKey("CTRL-S",function(){if(2===t.tabbar.get("selidx"))return t.saveBlog()}),this.on("vboxchange",function(){return t.resizeContent()})},n.prototype.fetchData=function(t){var e;switch(e=this,t){case 0:return this.userdb.get(null,function(t){var n,r,i,o,s;if(t.error)return e.error("Cannot fetch user data");for(e.user=t.result[0],o=[],n=0,i=(r=e.select("[input-class='user-input']")).length;n<i;n++)s=r[n],o.push($(s).val(e.user[s.name]));return o});case 1:return this.refreshCVCat();default:return this.loadBlogs()}},n.prototype.saveUser=function(){var t,e,n,r,i;for(r=this,t=0,n=(e=this.select("[input-class='user-input']")).length;t<n;t++)i=e[t],this.user[i.name]=$(i).val();return this.user.fullname&&""!==this.user.fullname?this.userdb.save(this.user,function(t){return t.error?r.error("Cannot save user data"):r.notify("User data updated")}):this.notify("Full name must be entered")},n.prototype.refreshCVCat=function(){var t,e,n;return n=this,e={name:"Porfolio",id:0,nodes:[]},t={order:{name:"ASC"}},this.cvcatdb.find(t,function(t){return t.error?(n.cvlist.set("data",e),n.notify("Cannot fetch CV categories")):(n.fetchCVCat(t.result,e,"0"),n.cvlist.set("data",e))})},n.prototype.fetchCVCat=function(t,e,n){var r,i,o,s,a;if(0===(o=function(){var e,r,i;for(i=[],e=0,r=t.length;e<r;e++)(a=t[e]).pid===n&&i.push(a);return i}()).length)return e.nodes=null;for(s=[],r=0,i=o.length;r<i;r++)(a=o[r]).nodes=[],this.fetchCVCat(t,a,a.id),s.push(e.nodes.push(a));return s},n.prototype.deleteCVCat=function(t){var e,n,r,i,o;return i=this,r=[],(n=function(t){var e,i,o,s,a;if(r.push(t.id),t.nodes){for(s=[],e=0,i=(o=t.nodes).length;e<i;e++)a=o[e],s.push(n(a));return s}})(t),e=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)o=r[t],n.push({"=":{cid:o}});return n}(),this.cvsecdb.delete({or:e},function(n){return n.error?i.error("Cannot delete all content of: "+t.name+" ["+n.error+"]"):(e=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)o=r[t],n.push({"=":{id:o}});return n}(),i.cvcatdb.delete({or:e},function(e){return e.error?i.error("Cannot delete the category: "+t.name+" ["+e.error+"]"):i.refreshCVCat()}))})},n.prototype.CVSectionByCID=function(t){var e,n;return n=this,e={exp:{"=":{cid:t}},order:{start:"DESC"}},this.cvsecdb.find(e,function(t){var e,r,i,o,s,a,c,l,u;if(t.error)return n.notify("Section list is empty, please add one");for(r=0,s=(c=t.result).length;r<s;r++)(u=c[r]).text=u.title;for(i=[],$(n.find("cv-sec-status")).html("Found "+t.result.length+" sections"),o=0,a=(l=t.result).length;o<a;o++)(u=l[o]).text=u.title,u.complex=!0,u.start=Number(u.start),u.end=Number(u.end),u.detail=[],""!==u.subtitle&&u.detail.push({text:u.subtitle,class:"cv-subtitle"}),0!==u.start&&0!==u.end?u.detail.push({text:u.start+" - "+u.end,class:"cv-period"}):u.detail.push({text:"",class:"cv-period"}),""!==u.location&&u.detail.push({text:u.location,class:"cv-loc"}),u.closable=!0,u.detail.push({text:u.content,class:"cv-content"}),i.push(u);return(e=n.find("cv-sec-list")).set("onitemclose",function(t){return n.openDialog("YesNoDialog",function(r){if(r)return n.cvsecdb.delete(t.item.item.id,function(r){return r.error?n.error("Cannot delete the section: "+r.error):e.remove(t.item.item,!0)})},"Delete section",{iconclass:"fa fa-question-circle",text:"Do you really want to delete: "+t.item.item.text+" ?"}),!1}),e.set("items",i)})},n.prototype.saveBlog=function(){var t,e,n,r,i,o,s;return r=this,i=this.bloglist.get("selected"),o=this.inputtags.value,t=this.editor.value(),(s=new RegExp("^#+(.*)\n","g").exec(t))&&2===s.length?""===o?this.notify("Please enter tags"):(e=new Date,n={content:t.asBase64(),title:s[1].trim(),tags:o,ctime:i?i.ctime:e.timestamp(),ctimestr:i?i.ctimestr:e.toString(),utime:e.timestamp(),utimestr:e.toString(),rendered:r.process(r.editor.options.previewRender(t)),publish:this.find("blog-publish").get("swon")?1:0},i&&(n.id=i.id),this.blogdb.save(n,function(t){return t.error?r.error("Cannot save blog: "+t.error):r.loadBlogs()})):this.notify("Please insert a title in the text: beginning with heading")},n.prototype.process=function(t){var e,n,r,i,o,s,a,c,l;for(n=function(t){return'<iframe\n    class = "embeded-video"\n    width="560" height="315" \n    src="https://www.youtube.com/embed/'+t+'"\n    frameborder="0" allow="encrypted-media" allowfullscreen\n></iframe>'},a=/\[\[([^:]*):([^\]]*)\]\]/g,c=[];null!==(r=a.exec(t));)c.push(r);if(!(c.length>0))return t.asBase64();for(l="",e=0,i=0,s=c.length;i<s;i++)o=c[i],l+=t.substring(e,o.index),l+=n(o[2]),e=o.index+o[0].length;return(l+=t.substring(e,t.length)).asBase64()},n.prototype.clearEditor=function(){return this.editor.value(""),this.inputtags.value="",this.find("blog-publish").set("swon",!1)},n.prototype.loadBlogs=function(){var t,e,n;return e=this,n=this.bloglist.get("selidx"),t={order:{ctime:"DESC"},fields:["id","title","ctimestr","ctime","utime","utimestr"]},this.blogdb.find(t,function(t){var r,i,o,s;if(t.error)return e.notify("No post found: "+t.error);for(console.log(t.result),r=0,i=(o=t.result).length;r<i;r++)(s=o[r]).text=s.title,s.complex=!0,s.closable=!0,s.detail=[{text:"Created: "+s.ctimestr,class:"blog-dates"},{text:"Updated: "+s.utimestr,class:"blog-dates"}];return e.bloglist.set("items",t.result),-1!==n?e.bloglist.set("selected",n):(e.clearEditor(),e.bloglist.set("selected",-1))})},n.prototype.resizeContent=function(){var t,e,n,r,i,o;return n=this.find("editor-container"),e=$(n).children(),i=$(this.scheme).find(".afx-window-top")[0],o=e[1],r=e[4],t=$(this.scheme).height()-$(i).height()-$(o).height()-$(r).height()-90,$(e[2]).css("height",t+"px")},n}(this.OS.GUI.BaseApplication)).singleton=!0,t.dependencies=["mde/simplemde.min"],this.OS.register("Blogger",t)}.call(this);